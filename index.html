<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö—Ä–∞—Å–∫–∏ –†–∞—Å—Å–≤–µ—Ç–∞ ‚Äî Music Hub</title>

  <style>
    :root{
      --s: 1.10;          /* –æ–±—â–∏–π –º–∞—Å—à—Ç–∞–± UI */
      --density: 1.00;    /* –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (–∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—å) */

      --bg:#070914;
      --panel: rgba(14,16,28,.86);
      --stroke: rgba(255,255,255,.07);
      --text:#f1f3ff;
      --muted:#a7abc8;

      --accent:#ffb347;
      --pink:#ff6fae;
      --sky:#6ecbff;

      --r: calc(16px * var(--s));
      --pad: calc(12px * var(--s));
      --gap: calc(12px * var(--s));
      --blur: 12px;

      --playerH: calc(104px * var(--s));

      --sunriseOn: 1;        /* 0/1 */
      --sunrisePower: .78;   /* 0..1 */

      --rainOn: 0;           /* 0/1 */
      --rainCount: 28;       /* 0..160 */
      --rainFront: 1;        /* 0/1 (–Ω–∞ –ø–µ—Ä–µ–¥–Ω–µ–º –ø–ª–∞–Ω–µ) */

      --bgPreset: 1;         /* 1..8 */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: var(--bg);
      overflow:hidden;
    }

    /* ===== BACKGROUND ===== */
    .bg{
      position:fixed; inset:0; z-index:0;
      background: var(--bg);
    }
    .bg::before{
      content:"";
      position:absolute; inset:0;
      background: var(--bg);
      filter:saturate(1.10) contrast(1.04);
    }

    /* 8 ‚Äú—Å–ª–∞–¥–∫–∏—Ö‚Äù –ø—Ä–µ—Å–µ—Ç–æ–≤ */
    body[data-bg="1"] .bg::before{
      background:
        radial-gradient(1100px 700px at 18% -10%, color-mix(in srgb, var(--accent) 42%, transparent), transparent 60%),
        radial-gradient(900px 620px at 92% 10%, color-mix(in srgb, var(--sky) 30%, transparent), transparent 62%),
        radial-gradient(820px 540px at 50% 92%, color-mix(in srgb, var(--pink) 24%, transparent), transparent 68%),
        linear-gradient(180deg, rgba(255,255,255,.02), transparent 35%),
        var(--bg);
    }
    body[data-bg="2"] .bg::before{
      background:
        radial-gradient(980px 640px at 25% 0%, rgba(255,179,71,.32), transparent 62%),
        radial-gradient(920px 540px at 80% 10%, rgba(255,111,174,.24), transparent 62%),
        radial-gradient(980px 640px at 50% 110%, rgba(110,203,255,.18), transparent 68%),
        radial-gradient(800px 520px at 40% 55%, rgba(255,255,255,.03), transparent 70%),
        var(--bg);
    }
    body[data-bg="3"] .bg::before{
      background:
        radial-gradient(980px 640px at 12% 0%, rgba(110,203,255,.28), transparent 62%),
        radial-gradient(980px 560px at 90% 10%, rgba(255,179,71,.22), transparent 62%),
        radial-gradient(980px 700px at 50% 115%, rgba(255,111,174,.18), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.02), transparent 45%),
        var(--bg);
    }
    body[data-bg="4"] .bg::before{
      background:
        radial-gradient(1100px 700px at 30% -10%, rgba(255,111,174,.30), transparent 62%),
        radial-gradient(1000px 620px at 75% 10%, rgba(110,203,255,.20), transparent 64%),
        radial-gradient(980px 720px at 50% 120%, rgba(255,179,71,.20), transparent 68%),
        radial-gradient(900px 600px at 20% 60%, rgba(255,255,255,.03), transparent 72%),
        var(--bg);
    }
    body[data-bg="5"] .bg::before{
      background:
        radial-gradient(1100px 720px at 20% -5%, rgba(255,179,71,.26), transparent 64%),
        radial-gradient(900px 580px at 85% 8%, rgba(255,111,174,.20), transparent 64%),
        radial-gradient(880px 520px at 55% 95%, rgba(110,203,255,.20), transparent 70%),
        radial-gradient(680px 420px at 40% 40%, rgba(255,255,255,.03), transparent 72%),
        var(--bg);
    }
    body[data-bg="6"] .bg::before{
      background:
        radial-gradient(1100px 720px at 20% 0%, rgba(255,111,174,.22), transparent 64%),
        radial-gradient(960px 620px at 85% 10%, rgba(110,203,255,.22), transparent 66%),
        radial-gradient(1000px 760px at 50% 120%, rgba(255,179,71,.18), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.02), transparent 55%),
        var(--bg);
    }
    body[data-bg="7"] .bg::before{
      background:
        radial-gradient(1200px 760px at 12% 8%, rgba(110,203,255,.20), transparent 64%),
        radial-gradient(1000px 660px at 88% 8%, rgba(255,179,71,.20), transparent 66%),
        radial-gradient(980px 760px at 50% 120%, rgba(255,111,174,.18), transparent 72%),
        radial-gradient(780px 520px at 48% 48%, rgba(255,255,255,.03), transparent 74%),
        var(--bg);
    }
    body[data-bg="8"] .bg::before{
      background:
        radial-gradient(1200px 760px at 30% -10%, rgba(255,179,71,.24), transparent 64%),
        radial-gradient(1100px 700px at 70% 0%, rgba(255,111,174,.22), transparent 66%),
        radial-gradient(1100px 820px at 55% 120%, rgba(110,203,255,.18), transparent 72%),
        radial-gradient(880px 560px at 20% 65%, rgba(255,255,255,.03), transparent 74%),
        var(--bg);
    }

    /* ===== SUNRISE OVERLAY ===== */
    .sunrise{
      position:fixed; inset:-18%;
      z-index:1;
      pointer-events:none;
      opacity: calc(var(--sunriseOn) * var(--sunrisePower));
      background:
        radial-gradient(900px 420px at 26% 10%, color-mix(in srgb, var(--accent) 44%, transparent), transparent 62%),
        radial-gradient(780px 380px at 72% 18%, color-mix(in srgb, var(--pink) 36%, transparent), transparent 66%),
        radial-gradient(900px 560px at 50% 100%, color-mix(in srgb, var(--sky) 28%, transparent), transparent 72%);
      animation: sunriseMove 18s ease-in-out infinite;
      filter: blur(.6px);
      transform-origin:50% 50%;
    }
    @keyframes sunriseMove{
      0%   { transform: translate3d(-1.4%, -1.0%, 0) scale(1.02); }
      50%  { transform: translate3d( 1.6%,  1.2%, 0) scale(1.05); }
      100% { transform: translate3d(-1.4%, -1.0%, 0) scale(1.02); }
    }

    /* ===== RAIN (DROPLETS ON SCREEN) ===== */
    .rain{
      position:fixed; inset:0;
      z-index: 2;
      pointer-events:none;
      opacity: calc(.95 * var(--rainOn));
      overflow:hidden;
    }
    /* –Ω–∞ –ø–µ—Ä–µ–¥–Ω–µ–º –ø–ª–∞–Ω–µ */
    body[data-rainfront="1"] .rain { z-index: 50; }

    .droplet{
      position:absolute;
      top:-12vh;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 28% 28%, rgba(255,255,255,.62), rgba(255,255,255,.10) 42%, rgba(255,255,255,.02) 65%, transparent 72%),
        radial-gradient(circle at 70% 80%, rgba(140,220,255,.18), transparent 70%);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05),
        0 16px 40px rgba(0,0,0,.22);
      filter: blur(.2px);
      transform: translateZ(0);
      animation: dropFall linear infinite;
    }
    .droplet::after{
      content:"";
      position:absolute;
      left:50%;
      top:-18px;
      width:2px;
      height:20px;
      transform: translateX(-50%);
      background: linear-gradient(to bottom, transparent, rgba(200,240,255,.22), transparent);
      border-radius:999px;
      opacity:.65;
    }
    @keyframes dropFall{
      to { transform: translateY(140vh) translateZ(0); }
    }

    /* ===== APP ===== */
    .app{
      position:relative;
      z-index:3;
      height:100%;
      display:grid;
      grid-template-columns: calc(270px * var(--s) * var(--density)) 1fr;
      grid-template-rows: 1fr var(--playerH);
      gap: var(--gap);
      padding: var(--pad);
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: 0 18px 56px rgba(0,0,0,.58);
      overflow:hidden;
    }

    /* ===== SIDEBAR ===== */
    .sidebar{
      padding: calc(14px * var(--s) * var(--density));
      display:flex;
      flex-direction:column;
      gap: calc(14px * var(--s) * var(--density));
    }
    .logo{
      font-weight: 950;
      font-size: calc(18px * var(--s));
      letter-spacing:.2px;
      background: linear-gradient(90deg, var(--accent), var(--pink));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      user-select:none;
    }
    .nav{
      display:flex;
      flex-direction:column;
      gap: calc(10px * var(--s) * var(--density));
    }
    .nav button{
      width:100%;
      border:none;
      background: transparent;
      color: var(--text);
      padding: calc(12px * var(--s) * var(--density)) calc(12px * var(--s) * var(--density));
      border-radius: calc(12px * var(--s));
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border: 1px solid transparent;
      font-weight: 850;
      font-size: calc(13px * var(--s));
    }
    .nav button:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.05);
    }
    .nav button.active{
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 24%, transparent), color-mix(in srgb, var(--pink) 14%, transparent));
      border-color: color-mix(in srgb, var(--accent) 34%, transparent);
    }
    .k{
      font-size: calc(11px * var(--s));
      color: rgba(255,255,255,.68);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      padding: 3px 8px;
      border-radius: 999px;
      flex:0 0 auto;
    }
    .hint{
      margin-top:auto;
      padding: calc(10px * var(--s) * var(--density));
      border-radius: calc(12px * var(--s));
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.72);
      font-weight: 650;
      font-size: calc(11px * var(--s));
      line-height: 1.35;
    }

    /* ===== MAIN ===== */
    .main{ display:flex; flex-direction:column; }
    .topbar{
      padding: calc(12px * var(--s) * var(--density));
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex;
      gap: calc(10px * var(--s) * var(--density));
      align-items:center;
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: calc(10px * var(--s) * var(--density)) calc(12px * var(--s) * var(--density));
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 999px;
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: calc(13px * var(--s));
      font-weight: 750;
    }
    .chip{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.90);
      border-radius: 999px;
      padding: calc(9px * var(--s) * var(--density)) calc(12px * var(--s) * var(--density));
      font-weight: 900;
      font-size: calc(12px * var(--s));
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{ background: rgba(255,255,255,.07); }

    .content{
      padding: calc(14px * var(--s) * var(--density));
      overflow:auto;
    }
    .hero{
      padding: calc(18px * var(--s) * var(--density));
      border-radius: calc(18px * var(--s));
      border: 1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(760px 300px at 24% 0%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 62%),
        radial-gradient(680px 300px at 78% 0%, color-mix(in srgb, var(--sky) 18%, transparent), transparent 66%),
        rgba(255,255,255,.03);
    }
    .hero h1{ margin:0; font-size: calc(22px * var(--s)); letter-spacing:.2px; }
    .hero p{ margin: 6px 0 0; color: rgba(255,255,255,.72); font-weight: 650; font-size: calc(12px * var(--s)); }

    .box{
      margin-top: calc(14px * var(--s));
      padding: calc(12px * var(--s));
      border-radius: calc(16px * var(--s));
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .box h3{ margin:0 0 10px 0; font-size: calc(14px * var(--s)); font-weight: 950; }
    .note{ margin-top: 8px; color: rgba(255,255,255,.65); font-size: calc(11px * var(--s)); line-height: 1.35; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      gap: calc(12px * var(--s) * var(--density));
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: calc(10px * var(--s) * var(--density));
      min-width:0;
    }

    .item{
      padding: calc(10px * var(--s) * var(--density));
      border-radius: calc(14px * var(--s));
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      cursor:pointer;
      user-select:none;
    }
    .item:hover{ background: rgba(255,255,255,.06); }
    .item.active{
      border-color: color-mix(in srgb, var(--accent) 36%, transparent);
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 16%, transparent), rgba(255,255,255,.05));
    }
    .item .t{ font-weight: 950; font-size: calc(13px * var(--s)); margin-bottom: 4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item .d{ color: rgba(255,255,255,.70); font-weight: 650; font-size: calc(11px * var(--s)); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .stage{
      border-radius: calc(14px * var(--s));
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      min-height: calc(240px * var(--s));
    }
    .stage iframe{
      width:100%;
      height: calc(260px * var(--s));
      border:0;
      display:block;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn2{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .btn2:hover{ background: rgba(255,255,255,.08); }
    .btn2.primary{
      background: var(--accent);
      border-color: color-mix(in srgb, var(--accent) 40%, transparent);
      color:#151515;
    }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .toggle i{
      width: 38px;
      height: 22px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(0,0,0,.35);
      position: relative;
    }
    .toggle i::after{
      content:"";
      position:absolute;
      top:50%;
      left: 3px;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      transform: translateY(-50%);
      background: rgba(255,255,255,.82);
      transition: .12s ease;
    }
    .toggle.on{
      border-color: color-mix(in srgb, var(--accent) 36%, transparent);
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 16%, transparent), rgba(255,255,255,.06));
    }
    .toggle.on i{ background: color-mix(in srgb, var(--accent) 28%, rgba(255,255,255,.10)); }
    .toggle.on i::after{ left: 19px; }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* ===== PLAYER ===== */
    .player{
      grid-column: 1 / span 2;
      grid-row:2;
      padding: calc(12px * var(--s) * var(--density)) calc(14px * var(--s) * var(--density));
      display:grid;
      grid-template-columns: 1.35fr 1fr 1fr;
      align-items:center;
      gap: calc(12px * var(--s) * var(--density));
    }
    .now{
      display:flex;
      align-items:center;
      gap: calc(10px * var(--s));
      min-width:0;
    }
    .art{
      width: calc(54px * var(--s));
      height: calc(54px * var(--s));
      border-radius: calc(14px * var(--s));
      background: linear-gradient(135deg, rgba(255,255,255,.08), color-mix(in srgb, var(--accent) 22%, transparent));
      border: 1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .meta{ min-width:0; }
    .track{ font-weight: 950; font-size: calc(13px * var(--s)); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .artist{ margin-top: 4px; font-weight: 700; font-size: calc(11px * var(--s)); color: rgba(255,255,255,.68); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .ctrls{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: calc(10px * var(--s));
    }
    .btn{
      width: calc(40px * var(--s));
      height: calc(40px * var(--s));
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight: 900;
      user-select:none;
    }
    .btn.play{
      width: calc(44px * var(--s));
      height: calc(44px * var(--s));
      background: var(--accent);
      border-color: color-mix(in srgb, var(--accent) 38%, transparent);
      color:#151515;
    }
    .right{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
      color: rgba(255,255,255,.70);
      font-weight: 800;
      font-size: 12px;
    }

    audio{ width: 100%; max-width: 320px; }

    .content::-webkit-scrollbar{ width: 10px; }
    .content::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }

    @media (max-width: 980px){
      body{ overflow:auto; }
      .app{ grid-template-columns: 1fr; grid-template-rows: auto 1fr var(--playerH); }
      .player{ grid-template-columns: 1fr; }
      .right{ justify-content:center; }
      .grid2{ grid-template-columns: 1fr; }
      .split{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body data-bg="1" data-rainfront="1">
  <div class="bg"></div>
  <div class="sunrise"></div>
  <div class="rain" id="rain"></div>

  <div class="app">
    <aside class="panel sidebar">
      <div class="logo">–ö—Ä–∞—Å–∫–∏ –†–∞—Å—Å–≤–µ—Ç–∞</div>
      <div class="nav" id="nav">
        <button class="active" data-page="home">üè† –ì–ª–∞–≤–Ω–∞—è <span class="k">1</span></button>
        <button data-page="music">üéß –ú—É–∑—ã–∫–∞ <span class="k">2</span></button>
        <button data-page="playlists">üìÅ –ü–∞–ø–∫–∏/–ü–ª–µ–π–ª–∏—Å—Ç—ã <span class="k">3</span></button>
        <button data-page="library">‚≠ê –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ <span class="k">4</span></button>
        <button data-page="settings">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ <span class="k">5</span></button>
      </div>
      <div class="hint">
        1‚Äì5 –≤–∫–ª–∞–¥–∫–∏ (–µ—Å–ª–∏ –ø–µ—á–∞—Ç–∞–µ—à—å: Alt+1..5)<br/>
        –û–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫: Local (—Ç–≤–æ–∏ —Ñ–∞–π–ª—ã) –∏–ª–∏ Embed
      </div>
    </aside>

    <main class="panel main">
      <div class="topbar">
        <div class="search">
          <span>üîç</span>
          <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ (–¥–µ–º–æ)" autocomplete="off" />
        </div>
        <div class="chip" id="goSettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      </div>

      <div class="content">
        <!-- HOME -->
        <section id="page-home">
          <div class="hero">
            <h1>–î–æ–º–∞—à–Ω—è—è</h1>
            <p>–ó–¥–µ—Å—å –º—ã –¥–µ—Ä–∂–∏–º ‚Äú—Ä–µ–ª–∏–∑–Ω—É—é‚Äù –æ—Å–Ω–æ–≤—É: —Å–≤–æ–π –ø–ª–µ–µ—Ä + –≤—Å—Ç—Ä–æ–π–∫–∏ + —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤.</p>
          </div>

          <div class="box">
            <h3>–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h3>
            <div class="row">
              <button class="btn2 primary" id="btnAddFiles">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ —Ç—Ä–µ–∫–∏</button>
              <button class="btn2" id="btnOpenMusic">–û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É –ú—É–∑—ã–∫–∞</button>
              <button class="btn2" id="btnOpenPlaylists">–û—Ç–∫—Ä—ã—Ç—å –ü–∞–ø–∫–∏/–ü–ª–µ–π–ª–∏—Å—Ç—ã</button>
            </div>
            <div class="note">
              ‚Äú–°–≤–æ–∏ —Ç—Ä–µ–∫–∏‚Äù —Å–µ–π—á–∞—Å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ (IndexedDB). –î–ª—è –æ–±—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –≤—Å–µ–º –Ω—É–∂–µ–Ω Firebase.
            </div>
          </div>
        </section>

        <!-- MUSIC -->
        <section id="page-music" style="display:none">
          <div class="hero">
            <h1>–ú—É–∑—ã–∫–∞</h1>
            <p>–°–ª–µ–≤–∞ ‚Äî —Å–ø–∏—Å–æ–∫. –°–Ω–∏–∑—É ‚Äî –ø–ª–µ–µ—Ä –∏ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫. –ò—Å—Ç–æ—á–Ω–∏–∫ –æ–¥–∏–Ω: Local –∏–ª–∏ Embed.</p>
          </div>

          <div class="box">
            <h3>–ú–æ–∏ —Ç—Ä–µ–∫–∏ (Local)</h3>
            <div class="row">
              <input id="fileInput" type="file" accept="audio/*" multiple style="display:none"/>
              <button class="btn2 primary" id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</button>
              <button class="btn2" id="clearLocalBtn">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–æ–∏ —Ç—Ä–µ–∫–∏</button>
            </div>
            <div class="note" id="localInfo">–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–µ–∫–æ–≤.</div>
          </div>

          <div class="box">
            <h3>–í—Å—Ç—Ä–æ–π–∫–∏ (Embed)</h3>
            <div class="grid2">
              <div class="list" id="embedList"></div>
              <div class="stage" id="embedStage"></div>
            </div>
            <div class="note">
              Embed –¥–∞—ë—Ç ‚Äú–º–Ω–æ–≥–æ –º—É–∑—ã–∫–∏‚Äù —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫–∏ (Spotify/YouTube/SoundCloud). –≠—Ç–æ –ª–µ–≥–∞–ª—å–Ω—ã–π –∏ —Ä–∞–±–æ—á–∏–π —Å—Ç–∞—Ä—Ç. –ü—Ä—è–º–æ–π ‚Äú–ø–æ—Ç–æ–∫‚Äù –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤ –æ–±—ã—á–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
            </div>
          </div>

          <div class="box">
            <h3>–ú–æ–∏ —Ç—Ä–µ–∫–∏ ‚Äî —Å–ø–∏—Å–æ–∫</h3>
            <div class="list" id="localList"></div>
          </div>
        </section>

        <!-- PLAYLISTS -->
        <section id="page-playlists" style="display:none">
          <div class="hero">
            <h1>–ü–∞–ø–∫–∏ –∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã</h1>
            <p>–≠—Ç–æ –ª–æ–∫–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ). –ü–æ–∑–∂–µ –ø–µ—Ä–µ–Ω–µ—Å—ë–º –≤ Firebase.</p>
          </div>

          <div class="box">
            <h3>–°–æ–∑–¥–∞–Ω–∏–µ</h3>
            <div class="split">
              <div>
                <div class="row">
                  <input id="folderName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏" style="flex:1;border:none;outline:none;background:rgba(255,255,255,.06);color:var(--text);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:800;">
                  <button class="btn2 primary" id="createFolderBtn">–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
                </div>
                <div class="note">–ü–∞–ø–∫–∞ = –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤.</div>
              </div>
              <div>
                <div class="row">
                  <input id="playlistName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞" style="flex:1;border:none;outline:none;background:rgba(255,255,255,.06);color:var(--text);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:800;">
                  <button class="btn2" id="createPlaylistBtn">–°–æ–∑–¥–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ</button>
                </div>
                <div class="note">–í—ã–±–µ—Ä–∏ –ø–∞–ø–∫—É –Ω–∏–∂–µ, –ø–æ—Ç–æ–º —Å–æ–∑–¥–∞–≤–∞–π –ø–ª–µ–π–ª–∏—Å—Ç.</div>
              </div>
            </div>
          </div>

          <div class="box">
            <h3>–°—Ç—Ä—É–∫—Ç—É—Ä–∞</h3>
            <div class="grid2">
              <div class="list" id="foldersList"></div>
              <div class="list" id="playlistsList"></div>
            </div>

            <div class="note">
              –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –≤ –ø–ª–µ–π–ª–∏—Å—Ç: –æ—Ç–∫—Ä–æ–π –ú—É–∑—ã–∫–∞ ‚Üí –≤ —Å–ø–∏—Å–∫–µ Local —Ç—Ä–µ–∫–∞ –Ω–∞–∂–º–∏ ‚ÄúÔºã –≤ –ø–ª–µ–π–ª–∏—Å—Ç‚Äù.
            </div>
          </div>

          <div class="box">
            <h3>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞</h3>
            <div class="list" id="playlistTracks"></div>
          </div>
        </section>

        <!-- LIBRARY -->
        <section id="page-library" style="display:none">
          <div class="hero">
            <h1>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
            <p>–ü–æ–∫–∞ –¥–µ–º–æ. –ü–æ—Ç–æ–º: –ª–∞–π–∫–∏, –∏—Å—Ç–æ—Ä–∏—è, –Ω–µ–¥–∞–≤–Ω–æ —Å–ª—É—à–∞–ª.</p>
          </div>
        </section>

        <!-- SETTINGS -->
        <section id="page-settings" style="display:none">
          <div class="hero">
            <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
            <p>–ö–Ω–æ–ø–∫–∏-—Ç—É–º–±–ª–µ—Ä—ã, –ø–æ–±–æ–ª—å—à–µ –ø—Ä–µ—Å–µ—Ç–æ–≤, –¥–æ–∂–¥—å –ø–æ–≤–µ—Ä—Ö —ç–∫—Ä–∞–Ω–∞.</p>
          </div>

          <div class="box">
            <h3>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
            <div class="row" style="margin-top:8px;">
              <span style="font-weight:900;">–ú–∞—Å—à—Ç–∞–± UI</span>
              <input id="uiScale" type="range" min="0.80" max="1.95" step="0.01" value="1.10" style="width:56%;">
            </div>
            <div class="row">
              <span style="font-weight:900;">–ü–ª–æ—Ç–Ω–æ—Å—Ç—å</span>
              <input id="density" type="range" min="0.85" max="1.15" step="0.01" value="1.00" style="width:56%;">
            </div>
            <div class="row">
              <span style="font-weight:900;">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç</span>
              <input id="accent" type="color" value="#ffb347" style="width:46px;height:34px;border:none;background:transparent;">
            </div>
          </div>

          <div class="box">
            <h3>–§–æ–Ω –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã</h3>
            <div class="row" style="margin-top:8px;">
              <span style="font-weight:900;">–ü—Ä–µ—Å–µ—Ç —Ñ–æ–Ω–∞</span>
              <input id="bgPreset" type="range" min="1" max="8" step="1" value="1" style="width:56%;">
            </div>

            <div class="row" style="margin-top:10px;">
              <div class="toggle" id="tglSunrise"><span>–†–∞—Å—Å–≤–µ—Ç</span><i></i></div>
              <div class="toggle" id="tglRain"><span>–î–æ–∂–¥—å</span><i></i></div>
              <div class="toggle on" id="tglRainFront"><span>–î–æ–∂–¥—å –ø–æ–≤–µ—Ä—Ö</span><i></i></div>
            </div>

            <div class="row">
              <span style="font-weight:900;">–°–∏–ª–∞ —Ä–∞—Å—Å–≤–µ—Ç–∞</span>
              <input id="sunrisePower" type="range" min="0" max="1" step="0.01" value="0.78" style="width:56%;">
            </div>

            <div class="row">
              <span style="font-weight:900;">–ö–æ–ª-–≤–æ –∫–∞–ø–µ–ª—å</span>
              <input id="rainCount" type="range" min="0" max="160" step="1" value="28" style="width:56%;">
            </div>

            <div class="note">
              ‚Äú–î–æ–∂–¥—å –ø–æ–≤–µ—Ä—Ö‚Äù ‚Äî —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–∞ —ç–∫—Ä–∞–Ω: z-index –≤—ã—à–µ –≤—Å–µ–≥–æ.
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- PLAYER -->
    <footer class="panel player">
      <div class="now">
        <div class="art"></div>
        <div class="meta">
          <div class="track" id="trackName">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞</div>
          <div class="artist" id="artistName">–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ –≤ –ú—É–∑—ã–∫–∞</div>
        </div>
      </div>

      <div class="ctrls">
        <button class="btn" id="prevBtn" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π">‚èÆ</button>
        <button class="btn play" id="playBtn" title="Play/Pause">‚ñ∂</button>
        <button class="btn" id="nextBtn" title="–°–ª–µ–¥—É—é—â–∏–π">‚è≠</button>
        <button class="btn" id="stopBtn" title="–°—Ç–æ–ø">‚èπ</button>
      </div>

      <div class="right">
        <span id="sourceBadge">Source: ‚Äî</span>
        <div style="width:min(320px,100%);">
          <audio id="audio" controls style="display:none;"></audio>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const root = document.documentElement;

    // ---------- Utils ----------
    function esc(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function loadLS(key, fallback){
      const v = localStorage.getItem(key);
      return (v === null || v === undefined) ? fallback : v;
    }
    function saveLS(key, v){ localStorage.setItem(key, String(v)); }

    // ---------- Pages ----------
    const pages = ["home","music","playlists","library","settings"];
    function setActiveNav(name){
      document.querySelectorAll("#nav button").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.page === name);
      });
    }
    function openPage(name){
      pages.forEach(p=>{
        const el = document.getElementById("page-"+p);
        if(el) el.style.display = (p === name) ? "block" : "none";
      });
      setActiveNav(name);
      if(name === "music") renderAll();
    }
    document.querySelectorAll("#nav button").forEach(btn=>{
      btn.addEventListener("click", () => openPage(btn.dataset.page));
    });
    $("#goSettings").addEventListener("click", () => openPage("settings"));
    document.addEventListener("keydown", (e) => {
      const tag = (document.activeElement?.tagName || "").toLowerCase();
      const typing = tag === "input" || tag === "textarea" || document.activeElement?.isContentEditable;
      if(typing && !e.altKey) return;
      if(e.key === "1") openPage("home");
      if(e.key === "2") openPage("music");
      if(e.key === "3") openPage("playlists");
      if(e.key === "4") openPage("library");
      if(e.key === "5") openPage("settings");
    });

    $("#btnOpenMusic").addEventListener("click", () => openPage("music"));
    $("#btnOpenPlaylists").addEventListener("click", () => openPage("playlists"));

    // ---------- Sources: one active ----------
    const SOURCE = { NONE:"‚Äî", LOCAL:"Local", EMBED:"Embed" };
    let activeSource = SOURCE.NONE;

    const embedStage = $("#embedStage");
    const audio = $("#audio");

    function setBadge(source){
      activeSource = source;
      $("#sourceBadge").textContent = "Source: " + source;
    }

    function stopEmbed(){
      embedStage.innerHTML = "";
      // –≤–∏–∑—É–∞–ª—å–Ω–æ: —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º –æ—Ç–¥–µ–ª—å–Ω–æ
    }

    function stopLocalAudio(){
      audio.pause();
      audio.removeAttribute("src");
      audio.load();
      audio.style.display = "none";
    }

    function stopAll(){
      stopEmbed();
      stopLocalAudio();
      setBadge(SOURCE.NONE);
      $("#trackName").textContent = "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ";
      $("#artistName").textContent = "–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ –≤ –ú—É–∑—ã–∫–∞";
      markActiveLists();
    }

    // ---------- EMBEDS ----------
    const embedItems = [
      { title:"Daft Punk ‚Äî Harder Better Faster Stronger", source:"Spotify Embed", url:"https://open.spotify.com/embed/track/5W3cjX2J3tjhG8zb6u0qHn" },
      { title:"Radiohead ‚Äî Creep", source:"Spotify Embed", url:"https://open.spotify.com/embed/track/70LcF31zb1H0PyJoS1Sx1r" },
      { title:"Never Gonna Give You Up", source:"YouTube Embed", url:"https://www.youtube.com/embed/dQw4w9WgXcQ" },
      { title:"Coldplay ‚Äî Viva La Vida", source:"YouTube Embed", url:"https://www.youtube.com/embed/dvgZkm1xWPE" },
    ];
    let activeEmbed = -1;

    function renderEmbeds(){
      const list = $("#embedList");
      list.innerHTML = "";
      embedItems.forEach((it, idx) => {
        const el = document.createElement("div");
        el.className = "item" + (activeSource===SOURCE.EMBED && idx===activeEmbed ? " active" : "");
        el.innerHTML = `<div class="t">${esc(it.title)}</div><div class="d">${esc(it.source)}</div>`;
        el.addEventListener("click", () => playEmbed(idx));
        list.appendChild(el);
      });
    }

    function playEmbed(idx){
      if(idx < 0 || idx >= embedItems.length) return;

      // —Å—Ç–æ–ø–∞–µ–º local
      stopLocalAudio();

      // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ —Å—Ç–∞—Ä—ã–π embed —É–º–µ—Ä
      embedStage.innerHTML = "";

      const it = embedItems[idx];
      const iframe = document.createElement("iframe");
      iframe.allow = "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
      iframe.loading = "lazy";
      iframe.src = it.url;
      embedStage.appendChild(iframe);

      activeEmbed = idx;
      setBadge(SOURCE.EMBED);

      $("#trackName").textContent = it.title;
      $("#artistName").textContent = it.source;

      markActiveLists();
      renderEmbeds();
    }

    // ---------- Local tracks: IndexedDB ----------
    const DB_NAME = "krs_music_db";
    const DB_VER = 1;
    const STORE = "tracks";

    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = () => {
          const db = req.result;
          if(!db.objectStoreNames.contains(STORE)){
            db.createObjectStore(STORE, { keyPath:"id" });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function dbPut(track){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).put(track);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { const e = tx.error; db.close(); reject(e); };
      });
    }

    async function dbGetAll(){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const req = tx.objectStore(STORE).getAll();
        req.onsuccess = () => { const r=req.result||[]; db.close(); resolve(r); };
        req.onerror = () => { const e=req.error; db.close(); reject(e); };
      });
    }

    async function dbDeleteAll(){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).clear();
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { const e = tx.error; db.close(); reject(e); };
      });
    }

    let localTracks = [];
    let activeLocalId = null;

    function fmtBytes(bytes){
      const u = ["B","KB","MB","GB"];
      let i=0, n=bytes;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return (i===0? n : n.toFixed(1)) + " " + u[i];
    }

    async function loadLocalTracks(){
      localTracks = (await dbGetAll()).sort((a,b) => (a.createdAt||0)-(b.createdAt||0));
      $("#localInfo").textContent = localTracks.length
        ? `–¢—Ä–µ–∫–æ–≤: ${localTracks.length}. –•—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.`
        : "–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–µ–∫–æ–≤.";
    }

    function renderLocalList(){
      const list = $("#localList");
      list.innerHTML = "";
      localTracks.forEach(t => {
        const el = document.createElement("div");
        const isActive = (activeSource===SOURCE.LOCAL && t.id===activeLocalId);
        el.className = "item" + (isActive ? " active" : "");
        el.innerHTML = `
          <div class="t">${esc(t.title)}</div>
          <div class="d">Local ‚Ä¢ ${esc(t.type)} ‚Ä¢ ${fmtBytes(t.size)}</div>
          <div class="row" style="margin-top:10px;">
            <button class="btn2 primary" data-act="play">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn2" data-act="add">Ôºã –≤ –ø–ª–µ–π–ª–∏—Å—Ç</button>
          </div>
        `;
        el.querySelector('[data-act="play"]').addEventListener("click", (e) => {
          e.stopPropagation();
          playLocal(t.id);
        });
        el.querySelector('[data-act="add"]').addEventListener("click", (e) => {
          e.stopPropagation();
          addTrackToSelectedPlaylist(t.id);
        });
        el.addEventListener("click", ()=> playLocal(t.id));
        list.appendChild(el);
      });
    }

    function markActiveLists(){
      // –ø–æ–¥—Å–≤–µ—Ç–∫—É –¥–µ–ª–∞–µ–º —á–µ—Ä–µ–∑ renderEmbeds/renderLocalList, —Ç—É—Ç –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º
    }

    async function playLocal(id){
      const t = localTracks.find(x => x.id===id);
      if(!t) return;

      // —Å—Ç–æ–ø–∞–µ–º embed
      stopEmbed();
      activeEmbed = -1;
      renderEmbeds();

      // –≤–∫–ª—é—á–∞–µ–º local audio
      const url = URL.createObjectURL(t.blob);
      stopLocalAudio(); // —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –Ω–∞–ª–æ–∂–µ–Ω–∏–π
      audio.src = url;
      audio.style.display = "block";
      audio.play().catch(()=>{});

      activeLocalId = id;
      setBadge(SOURCE.LOCAL);

      $("#trackName").textContent = t.title;
      $("#artistName").textContent = "Local file";

      renderLocalList();
    }

    // ---------- Upload ----------
    const fileInput = $("#fileInput");
    $("#uploadBtn").addEventListener("click", ()=> fileInput.click());
    $("#btnAddFiles").addEventListener("click", ()=> { openPage("music"); fileInput.click(); });

    fileInput.addEventListener("change", async () => {
      const files = Array.from(fileInput.files || []);
      if(!files.length) return;

      for(const f of files){
        const blob = f; // File is a Blob
        const id = "t_" + crypto.randomUUID();
        const title = f.name.replace(/\.[^/.]+$/, "");
        const track = {
          id,
          title,
          type: f.type || "audio/*",
          size: f.size || 0,
          createdAt: Date.now(),
          blob
        };
        await dbPut(track);
      }

      fileInput.value = "";
      await loadLocalTracks();
      renderLocalList();
      renderAll();
    });

    $("#clearLocalBtn").addEventListener("click", async () => {
      stopAll();
      await dbDeleteAll();
      await loadLocalTracks();
      renderLocalList();
      renderAll();
    });

    // ---------- Playlists / folders (localStorage) ----------
    // —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
    // krs_tree = { folders:[ {id,name, playlists:[{id,name, trackIds:[]}] } ] }
    const TREE_KEY = "krs_tree";
    function defaultTree(){
      return {
        folders: [
          { id:"f_default", name:"–ú–æ–∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã", playlists: [
            { id:"p_fav", name:"–ò–∑–±—Ä–∞–Ω–Ω–æ–µ", trackIds: [] }
          ] }
        ],
        selectedFolderId: "f_default",
        selectedPlaylistId: "p_fav"
      };
    }
    function loadTree(){
      try{
        const raw = localStorage.getItem(TREE_KEY);
        if(!raw) return defaultTree();
        const t = JSON.parse(raw);
        if(!t.folders?.length) return defaultTree();
        return t;
      }catch{
        return defaultTree();
      }
    }
    function saveTree(t){
      localStorage.setItem(TREE_KEY, JSON.stringify(t));
    }

    let tree = loadTree();

    function findFolder(id){
      return tree.folders.find(f => f.id===id) || null;
    }
    function findPlaylist(pid){
      for(const f of tree.folders){
        const p = f.playlists.find(x => x.id===pid);
        if(p) return { folder:f, playlist:p };
      }
      return null;
    }

    function renderFolders(){
      const list = $("#foldersList");
      list.innerHTML = "";
      tree.folders.forEach(f=>{
        const el = document.createElement("div");
        const active = (f.id === tree.selectedFolderId);
        el.className = "item" + (active ? " active" : "");
        el.innerHTML = `<div class="t">${esc(f.name)}</div><div class="d">–ü–∞–ø–∫–∞</div>`;
        el.addEventListener("click", ()=>{
          tree.selectedFolderId = f.id;
          // –µ—Å–ª–∏ –≤ –ø–∞–ø–∫–µ –µ—Å—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π
          const first = f.playlists[0];
          if(first) tree.selectedPlaylistId = first.id;
          saveTree(tree);
          renderPlaylists();
          renderFolders();
          renderPlaylistTracks();
        });
        list.appendChild(el);
      });
    }

    function renderPlaylists(){
      const list = $("#playlistsList");
      list.innerHTML = "";
      const folder = findFolder(tree.selectedFolderId);
      if(!folder){
        list.innerHTML = `<div class="note">–ù–µ—Ç –ø–∞–ø–∫–∏</div>`;
        return;
      }
      folder.playlists.forEach(p=>{
        const el = document.createElement("div");
        const active = (p.id === tree.selectedPlaylistId);
        el.className = "item" + (active ? " active" : "");
        el.innerHTML = `<div class="t">${esc(p.name)}</div><div class="d">–¢—Ä–µ–∫–æ–≤: ${p.trackIds.length}</div>`;
        el.addEventListener("click", ()=>{
          tree.selectedPlaylistId = p.id;
          saveTree(tree);
          renderPlaylists();
          renderPlaylistTracks();
        });
        list.appendChild(el);
      });
    }

    function renderPlaylistTracks(){
      const box = $("#playlistTracks");
      box.innerHTML = "";

      const found = findPlaylist(tree.selectedPlaylistId);
      if(!found){
        box.innerHTML = `<div class="note">–í—ã–±–µ—Ä–∏ –ø–ª–µ–π–ª–∏—Å—Ç</div>`;
        return;
      }
      const p = found.playlist;
      if(!p.trackIds.length){
        box.innerHTML = `<div class="note">–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç. –î–æ–±–∞–≤—å —Ç—Ä–µ–∫ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ –ú—É–∑—ã–∫–∞ ‚Üí Local ‚Üí ‚ÄúÔºã –≤ –ø–ª–µ–π–ª–∏—Å—Ç‚Äù.</div>`;
        return;
      }

      // –ø–æ–∫–∞–∂–µ–º —Ç—Ä–µ–∫–∏ (—Ç–æ–ª—å–∫–æ local)
      p.trackIds.forEach(id=>{
        const t = localTracks.find(x => x.id===id);
        const el = document.createElement("div");
        el.className = "item";
        if(!t){
          el.innerHTML = `<div class="t">–¢—Ä–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</div><div class="d">${esc(id)}</div>`;
          box.appendChild(el);
          return;
        }
        el.innerHTML = `
          <div class="t">${esc(t.title)}</div>
          <div class="d">Local ‚Ä¢ ${fmtBytes(t.size)}</div>
          <div class="row" style="margin-top:10px;">
            <button class="btn2 primary">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn2">–£–¥–∞–ª–∏—Ç—å –∏–∑ –ø–ª–µ–π–ª–∏—Å—Ç–∞</button>
          </div>
        `;
        el.querySelectorAll("button")[0].addEventListener("click", ()=> playLocal(t.id));
        el.querySelectorAll("button")[1].addEventListener("click", ()=>{
          p.trackIds = p.trackIds.filter(x => x !== t.id);
          saveTree(tree);
          renderPlaylistTracks();
          renderPlaylists();
        });
        box.appendChild(el);
      });
    }

    $("#createFolderBtn").addEventListener("click", ()=>{
      const name = ($("#folderName").value || "").trim();
      if(!name) return;
      const id = "f_" + crypto.randomUUID();
      tree.folders.push({ id, name, playlists: [] });
      tree.selectedFolderId = id;
      tree.selectedPlaylistId = "";
      $("#folderName").value = "";
      saveTree(tree);
      renderFolders();
      renderPlaylists();
      renderPlaylistTracks();
    });

    $("#createPlaylistBtn").addEventListener("click", ()=>{
      const name = ($("#playlistName").value || "").trim();
      if(!name) return;
      const folder = findFolder(tree.selectedFolderId);
      if(!folder) return;
      const id = "p_" + crypto.randomUUID();
      folder.playlists.push({ id, name, trackIds: [] });
      tree.selectedPlaylistId = id;
      $("#playlistName").value = "";
      saveTree(tree);
      renderPlaylists();
      renderPlaylistTracks();
      renderFolders();
    });

    function addTrackToSelectedPlaylist(trackId){
      const found = findPlaylist(tree.selectedPlaylistId);
      if(!found){
        openPage("playlists");
        return;
      }
      const p = found.playlist;
      if(!p.trackIds.includes(trackId)) p.trackIds.push(trackId);
      saveTree(tree);
      renderPlaylists();
      renderPlaylistTracks();
    }

    // ---------- Player controls ----------
    // prev/next: –ø–æ Local —Å–ø–∏—Å–∫—É –µ—Å–ª–∏ activeSource=Local, –∏–Ω–∞—á–µ –ø–æ embed —Å–ø–∏—Å–∫—É
    $("#prevBtn").addEventListener("click", ()=>{
      if(activeSource === SOURCE.LOCAL){
        if(!localTracks.length) return;
        const idx = Math.max(0, localTracks.findIndex(t => t.id===activeLocalId));
        const next = (idx<=0) ? (localTracks.length-1) : (idx-1);
        playLocal(localTracks[next].id);
        return;
      }
      if(activeSource === SOURCE.EMBED){
        if(!embedItems.length) return;
        const next = (activeEmbed<=0) ? (embedItems.length-1) : (activeEmbed-1);
        playEmbed(next);
        return;
      }
    });

    $("#nextBtn").addEventListener("click", ()=>{
      if(activeSource === SOURCE.LOCAL){
        if(!localTracks.length) return;
        const idx = Math.max(0, localTracks.findIndex(t => t.id===activeLocalId));
        const next = (idx<0) ? 0 : ((idx+1) % localTracks.length);
        playLocal(localTracks[next].id);
        return;
      }
      if(activeSource === SOURCE.EMBED){
        if(!embedItems.length) return;
        const next = (activeEmbed<0) ? 0 : ((activeEmbed+1) % embedItems.length);
        playEmbed(next);
        return;
      }
    });

    $("#playBtn").addEventListener("click", ()=>{
      if(activeSource === SOURCE.LOCAL){
        if(audio.paused) audio.play().catch(()=>{});
        else audio.pause();
        $("#playBtn").textContent = audio.paused ? "‚ñ∂" : "‚è∏";
        return;
      }
      if(activeSource === SOURCE.EMBED){
        // –¥–ª—è embed –ø—Ä—è–º–æ–π play/pause –±–µ–∑ API –Ω–µ—Ç, –¥–µ–ª–∞–µ–º ‚Äú–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫‚Äù —Ç–µ–∫—É—â–µ–≥–æ
        if(activeEmbed < 0) playEmbed(0);
        else playEmbed(activeEmbed);
        return;
      }
      // –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî —Å—Ç–∞—Ä—Ç—É–µ–º –ø–µ—Ä–≤—ã–π local –∏–ª–∏ embed
      if(localTracks.length) playLocal(localTracks[0].id);
      else if(embedItems.length) playEmbed(0);
    });

    $("#stopBtn").addEventListener("click", ()=>{
      stopAll();
      $("#playBtn").textContent = "‚ñ∂";
    });

    audio.addEventListener("play", ()=> $("#playBtn").textContent = "‚è∏");
    audio.addEventListener("pause", ()=> $("#playBtn").textContent = "‚ñ∂");
    audio.addEventListener("ended", ()=> $("#playBtn").textContent = "‚ñ∂");

    // ---------- Settings ----------
    // –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ
    const s0 = loadLS("krs_s", getComputedStyle(root).getPropertyValue("--s").trim() || "1.10");
    const d0 = loadLS("krs_density", getComputedStyle(root).getPropertyValue("--density").trim() || "1.00");
    const a0 = loadLS("krs_accent", getComputedStyle(root).getPropertyValue("--accent").trim() || "#ffb347");
    const b0 = loadLS("krs_bg", document.body.getAttribute("data-bg") || "1");
    const sunOn0 = loadLS("krs_sunOn", getComputedStyle(root).getPropertyValue("--sunriseOn").trim() || "1");
    const sunPow0 = loadLS("krs_sunPow", getComputedStyle(root).getPropertyValue("--sunrisePower").trim() || "0.78");
    const rainOn0 = loadLS("krs_rainOn", getComputedStyle(root).getPropertyValue("--rainOn").trim() || "0");
    const rainCount0 = loadLS("krs_rainCount", getComputedStyle(root).getPropertyValue("--rainCount").trim() || "28");
    const rainFront0 = loadLS("krs_rainFront", document.body.getAttribute("data-rainfront") || "1");

    root.style.setProperty("--s", s0);
    root.style.setProperty("--density", d0);
    root.style.setProperty("--accent", a0);
    document.body.setAttribute("data-bg", b0);
    root.style.setProperty("--sunriseOn", sunOn0);
    root.style.setProperty("--sunrisePower", sunPow0);
    root.style.setProperty("--rainOn", rainOn0);
    root.style.setProperty("--rainCount", rainCount0);
    document.body.setAttribute("data-rainfront", rainFront0);

    $("#uiScale").value = s0;
    $("#density").value = d0;
    $("#accent").value = a0;
    $("#bgPreset").value = b0;
    $("#sunrisePower").value = sunPow0;
    $("#rainCount").value = rainCount0;

    function setToggle(el, on){
      el.classList.toggle("on", !!on);
    }
    const tglSunrise = $("#tglSunrise");
    const tglRain = $("#tglRain");
    const tglRainFront = $("#tglRainFront");
    setToggle(tglSunrise, Number(sunOn0)===1);
    setToggle(tglRain, Number(rainOn0)===1);
    setToggle(tglRainFront, Number(rainFront0)===1);

    $("#uiScale").addEventListener("input", e=>{ root.style.setProperty("--s", e.target.value); saveLS("krs_s", e.target.value); });
    $("#density").addEventListener("input", e=>{ root.style.setProperty("--density", e.target.value); saveLS("krs_density", e.target.value); });
    $("#accent").addEventListener("input", e=>{ root.style.setProperty("--accent", e.target.value); saveLS("krs_accent", e.target.value); });
    $("#bgPreset").addEventListener("input", e=>{ document.body.setAttribute("data-bg", e.target.value); saveLS("krs_bg", e.target.value); });
    $("#sunrisePower").addEventListener("input", e=>{ root.style.setProperty("--sunrisePower", e.target.value); saveLS("krs_sunPow", e.target.value); });

    tglSunrise.addEventListener("click", ()=>{
      const cur = Number(getComputedStyle(root).getPropertyValue("--sunriseOn").trim())===1;
      const next = cur ? 0 : 1;
      root.style.setProperty("--sunriseOn", next);
      saveLS("krs_sunOn", next);
      setToggle(tglSunrise, next===1);
    });

    tglRain.addEventListener("click", ()=>{
      const cur = Number(getComputedStyle(root).getPropertyValue("--rainOn").trim())===1;
      const next = cur ? 0 : 1;
      root.style.setProperty("--rainOn", next);
      saveLS("krs_rainOn", next);
      setToggle(tglRain, next===1);
      rebuildDrops();
    });

    tglRainFront.addEventListener("click", ()=>{
      const cur = document.body.getAttribute("data-rainfront")==="1";
      const next = cur ? "0" : "1";
      document.body.setAttribute("data-rainfront", next);
      saveLS("krs_rainFront", next);
      setToggle(tglRainFront, next==="1");
    });

    $("#rainCount").addEventListener("input", e=>{
      root.style.setProperty("--rainCount", e.target.value);
      saveLS("krs_rainCount", e.target.value);
      rebuildDrops();
    });

    // ---------- Rain build ----------
    const rainLayer = $("#rain");
    let drops = [];
    function rebuildDrops(){
      drops.forEach(d => d.remove());
      drops = [];
      const on = Number(getComputedStyle(root).getPropertyValue("--rainOn").trim())===1;
      const count = Number(getComputedStyle(root).getPropertyValue("--rainCount").trim()) || 0;
      if(!on || count<=0) return;

      const w = window.innerWidth;

      for(let i=0;i<count;i++){
        const d = document.createElement("div");
        d.className = "droplet";

        const left = Math.random()*w;
        const size = 6 + Math.random()*16;     // 6..22
        const dur  = 3.2 + Math.random()*7.2;  // 3.2..10.4
        const delay= Math.random()*2.4;
        const op   = 0.16 + Math.random()*0.34;

        d.style.left = left + "px";
        d.style.width = size + "px";
        d.style.height = size + "px";
        d.style.animationDuration = dur + "s";
        d.style.animationDelay = delay + "s";
        d.style.opacity = op;

        rainLayer.appendChild(d);
        drops.push(d);
      }
    }
    window.addEventListener("resize", rebuildDrops);

    // ---------- Render all ----------
    async function renderAll(){
      renderEmbeds();
      await loadLocalTracks();
      renderLocalList();
      renderFolders();
      renderPlaylists();
      renderPlaylistTracks();
    }

    // ---------- Hook buttons ----------
    $("#btnAddFiles").addEventListener("click", ()=> $("#fileInput").click());

    // ---------- Init ----------
    (async ()=>{
      openPage("home");
      await renderAll();
      rebuildDrops();
      setBadge(SOURCE.NONE);
    })();
  </script>
</body>
</html>
