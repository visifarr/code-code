<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö—Ä–∞—Å–∫–∏ –†–∞—Å—Å–≤–µ—Ç–∞ ‚Äî —Ä–µ–ª–∏–∑</title>

  <!-- ZIP import -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      /* ===== user settings (saved) ===== */
      --ui: 1.22;                  /* –æ–±—â–∏–π –º–∞—Å—à—Ç–∞–± */
      --accent: #ffb347;           /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç */
      --bgPreset: 1;               /* 1..10 */
      --rainOn: 0;                 /* 0/1 */
      --rainCount: 42;             /* 0..260 */
      --sunOn: 1;                  /* 0/1 */
      --sunPower: .86;             /* 0..1 */
      --glass: .62;                /* –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å—Ç–µ–∫–ª–∞ 0.30..0.90 */

      /* ===== theme base ===== */
      --bg0: #070914;
      --text: rgba(255,255,255,.95);
      --muted: rgba(255,255,255,.72);
      --stroke: rgba(255,255,255,.12);

      --r1: calc(26px * var(--ui));
      --r2: calc(18px * var(--ui));
      --pad: calc(16px * var(--ui));
      --gap: calc(14px * var(--ui));
      --blur: 16px;

      --fs0: calc(12px * var(--ui));
      --fs1: calc(14px * var(--ui));
      --fs2: calc(16px * var(--ui));
      --fs3: calc(20px * var(--ui));
      --fs4: calc(28px * var(--ui));

      --topH: calc(70px * var(--ui));
      --playerH: calc(132px * var(--ui));
      --tabsH: calc(70px * var(--ui));
      --sideW: calc(356px * var(--ui));
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg0);
      color: var(--text);
      overflow:hidden;
    }

    /* ===== background presets ===== */
    .bg{
      position:fixed; inset:0; z-index:0;
      background: var(--bg0);
    }
    .bg::before{
      content:"";
      position:absolute; inset:0;
      filter: saturate(1.18) contrast(1.06);
      opacity: 1;
      background:
        radial-gradient(1200px 760px at 20% -10%, rgba(255,179,71,.28), transparent 64%),
        radial-gradient(1100px 720px at 80% 0%, rgba(255,111,174,.22), transparent 66%),
        radial-gradient(1100px 820px at 55% 120%, rgba(110,203,255,.20), transparent 72%),
        radial-gradient(900px 560px at 20% 65%, rgba(255,255,255,.03), transparent 74%),
        var(--bg0);
    }

    body[data-bg="1"] .bg::before{ background:
      radial-gradient(1200px 780px at 18% -12%, rgba(255,179,71,.30), transparent 64%),
      radial-gradient(1100px 720px at 85% 2%, rgba(255,111,174,.24), transparent 66%),
      radial-gradient(1050px 820px at 55% 120%, rgba(110,203,255,.20), transparent 74%),
      radial-gradient(900px 560px at 30% 65%, rgba(255,255,255,.03), transparent 76%),
      var(--bg0);
    }
    body[data-bg="2"] .bg::before{ background:
      radial-gradient(1300px 820px at 15% -10%, rgba(255,111,174,.30), transparent 64%),
      radial-gradient(1200px 760px at 86% 0%, rgba(110,203,255,.22), transparent 68%),
      radial-gradient(1100px 860px at 55% 120%, rgba(255,179,71,.18), transparent 74%),
      radial-gradient(900px 560px at 45% 55%, rgba(255,255,255,.03), transparent 76%),
      #070815;
    }
    body[data-bg="3"] .bg::before{ background:
      radial-gradient(1200px 820px at 22% -10%, rgba(110,203,255,.26), transparent 66%),
      radial-gradient(1100px 720px at 84% 0%, rgba(255,179,71,.22), transparent 68%),
      radial-gradient(1100px 860px at 55% 122%, rgba(255,111,174,.18), transparent 74%),
      radial-gradient(900px 560px at 35% 55%, rgba(255,255,255,.03), transparent 78%),
      #060915;
    }
    body[data-bg="4"] .bg::before{ background:
      radial-gradient(1400px 920px at 15% 0%, rgba(255,179,71,.22), transparent 66%),
      radial-gradient(1200px 800px at 88% 0%, rgba(255,111,174,.18), transparent 70%),
      radial-gradient(1200px 920px at 55% 124%, rgba(110,203,255,.16), transparent 76%),
      radial-gradient(900px 560px at 40% 55%, rgba(255,255,255,.03), transparent 78%),
      #060712;
    }
    body[data-bg="5"] .bg::before{ background:
      radial-gradient(1400px 920px at 20% -10%, rgba(255,179,71,.20), transparent 68%),
      radial-gradient(1200px 800px at 86% 0%, rgba(110,203,255,.18), transparent 70%),
      radial-gradient(1200px 920px at 55% 124%, rgba(255,111,174,.16), transparent 76%),
      radial-gradient(900px 560px at 30% 60%, rgba(255,255,255,.03), transparent 78%),
      #070a18;
    }
    body[data-bg="6"] .bg::before{ background:
      radial-gradient(1200px 820px at 18% -10%, rgba(255,111,174,.24), transparent 68%),
      radial-gradient(1200px 820px at 82% 0%, rgba(255,179,71,.18), transparent 72%),
      radial-gradient(1200px 920px at 55% 124%, rgba(110,203,255,.14), transparent 78%),
      radial-gradient(900px 560px at 40% 55%, rgba(255,255,255,.03), transparent 78%),
      #070914;
    }
    body[data-bg="7"] .bg::before{ background:
      radial-gradient(1400px 920px at 18% -10%, rgba(110,203,255,.22), transparent 70%),
      radial-gradient(1200px 820px at 86% 0%, rgba(255,111,174,.18), transparent 74%),
      radial-gradient(1200px 920px at 55% 124%, rgba(255,179,71,.14), transparent 78%),
      radial-gradient(900px 560px at 36% 55%, rgba(255,255,255,.03), transparent 78%),
      #060915;
    }
    body[data-bg="8"] .bg::before{ background:
      radial-gradient(1500px 980px at 20% -12%, rgba(255,179,71,.18), transparent 72%),
      radial-gradient(1300px 900px at 86% 0%, rgba(110,203,255,.18), transparent 76%),
      radial-gradient(1200px 920px at 55% 124%, rgba(255,111,174,.14), transparent 80%),
      radial-gradient(900px 560px at 32% 55%, rgba(255,255,255,.03), transparent 78%),
      #070814;
    }
    body[data-bg="9"] .bg::before{ background:
      radial-gradient(1500px 980px at 18% -12%, rgba(255,111,174,.18), transparent 72%),
      radial-gradient(1300px 900px at 86% 0%, rgba(255,179,71,.16), transparent 76%),
      radial-gradient(1200px 920px at 55% 124%, rgba(110,203,255,.12), transparent 80%),
      radial-gradient(900px 560px at 32% 55%, rgba(255,255,255,.03), transparent 78%),
      #070815;
    }
    body[data-bg="10"] .bg::before{ background:
      radial-gradient(1600px 1000px at 20% -12%, rgba(110,203,255,.18), transparent 74%),
      radial-gradient(1400px 940px at 86% 0%, rgba(255,111,174,.16), transparent 78%),
      radial-gradient(1200px 920px at 55% 124%, rgba(255,179,71,.12), transparent 82%),
      radial-gradient(900px 560px at 35% 55%, rgba(255,255,255,.03), transparent 80%),
      #060712;
    }

    /* ===== sunrise layer ===== */
    .sun{
      position:fixed; inset:-18%;
      z-index:1; pointer-events:none;
      opacity: calc(var(--sunOn) * var(--sunPower));
      background:
        radial-gradient(980px 460px at 26% 10%, color-mix(in srgb, var(--accent) 52%, transparent), transparent 62%),
        radial-gradient(820px 420px at 74% 18%, rgba(255,111,174,.34), transparent 66%),
        radial-gradient(980px 640px at 50% 104%, rgba(110,203,255,.26), transparent 72%);
      animation: sunMove 18s ease-in-out infinite;
      filter: blur(.3px);
    }
    @keyframes sunMove{
      0%{ transform: translate3d(-1.4%,-1.0%,0) scale(1.02); }
      50%{ transform: translate3d( 1.6%, 1.2%,0) scale(1.05); }
      100%{ transform: translate3d(-1.4%,-1.0%,0) scale(1.02); }
    }

    /* ===== rain on top of UI ===== */
    .rain{
      position:fixed; inset:0;
      z-index:80; pointer-events:none;
      opacity: calc(var(--rainOn) * .95);
      overflow:hidden;
    }
    .drop{
      position:absolute; top:-14vh;
      width: 16px; height: 16px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 28%, rgba(255,255,255,.72), rgba(255,255,255,.12) 46%, rgba(255,255,255,.02) 72%, transparent 78%),
        radial-gradient(circle at 70% 80%, rgba(140,220,255,.22), transparent 70%);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06),
        0 18px 44px rgba(0,0,0,.26);
      animation: dropFall linear infinite;
      transform: translateZ(0);
    }
    .drop::after{
      content:"";
      position:absolute; left:50%; top:-24px;
      width:2px; height:26px;
      transform: translateX(-50%);
      background: linear-gradient(to bottom, transparent, rgba(200,240,255,.26), transparent);
      border-radius:999px;
      opacity:.65;
    }
    @keyframes dropFall{ to{ transform: translateY(146vh) translateZ(0); } }

    /* ===== app shell ===== */
    .app{
      position:relative; z-index:3;
      height:100%;
      display:grid;
      grid-template-columns: var(--sideW) 1fr;
      grid-template-rows: 1fr var(--playerH);
      gap: var(--gap);
      padding: var(--pad);
    }

    .glass{
      background: rgba(14,16,28, var(--glass));
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: 0 22px 78px rgba(0,0,0,.66);
      overflow:hidden;
      position:relative;
    }
    .glass::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(900px 280px at 18% -10%, rgba(255,255,255,.07), transparent 60%),
        radial-gradient(820px 260px at 88% 0%, rgba(255,255,255,.05), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.06), transparent 44%);
      opacity: .9;
      pointer-events:none;
    }
    .glass > *{ position:relative; z-index:1; }

    /* ===== sidebar ===== */
    .side{
      display:flex;
      flex-direction:column;
      gap: calc(14px * var(--ui));
      padding: calc(16px * var(--ui));
      min-width:0;
    }
    .brandRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .logo{
      font-weight: 980;
      font-size: var(--fs3);
      line-height:1.05;
      letter-spacing:.2px;
      background: linear-gradient(90deg, var(--accent), #ff6fae);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      user-select:none;
    }
    .ver{
      font-size: var(--fs0);
      color: rgba(255,255,255,.70);
      font-weight: 900;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 6px 10px;
      border-radius: 999px;
      white-space:nowrap;
      user-select:none;
    }
    .sub{
      margin-top: 4px;
      font-size: var(--fs1);
      color: rgba(255,255,255,.70);
      font-weight: 800;
    }

    .nav{
      display:flex;
      flex-direction:column;
      gap: calc(10px * var(--ui));
      margin-top: calc(4px * var(--ui));
    }
    .nav button{
      width:100%;
      border:none;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      border-radius: calc(18px * var(--ui));
      padding: calc(14px * var(--ui)) calc(14px * var(--ui));
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      font-weight: 950;
      font-size: var(--fs2);
      letter-spacing:.1px;
    }
    .nav button:hover{ background: rgba(255,255,255,.07); }
    .nav button.active{
      border-color: color-mix(in srgb, var(--accent) 42%, rgba(255,255,255,.12));
      background:
        radial-gradient(520px 160px at 18% 0%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 62%),
        rgba(255,255,255,.05);
    }
    .nav .l{
      display:flex; align-items:center; gap: 10px;
      min-width:0;
    }
    .nav .l span{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .kbd{
      font-size: var(--fs0);
      color: rgba(255,255,255,.75);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 980;
      flex:0 0 auto;
    }

    .sideCard{
      margin-top:auto;
      padding: calc(14px * var(--ui));
      border-radius: var(--r2);
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.78);
      font-weight: 800;
      font-size: var(--fs1);
      line-height:1.35;
    }
    .sideCard b{ color: rgba(255,255,255,.92); }

    /* ===== main ===== */
    .main{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .top{
      height: var(--topH);
      display:flex;
      align-items:center;
      gap: calc(12px * var(--ui));
      padding: calc(12px * var(--ui));
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap: 12px;
      padding: calc(12px * var(--ui)) calc(14px * var(--ui));
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      min-width:0;
    }
    .search .i{ font-size: var(--fs2); opacity:.9; }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color: var(--text);
      font-size: var(--fs2);
      font-weight: 950;
      letter-spacing:.2px;
      min-width:0;
    }
    .chip{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: calc(11px * var(--ui)) calc(14px * var(--ui));
      font-weight: 980;
      font-size: var(--fs1);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .chip:hover{ background: rgba(255,255,255,.09); }

    .content{
      padding: calc(16px * var(--ui));
      overflow:auto;
      min-width:0;
    }
    .content::-webkit-scrollbar{ width: 10px; }
    .content::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }

    /* ===== sections ===== */
    .hero{
      padding: calc(18px * var(--ui));
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(860px 320px at 20% 0%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 62%),
        radial-gradient(780px 320px at 80% 0%, rgba(110,203,255,.14), transparent 66%),
        rgba(255,255,255,.03);
    }
    .hero h1{
      margin:0;
      font-size: var(--fs4);
      font-weight: 990;
      letter-spacing:.2px;
    }
    .hero p{
      margin: 10px 0 0;
      font-size: var(--fs2);
      font-weight: 850;
      color: rgba(255,255,255,.78);
      line-height:1.25;
    }

    .grid3{
      margin-top: calc(14px * var(--ui));
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: calc(14px * var(--ui));
    }
    .tile{
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 260px at 18% -10%, rgba(255,255,255,.06), transparent 62%),
        rgba(255,255,255,.03);
      padding: calc(16px * var(--ui));
      cursor:pointer;
      user-select:none;
      min-height: calc(120px * var(--ui));
      position:relative;
      overflow:hidden;
    }
    .tile:hover{ background: rgba(255,255,255,.05); }
    .tile .t{
      font-weight: 990;
      font-size: var(--fs3);
      letter-spacing:.1px;
    }
    .tile .d{
      margin-top: 10px;
      font-size: var(--fs2);
      font-weight: 850;
      color: rgba(255,255,255,.78);
      line-height:1.25;
    }

    .box{
      margin-top: calc(14px * var(--ui));
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      padding: calc(16px * var(--ui));
    }
    .box h3{
      margin:0 0 12px 0;
      font-size: var(--fs3);
      font-weight: 990;
      letter-spacing:.1px;
    }
    .row{ display:flex; gap: 12px; align-items:center; flex-wrap:wrap; }
    .note{
      margin-top: 10px;
      font-size: var(--fs2);
      font-weight: 850;
      color: rgba(255,255,255,.70);
      line-height:1.35;
    }

    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.94);
      border-radius: calc(18px * var(--ui));
      padding: calc(12px * var(--ui)) calc(14px * var(--ui));
      font-weight: 980;
      font-size: var(--fs2);
      cursor:pointer;
      user-select:none;
      letter-spacing:.1px;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn.primary{
      background:
        radial-gradient(60% 70% at 30% 25%, rgba(255,255,255,.22), transparent 60%),
        var(--accent);
      border-color: color-mix(in srgb, var(--accent) 60%, rgba(255,255,255,.12));
      color:#141414;
    }
    .btn.ghost{ background: rgba(255,255,255,.04); }

    .list{
      display:flex;
      flex-direction:column;
      gap: calc(12px * var(--ui));
      min-width:0;
    }
    .item{
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 260px at 18% -10%, rgba(255,255,255,.05), transparent 62%),
        rgba(0,0,0,.16);
      padding: calc(14px * var(--ui));
      cursor:pointer;
      user-select:none;
      overflow:hidden;
      position:relative;
    }
    .item:hover{ background: rgba(255,255,255,.05); }
    .item.active{
      border-color: color-mix(in srgb, var(--accent) 42%, rgba(255,255,255,.12));
      background:
        radial-gradient(900px 280px at 18% -10%, color-mix(in srgb, var(--accent) 16%, transparent), transparent 62%),
        rgba(255,255,255,.05);
    }
    .item .t{
      font-weight: 990;
      font-size: var(--fs3);
      letter-spacing:.1px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item .d{
      margin-top: 6px;
      font-weight: 850;
      font-size: var(--fs2);
      color: rgba(255,255,255,.74);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mini{
      margin-top: calc(12px * var(--ui));
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }

    .grid2{
      margin-top: calc(14px * var(--ui));
      display:grid;
      grid-template-columns: 1.05fr 1.25fr;
      gap: calc(14px * var(--ui));
      min-width:0;
    }

    .stage{
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      overflow:hidden;
      min-height: calc(320px * var(--ui));
    }
    .stage iframe{
      width:100%;
      height: calc(360px * var(--ui));
      border:0;
      display:block;
    }

    /* ===== player (bottom) ===== */
    .player{
      grid-column: 1 / span 2;
      height: var(--playerH);
      padding: calc(14px * var(--ui)) calc(16px * var(--ui));
      display:grid;
      grid-template-columns: 1.45fr 1fr 1.2fr;
      gap: calc(14px * var(--ui));
      align-items:center;

      background:
        radial-gradient(900px 220px at 20% 0%, rgba(255,179,71,.12), transparent 60%),
        radial-gradient(900px 220px at 80% 0%, rgba(255,111,174,.10), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
        rgba(14,16,28, .56);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--r1);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 26px 92px rgba(0,0,0,.72);
      overflow:hidden;
      position:relative;
      z-index:10;
    }
    .player::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(900px 240px at 15% -10%, rgba(255,255,255,.08), transparent 62%),
        radial-gradient(840px 240px at 85% 0%, rgba(255,255,255,.06), transparent 64%);
      opacity:.9;
      pointer-events:none;
    }
    .player > *{ position:relative; z-index:1; }

    .now{
      display:flex;
      align-items:center;
      gap: calc(12px * var(--ui));
      min-width:0;
    }
    .art{
      width: calc(66px * var(--ui));
      height: calc(66px * var(--ui));
      border-radius: calc(20px * var(--ui));
      background:
        radial-gradient(55% 70% at 30% 28%, rgba(255,255,255,.18), transparent 56%),
        linear-gradient(135deg, rgba(255,255,255,.08), color-mix(in srgb, var(--accent) 26%, transparent));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 46px rgba(0,0,0,.28);
      flex:0 0 auto;
    }
    .meta{ min-width:0; }
    .track{
      font-weight: 990;
      font-size: var(--fs3);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .artist{
      margin-top: 6px;
      font-weight: 850;
      font-size: var(--fs2);
      color: rgba(255,255,255,.78);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* fixed perfect control row (no "–∫—Ä–∏–≤–æ") */
    .ctrl{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: calc(12px * var(--ui));
    }
    .pbtn{
      width: calc(48px * var(--ui));
      height: calc(48px * var(--ui));
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(60% 70% at 30% 28%, rgba(255,255,255,.10), transparent 60%),
        rgba(255,255,255,.06);
      color: rgba(255,255,255,.96);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight: 990;
      user-select:none;
      box-shadow:
        0 12px 30px rgba(0,0,0,.18) inset,
        0 14px 30px rgba(0,0,0,.16);
      font-size: var(--fs2);
    }
    .pbtn:hover{ background: rgba(255,255,255,.10); }
    .pbtn.play{
      width: calc(60px * var(--ui));
      height: calc(60px * var(--ui));
      background:
        radial-gradient(60% 70% at 30% 25%, rgba(255,255,255,.24), transparent 62%),
        var(--accent);
      border-color: color-mix(in srgb, var(--accent) 60%, rgba(255,255,255,.12));
      color:#141414;
      font-size: var(--fs3);
    }

    .right{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 12px;
      min-width:0;
      flex-wrap:wrap;
    }
    .badge{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      border-radius: 999px;
      padding: 9px 12px;
      font-weight: 980;
      font-size: var(--fs1);
      user-select:none;
      white-space:nowrap;
    }
    #audio{ display:none; }

    /* ===== tooltip modal ===== */
    .modalWrap{
      position:fixed; inset:0;
      display:none;
      z-index: 95;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modal{
      width: min(680px, 100%);
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(14,16,28,.88);
      box-shadow: 0 34px 110px rgba(0,0,0,.78);
      overflow:hidden;
    }
    .mTop{
      padding: 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .mTop .ttl{
      font-weight: 990;
      font-size: var(--fs3);
      letter-spacing:.1px;
    }
    .mBody{
      padding: 16px;
      color: rgba(255,255,255,.84);
      font-weight: 850;
      font-size: var(--fs2);
      line-height: 1.35;
      white-space:pre-wrap;
    }

    /* ===== mobile bottom tabs (always perfect align) ===== */
    .tabs{
      display:none;
      position:fixed;
      left: var(--pad);
      right: var(--pad);
      bottom: calc(var(--playerH) + var(--pad));
      z-index: 85;
      height: var(--tabsH);
      border-radius: calc(24px * var(--ui));
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(14,16,28,.54);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 22px 80px rgba(0,0,0,.64);
      padding: calc(10px * var(--ui));
      gap: calc(10px * var(--ui));
      grid-template-columns: repeat(5, 1fr);
    }
    .tbtn{
      border:none;
      border-radius: calc(18px * var(--ui));
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      font-weight: 990;
      font-size: var(--fs1);
      cursor:pointer;
      user-select:none;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 2px;
      min-width:0;
      line-height:1.05;
    }
    .tbtn .ico{ font-size: var(--fs2); }
    .tbtn .n{ font-size: var(--fs0); opacity:.82; }
    .tbtn.active{
      background:
        radial-gradient(420px 160px at 50% 0%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 60%),
        rgba(255,255,255,.06);
      border-color: color-mix(in srgb, var(--accent) 42%, rgba(255,255,255,.12));
    }

    /* ===== responsive ===== */
    @media (max-width: 1040px){
      :root{ --sideW: calc(320px * var(--ui)); }
      .grid3{ grid-template-columns: 1fr; }
      .grid2{ grid-template-columns: 1fr; }
    }
    @media (max-width: 860px){
      .app{
        grid-template-columns: 1fr;
        grid-template-rows: 1fr var(--playerH);
      }
      .side{ display:none; }
      .player{ grid-column: 1; grid-template-columns: 1fr; height:auto; }
      #audio{ display:block; }
      .right{ justify-content:space-between; }
      .tabs{ display:grid; }
      body{ overflow:auto; }
    }
  </style>
</head>

<body data-bg="1">
  <div class="bg"></div>
  <div class="sun"></div>
  <div class="rain" id="rain"></div>

  <!-- modal -->
  <div class="modalWrap" id="mw">
    <div class="modal">
      <div class="mTop">
        <div class="ttl" id="mt">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
        <button class="btn ghost" id="mc">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="mBody" id="mb"></div>
    </div>
  </div>

  <!-- mobile tabs -->
  <div class="tabs" id="tabs">
    <button class="tbtn active" data-p="home"><div class="ico">üè†</div><div class="n">1</div></button>
    <button class="tbtn" data-p="music"><div class="ico">üéß</div><div class="n">2</div></button>
    <button class="tbtn" data-p="playlists"><div class="ico">üìÅ</div><div class="n">3</div></button>
    <button class="tbtn" data-p="embed"><div class="ico">üåê</div><div class="n">4</div></button>
    <button class="tbtn" data-p="settings"><div class="ico">‚öô</div><div class="n">5</div></button>
  </div>

  <div class="app">
    <!-- sidebar -->
    <aside class="glass side">
      <div class="brandRow">
        <div>
          <div class="logo">–ö—Ä–∞—Å–∫–∏ –†–∞—Å—Å–≤–µ—Ç–∞</div>
          <div class="sub">Spotify-–ø–æ–¥–æ–±–Ω–æ, –Ω–æ —Å–≤–æ—ë</div>
        </div>
        <div class="ver" id="ver">REL-2026-02-02</div>
      </div>

      <div class="nav" id="nav">
        <button class="active" data-p="home"><div class="l">üè† <span>–ì–ª–∞–≤–Ω–∞—è</span></div><span class="kbd">1</span></button>
        <button data-p="music"><div class="l">üéß <span>–ú—É–∑—ã–∫–∞</span></div><span class="kbd">2</span></button>
        <button data-p="playlists"><div class="l">üìÅ <span>–ü–ª–µ–π–ª–∏—Å—Ç—ã</span></div><span class="kbd">3</span></button>
        <button data-p="embed"><div class="l">üåê <span>Embed</span></div><span class="kbd">4</span></button>
        <button data-p="settings"><div class="l">‚öô <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div><span class="kbd">5</span></button>
      </div>

      <div class="sideCard" id="stats">
        <b>–°—Ç–∞—Ç—É—Å</b>\nRepo: 0\nLocal: 0\n–ü–ª–µ–π–ª–∏—Å—Ç—ã: 0
      </div>
    </aside>

    <!-- main -->
    <main class="glass main">
      <div class="top">
        <div class="search">
          <div class="i">üîç</div>
          <input id="q" placeholder="–ü–æ–∏—Å–∫: –∞–≤—Ç–æ—Ä –∏–ª–∏ —Ç—Ä–µ–∫" autocomplete="off" />
        </div>
        <div class="chip" id="chipHelp">–ü–æ–¥—Å–∫–∞–∑–∫–∏</div>
        <div class="chip" id="chipSettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      </div>

      <div class="content">
        <!-- HOME -->
        <section id="p-home">
          <div class="hero">
            <h1>–ì–ª–∞–≤–Ω–∞—è</h1>
            <p>–ò–º–ø–æ—Ä—Ç —Ç—Ä–µ–∫–æ–≤ ‚Ä¢ –ø–ª–µ–π–ª–∏—Å—Ç—ã ‚Ä¢ —Ä–∞—Å—Å–≤–µ—Ç ‚Ä¢ –¥–æ–∂–¥—å –ø–æ–≤–µ—Ä—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ‚Ä¢ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏—à–∞–º–∏ 1‚Äì5</p>
          </div>

          <div class="grid3">
            <div class="tile" id="goImport">
              <div class="t">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫–∏</div>
              <div class="d">—Ñ–∞–π–ª—ã / –ø–∞–ø–∫–∞ / zip ‚Üí Local (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ)</div>
            </div>
            <div class="tile" id="goAuto">
              <div class="t">–ê–≤—Ç–æ-–ø–ª–µ–π–ª–∏—Å—Ç—ã</div>
              <div class="d">–ø–æ –∞–≤—Ç–æ—Ä—É –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ ‚Äú–ê–≤—Ç–æ—Ä - –ù–∞–∑–≤–∞–Ω–∏–µ‚Äù</div>
            </div>
            <div class="tile" id="goEmbed">
              <div class="t">Embed-–≤–∫–ª–∞–¥–∫–∞</div>
              <div class="d">–≤—Å—Ç—Ä–æ–π–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–µ—Å—Ç–µ</div>
            </div>
          </div>

          <div class="box">
            <h3>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            <div class="row">
              <button class="btn primary" id="homeToMusic">–û—Ç–∫—Ä—ã—Ç—å –ú—É–∑—ã–∫–∞</button>
              <button class="btn" id="homeToPlaylists">–û—Ç–∫—Ä—ã—Ç—å –ü–ª–µ–π–ª–∏—Å—Ç—ã</button>
              <button class="btn ghost" id="homeTip">?</button>
            </div>
            <div class="note" id="homeNote">‚Äî</div>
          </div>

          <div class="box">
            <h3>–ù–µ–¥–∞–≤–Ω–∏–µ (Local)</h3>
            <div class="list" id="recent"></div>
          </div>
        </section>

        <!-- MUSIC -->
        <section id="p-music" style="display:none">
          <div class="hero">
            <h1>–ú—É–∑—ã–∫–∞</h1>
            <p>–û–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫ (–µ—Å–ª–∏ –≤–∫–ª—é—á–∏–ª –¥—Ä—É–≥–æ–π ‚Äî —Å—Ç–∞—Ä—ã–π –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è). –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –ø–ª–µ–π–ª–∏—Å—Ç—ã.</p>
          </div>

          <div class="box">
            <h3>–ò–º–ø–æ—Ä—Ç</h3>
            <div class="row">
              <input id="inFiles" type="file" accept="audio/*" multiple style="display:none">
              <input id="inFolder" type="file" accept="audio/*" multiple webkitdirectory directory style="display:none">
              <input id="inZip" type="file" accept=".zip" style="display:none">

              <button class="btn primary" id="bFiles">–§–∞–π–ª—ã</button>
              <button class="btn" id="bFolder">–ü–∞–ø–∫–∞</button>
              <button class="btn" id="bZip">ZIP</button>
              <button class="btn ghost" id="bClearLocal">–û—á–∏—Å—Ç–∏—Ç—å Local</button>
              <button class="btn ghost" id="bImportTip">?</button>
            </div>
            <div class="note" id="importNote">‚Äî</div>
          </div>

          <div class="box">
            <h3>–¢—Ä–µ–∫–∏</h3>
            <div class="list" id="tracks"></div>
          </div>
        </section>

        <!-- PLAYLISTS -->
        <section id="p-playlists" style="display:none">
          <div class="hero">
            <h1>–ü–ª–µ–π–ª–∏—Å—Ç—ã</h1>
            <p>–°–æ–∑–¥–∞—Ç—å ‚Ä¢ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å ‚Ä¢ —É–¥–∞–ª–∏—Ç—å ‚Ä¢ –∏–≥—Ä–∞—Ç—å –≤—Å—ë ‚Ä¢ –æ—á–∏—â–∞—Ç—å ‚Ä¢ —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–ª–∏–∫–æ–º</p>
          </div>

          <div class="box">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div class="row">
              <button class="btn primary" id="plNew">–ù–æ–≤—ã–π</button>
              <button class="btn" id="plRename">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
              <button class="btn ghost" id="plDelete">–£–¥–∞–ª–∏—Ç—å</button>
              <button class="btn ghost" id="plTip">?</button>
            </div>
          </div>

          <div class="grid2">
            <div class="box">
              <h3>–°–ø–∏—Å–æ–∫</h3>
              <div class="list" id="plList"></div>
            </div>

            <div class="box">
              <h3 id="plTitle">–ü–ª–µ–π–ª–∏—Å—Ç</h3>
              <div class="row">
                <button class="btn primary" id="plPlayAll">–ò–≥—Ä–∞—Ç—å –≤—Å—ë</button>
                <button class="btn" id="plClear">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn ghost" id="plAbout">?</button>
              </div>
              <div class="note" id="plMeta">‚Äî</div>
              <div class="list" id="plTracks"></div>
            </div>
          </div>
        </section>

        <!-- EMBED -->
        <section id="p-embed" style="display:none">
          <div class="hero">
            <h1>Embed</h1>
            <p>–û—Ç–¥–µ–ª—å–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞. –¢—É—Ç —Ç–æ–ª—å–∫–æ –≤—Å—Ç—Ä–æ–π–∫–∏. Local/Repo ‚Äî –≤ ‚Äú–ú—É–∑—ã–∫–∞‚Äù.</p>
          </div>

          <div class="box">
            <h3>–°–ø–∏—Å–æ–∫</h3>
            <div class="grid2">
              <div class="list" id="embedList"></div>
              <div class="stage" id="stage"></div>
            </div>
            <div class="note">–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ ‚Äî –∂–º–∏ ‚Äú?‚Äù —É –∫–∞—Ä—Ç–æ—á–∫–∏</div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section id="p-settings" style="display:none">
          <div class="hero">
            <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
            <p>–†–∞–∑–º–µ—Ä ‚Ä¢ —Ü–≤–µ—Ç ‚Ä¢ —Å—Ç–µ–∫–ª–æ ‚Ä¢ –ø—Ä–µ—Å–µ—Ç—ã —Ñ–æ–Ω–∞ ‚Ä¢ —Ä–∞—Å—Å–≤–µ—Ç ‚Ä¢ –¥–æ–∂–¥—å –ø–æ–≤–µ—Ä—Ö —ç–∫—Ä–∞–Ω–∞</p>
          </div>

          <div class="box">
            <h3>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
            <div class="row">
              <span style="font-weight:990;font-size:var(--fs2);">–ú–∞—Å—à—Ç–∞–±</span>
              <input id="s_ui" type="range" min="0.90" max="2.00" step="0.01" style="width:min(640px,100%)">
            </div>
            <div class="row" style="margin-top:12px;">
              <span style="font-weight:990;font-size:var(--fs2);">–°—Ç–µ–∫–ª–æ</span>
              <input id="s_glass" type="range" min="0.30" max="0.90" step="0.01" style="width:min(640px,100%)">
            </div>
            <div class="row" style="margin-top:12px;">
              <span style="font-weight:990;font-size:var(--fs2);">–¶–≤–µ—Ç</span>
              <input id="s_accent" type="color" style="width:56px;height:40px;border:none;background:transparent;">
              <button class="btn ghost" id="s_tip">?</button>
            </div>
          </div>

          <div class="box">
            <h3>–§–æ–Ω –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã</h3>
            <div class="row">
              <span style="font-weight:990;font-size:var(--fs2);">–ü—Ä–µ—Å–µ—Ç</span>
              <input id="s_bg" type="range" min="1" max="10" step="1" style="width:min(640px,100%)">
              <span class="badge" id="bgLabel">Preset: 1</span>
            </div>

            <div class="row" style="margin-top:14px;">
              <button class="btn" id="sunToggle">–†–∞—Å—Å–≤–µ—Ç: ON</button>
              <button class="btn" id="rainToggle">–î–æ–∂–¥—å: OFF</button>
            </div>

            <div class="row" style="margin-top:14px;">
              <span style="font-weight:990;font-size:var(--fs2);">–°–∏–ª–∞ —Ä–∞—Å—Å–≤–µ—Ç–∞</span>
              <input id="s_sun" type="range" min="0" max="1" step="0.01" style="width:min(640px,100%)">
            </div>

            <div class="row" style="margin-top:14px;">
              <span style="font-weight:990;font-size:var(--fs2);">–ö–∞–ø–ª–∏</span>
              <input id="s_rain" type="range" min="0" max="260" step="1" style="width:min(640px,100%)">
            </div>
          </div>
        </section>

      </div>
    </main>

    <!-- player -->
    <footer class="player">
      <div class="now">
        <div class="art"></div>
        <div class="meta">
          <div class="track" id="tName">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞</div>
          <div class="artist" id="tArtist">–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫</div>
        </div>
      </div>

      <div class="ctrl">
        <button class="pbtn" id="prev" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π">‚èÆ</button>
        <button class="pbtn play" id="play" title="Play">‚ñ∂</button>
        <button class="pbtn" id="next" title="–°–ª–µ–¥—É—é—â–∏–π">‚è≠</button>
        <button class="pbtn" id="stop" title="–°—Ç–æ–ø">‚èπ</button>
      </div>

      <div class="right">
        <button class="btn" id="toPl">–í –ø–ª–µ–π–ª–∏—Å—Ç</button>
        <span class="badge" id="src">Source: ‚Äî</span>
        <audio id="audio" controls></audio>
      </div>
    </footer>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);

    const VERSION = "REL-2026-02-02";
    $("#ver").textContent = VERSION;

    const mw = $("#mw"), mt = $("#mt"), mb = $("#mb");
    $("#mc").addEventListener("click", ()=> mw.style.display="none");
    mw.addEventListener("click", (e)=>{ if(e.target===mw) mw.style.display="none"; });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") mw.style.display="none"; });

    function tip(title, text){
      mt.textContent = title || "–ü–æ–¥—Å–∫–∞–∑–∫–∞";
      mb.textContent = text || "";
      mw.style.display = "flex";
    }

    const root = document.documentElement;
    const audio = $("#audio");
    const rainLayer = $("#rain");
    const stage = $("#stage");

    // ===== storage =====
    const LS = {
      ui:"krs_ui", accent:"krs_accent", bg:"krs_bg",
      rainOn:"krs_rainOn", rainCount:"krs_rainCount",
      sunOn:"krs_sunOn", sunPower:"krs_sunPower",
      glass:"krs_glass",
      playlists:"krs_playlists_v4"
    };

    function lsGet(k, def){ const v=localStorage.getItem(k); return (v==null)? def : v; }
    function lsSet(k, v){ localStorage.setItem(k, String(v)); }

    // apply saved
    const ui0 = parseFloat(lsGet(LS.ui, getComputedStyle(root).getPropertyValue("--ui").trim())) || 1.22;
    const a0  = lsGet(LS.accent, getComputedStyle(root).getPropertyValue("--accent").trim()) || "#ffb347";
    const bg0 = parseInt(lsGet(LS.bg, document.body.getAttribute("data-bg") || "1"),10) || 1;
    const rOn0= parseInt(lsGet(LS.rainOn, getComputedStyle(root).getPropertyValue("--rainOn").trim()),10) || 0;
    const rCt0= parseInt(lsGet(LS.rainCount, getComputedStyle(root).getPropertyValue("--rainCount").trim()),10) || 42;
    const sOn0= parseInt(lsGet(LS.sunOn, getComputedStyle(root).getPropertyValue("--sunOn").trim()),10) || 1;
    const sPw0= parseFloat(lsGet(LS.sunPower, getComputedStyle(root).getPropertyValue("--sunPower").trim())) || .86;
    const g0  = parseFloat(lsGet(LS.glass, getComputedStyle(root).getPropertyValue("--glass").trim())) || .62;

    root.style.setProperty("--ui", ui0);
    root.style.setProperty("--accent", a0);
    root.style.setProperty("--rainOn", rOn0);
    root.style.setProperty("--rainCount", rCt0);
    root.style.setProperty("--sunOn", sOn0);
    root.style.setProperty("--sunPower", sPw0);
    root.style.setProperty("--glass", g0);
    document.body.setAttribute("data-bg", String(bg0));
    $("#bgLabel").textContent = "Preset: " + bg0;

    // settings UI init
    $("#s_ui").value = ui0;
    $("#s_accent").value = a0;
    $("#s_bg").value = bg0;
    $("#s_rain").value = rCt0;
    $("#s_sun").value = sPw0;
    $("#s_glass").value = g0;

    function setButtons(){
      $("#sunToggle").textContent = "–†–∞—Å—Å–≤–µ—Ç: " + (parseInt(getComputedStyle(root).getPropertyValue("--sunOn"))===1 ? "ON":"OFF");
      $("#rainToggle").textContent = "–î–æ–∂–¥—å: " + (parseInt(getComputedStyle(root).getPropertyValue("--rainOn"))===1 ? "ON":"OFF");
    }
    setButtons();

    $("#s_tip").addEventListener("click", ()=> tip(
      "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
      "–ú–∞—Å—à—Ç–∞–± –º–µ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä –≤—Å–µ–≥–æ.\n–°—Ç–µ–∫–ª–æ ‚Äî –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–∞–Ω–µ–ª–µ–π.\n–¶–≤–µ—Ç ‚Äî –∞–∫—Ü–µ–Ω—Ç –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏."
    ));

    $("#s_ui").addEventListener("input", e=>{ root.style.setProperty("--ui", e.target.value); lsSet(LS.ui, e.target.value); });
    $("#s_glass").addEventListener("input", e=>{ root.style.setProperty("--glass", e.target.value); lsSet(LS.glass, e.target.value); });
    $("#s_accent").addEventListener("input", e=>{ root.style.setProperty("--accent", e.target.value); lsSet(LS.accent, e.target.value); });

    $("#s_bg").addEventListener("input", e=>{
      document.body.setAttribute("data-bg", e.target.value);
      $("#bgLabel").textContent = "Preset: " + e.target.value;
      lsSet(LS.bg, e.target.value);
    });

    $("#s_sun").addEventListener("input", e=>{ root.style.setProperty("--sunPower", e.target.value); lsSet(LS.sunPower, e.target.value); });

    $("#sunToggle").addEventListener("click", ()=>{
      const cur = parseInt(getComputedStyle(root).getPropertyValue("--sunOn"))===1;
      const next = cur ? 0 : 1;
      root.style.setProperty("--sunOn", next);
      lsSet(LS.sunOn, next);
      setButtons();
    });

    $("#rainToggle").addEventListener("click", ()=>{
      const cur = parseInt(getComputedStyle(root).getPropertyValue("--rainOn"))===1;
      const next = cur ? 0 : 1;
      root.style.setProperty("--rainOn", next);
      lsSet(LS.rainOn, next);
      rebuildRain();
      setButtons();
    });

    $("#s_rain").addEventListener("input", e=>{
      root.style.setProperty("--rainCount", e.target.value);
      lsSet(LS.rainCount, e.target.value);
      rebuildRain();
    });

    // ===== pages =====
    const pages = ["home","music","playlists","embed","settings"];
    function openPage(p){
      for(const x of pages){
        const el = document.getElementById("p-"+x);
        if(el) el.style.display = (x===p) ? "block" : "none";
      }
      document.querySelectorAll("#nav button").forEach(b=> b.classList.toggle("active", b.dataset.p===p));
      document.querySelectorAll("#tabs .tbtn").forEach(b=> b.classList.toggle("active", b.dataset.p===p));
      renderAll();
    }
    document.querySelectorAll("#nav button").forEach(b=> b.addEventListener("click", ()=> openPage(b.dataset.p)));
    document.querySelectorAll("#tabs .tbtn").forEach(b=> b.addEventListener("click", ()=> openPage(b.dataset.p)));
    $("#chipSettings").addEventListener("click", ()=> openPage("settings"));
    $("#chipHelp").addEventListener("click", ()=> tip(
      "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
      "–í–∫–ª–∞–¥–∫–∏: 1 2 3 4 5\n–ü–æ–∏—Å–∫: —Å–≤–µ—Ä—Ö—É\n–í –ø–ª–µ–π–ª–∏—Å—Ç: –∫–Ω–æ–ø–∫–∞ –≤ –ø–ª–µ–µ—Ä–µ –∏–ª–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç—Ä–µ–∫–∞\n–û–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫: –¥—Ä—É–≥–æ–π –∑–∞–ø—É—Å–∫ = –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è"
    ));

    // keyboard 1..5 (–µ—Å–ª–∏ –Ω–µ –ø–µ—á–∞—Ç–∞–µ—à—å –≤ input)
    document.addEventListener("keydown", (e)=>{
      const tag = (document.activeElement?.tagName||"").toLowerCase();
      const typing = tag==="input" || tag==="textarea" || document.activeElement?.isContentEditable;
      if(typing) return;
      if(e.key==="1") openPage("home");
      if(e.key==="2") openPage("music");
      if(e.key==="3") openPage("playlists");
      if(e.key==="4") openPage("embed");
      if(e.key==="5") openPage("settings");
    });

    // ===== rain build =====
    let drops = [];
    function rebuildRain(){
      drops.forEach(d=> d.remove());
      drops = [];
      const on = parseInt(getComputedStyle(root).getPropertyValue("--rainOn"))===1;
      const count = parseInt(getComputedStyle(root).getPropertyValue("--rainCount")) || 0;
      if(!on || count<=0) return;
      const w = window.innerWidth;
      for(let i=0;i<count;i++){
        const d = document.createElement("div");
        d.className = "drop";
        const left = Math.random() * w;
        const size = 8 + Math.random()*18;
        const dur  = 3.2 + Math.random()*7.6;
        const delay= Math.random()*2.8;
        const op   = 0.18 + Math.random()*0.36;
        d.style.left = left + "px";
        d.style.width = size + "px";
        d.style.height = size + "px";
        d.style.animationDuration = dur + "s";
        d.style.animationDelay = delay + "s";
        d.style.opacity = op;
        rainLayer.appendChild(d);
        drops.push(d);
      }
    }
    window.addEventListener("resize", rebuildRain);

    // ===== data model =====
    const SOURCE = { NONE:"‚Äî", LOCAL:"Local", REPO:"Repo", EMBED:"Embed" };
    const srcBadge = $("#src");
    function setSrc(s){ srcBadge.textContent = "Source: " + s; }

    function fmtBytes(bytes){
      const u=["B","KB","MB","GB"]; let i=0, n=bytes;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return (i===0? n : n.toFixed(1))+" "+u[i];
    }
    function parseName(name){
      const base = String(name||"").replace(/\.[^/.]+$/,"");
      const parts = base.split(" - ");
      if(parts.length>=2){
        return { artist: parts[0].trim()||"Unknown", title: parts.slice(1).join(" - ").trim()||"Untitled" };
      }
      return { artist:"Unknown", title: base.trim()||"Untitled" };
    }
    function hash(s){
      let h=2166136261;
      for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
      return (h>>>0).toString(16);
    }

    // ===== embeds =====
    const embedItems = [
      { id:"e1", title:"Daft Punk ‚Äî Harder Better Faster Stronger", src:"Spotify", url:"https://open.spotify.com/embed/track/5W3cjX2J3tjhG8zb6u0qHn" },
      { id:"e2", title:"Radiohead ‚Äî Creep", src:"Spotify", url:"https://open.spotify.com/embed/track/70LcF31zb1H0PyJoS1Sx1r" },
      { id:"e3", title:"Never Gonna Give You Up", src:"YouTube", url:"https://www.youtube.com/embed/dQw4w9WgXcQ" },
      { id:"e4", title:"Coldplay ‚Äî Viva La Vida", src:"YouTube", url:"https://www.youtube.com/embed/dvgZkm1xWPE" }
    ];

    // ===== IndexedDB local =====
    const DB="krs_db", VER=1, STORE="tracks";
    function openDB(){
      return new Promise((res, rej)=>{
        const req = indexedDB.open(DB, VER);
        req.onupgradeneeded=()=>{
          const db=req.result;
          if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE, { keyPath:"id" });
        };
        req.onsuccess=()=>res(req.result);
        req.onerror=()=>rej(req.error);
      });
    }
    async function dbAll(){
      const db = await openDB();
      return new Promise((res, rej)=>{
        const tx = db.transaction(STORE, "readonly");
        const rq = tx.objectStore(STORE).getAll();
        rq.onsuccess=()=>{ const r=rq.result||[]; db.close(); res(r); };
        rq.onerror=()=>{ const e=rq.error; db.close(); rej(e); };
      });
    }
    async function dbPut(obj){
      const db = await openDB();
      return new Promise((res, rej)=>{
        const tx=db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).put(obj);
        tx.oncomplete=()=>{ db.close(); res(); };
        tx.onerror=()=>{ const e=tx.error; db.close(); rej(e); };
      });
    }
    async function dbClear(){
      const db = await openDB();
      return new Promise((res, rej)=>{
        const tx=db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).clear();
        tx.oncomplete=()=>{ db.close(); res(); };
        tx.onerror=()=>{ const e=tx.error; db.close(); rej(e); };
      });
    }

    let localTracks = []; // {id,kind:"local",artist,title,size,type,createdAt,blob,name}
    let repoTracks  = []; // {id,kind:"repo",artist,title,url}
    let active = null;    // {kind,id}
    let activeSource = SOURCE.NONE;
    let activeEmbed = null;

    function stopEmbed(){ stage.innerHTML = ""; }
    function stopAudio(){
      try{ audio.pause(); audio.removeAttribute("src"); audio.load(); }catch{}
    }
    function stopAll(){
      stopEmbed(); stopAudio();
      active=null; activeEmbed=null;
      activeSource=SOURCE.NONE;
      setSrc(SOURCE.NONE);
      $("#tName").textContent = "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ";
      $("#tArtist").textContent = "–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫";
      $("#play").textContent = "‚ñ∂";
      renderAll();
    }

    function getAllTracks(){ return [...repoTracks, ...localTracks]; }
    function byRef(ref){
      if(!ref) return null;
      if(ref.kind==="local") return localTracks.find(t=>t.id===ref.id)||null;
      if(ref.kind==="repo")  return repoTracks.find(t=>t.id===ref.id)||null;
      if(ref.kind==="embed") return embedItems.find(t=>t.id===ref.id)||null;
      return null;
    }

    // ===== repo manifest loader =====
    async function loadRepo(){
      // assets/audio/manifest.json
      // format:
      // [
      //   {"artist":"...", "title":"...", "url":"assets/audio/Artist - Title.mp3"},
      //   {"url":"assets/audio/Artist - Title.mp3"} // artist/title –º–æ–∂–Ω–æ –Ω–µ –ø–∏—Å–∞—Ç—å
      // ]
      repoTracks = [];
      try{
        const r = await fetch("assets/audio/manifest.json", { cache:"no-store" });
        if(!r.ok) throw new Error("no manifest");
        const arr = await r.json();
        if(Array.isArray(arr)){
          repoTracks = arr.map((x,i)=>{
            const url = String(x.url||"").trim();
            if(!url) return null;
            const a = String(x.artist||"").trim();
            const t = String(x.title||"").trim();
            if(a && t) return { id:"r_"+i+"_"+hash(url), kind:"repo", artist:a, title:t, url };
            const parsed = parseName(url.split("/").pop() || url);
            return { id:"r_"+i+"_"+hash(url), kind:"repo", artist: parsed.artist, title: parsed.title, url };
          }).filter(Boolean);
        }
      }catch{
        repoTracks = [];
      }
    }

    async function loadLocal(){
      const raw = await dbAll();
      localTracks = raw
        .map(x=>{
          const p = parseName(x.name || (x.artist+" - "+x.title) || "Unknown - Untitled");
          return {
            id: x.id,
            kind:"local",
            artist: x.artist || p.artist,
            title: x.title  || p.title,
            name: x.name || (p.artist + " - " + p.title),
            size: x.size || 0,
            type: x.type || "audio/*",
            createdAt: x.createdAt || 0,
            blob: x.blob
          };
        })
        .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
    }

    // ===== playlists =====
    function defaultPL(){
      return {
        selected:"pl_all",
        items:[
          { id:"pl_all", name:"–í—Å–µ —Ç—Ä–µ–∫–∏", refs:[] },   // virtual
          { id:"pl_fav", name:"–ò–∑–±—Ä–∞–Ω–Ω–æ–µ", refs:[] }
        ]
      };
    }
    function plLoad(){
      try{
        const s = localStorage.getItem(LS.playlists);
        if(!s) return defaultPL();
        const x = JSON.parse(s);
        if(!x?.items?.length) return defaultPL();
        return x;
      }catch{ return defaultPL(); }
    }
    function plSave(){ localStorage.setItem(LS.playlists, JSON.stringify(pl)); }
    let pl = plLoad();

    function plGet(id){ return pl.items.find(p=>p.id===id)||null; }
    function plNormalizeAll(){
      const all = plGet("pl_all");
      if(all) all.refs = getAllTracks().map(t=>({kind:t.kind, id:t.id}));
      if(!plGet(pl.selected)) pl.selected = "pl_all";
    }
    function refKey(r){ return r.kind + ":" + r.id; }
    function plAdd(ref, plId){
      const p = plGet(plId);
      if(!p || p.id==="pl_all") return;
      const k = refKey(ref);
      if(!p.refs.some(x=>refKey(x)===k)){
        p.refs.push({kind:ref.kind, id:ref.id});
        plSave();
      }
    }
    function plRemove(ref, plId){
      const p = plGet(plId);
      if(!p || p.id==="pl_all") return;
      const k = refKey(ref);
      p.refs = p.refs.filter(x=>refKey(x)!==k);
      plSave();
    }
    function plAutoByArtist(){
      const all = getAllTracks();
      const map = new Map();
      for(const t of all){
        const a = (t.artist||"Unknown").trim() || "Unknown";
        if(!map.has(a)) map.set(a, []);
        map.get(a).push({kind:t.kind, id:t.id});
      }
      pl.items = pl.items.filter(p=>!p.id.startsWith("pl_artist_"));
      for(const [artist, refs] of map.entries()){
        pl.items.push({ id:"pl_artist_"+hash(artist), name:"–ê–≤—Ç–æ—Ä: "+artist, refs });
      }
      plSave();
    }

    // ===== playback =====
    function setNow(title, artist){
      $("#tName").textContent = title || "‚Äî";
      $("#tArtist").textContent = artist || "‚Äî";
    }

    function playEmbed(id){
      const it = embedItems.find(x=>x.id===id);
      if(!it) return;

      stopAudio();
      stage.innerHTML = "";
      const iframe = document.createElement("iframe");
      iframe.allow = "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
      iframe.loading = "lazy";
      iframe.src = it.url;
      stage.appendChild(iframe);

      active = {kind:"embed", id: it.id};
      activeEmbed = it.id;
      activeSource = SOURCE.EMBED;
      setSrc(SOURCE.EMBED);
      setNow(it.title, it.src);
      $("#play").textContent = "‚ñ∂";
      renderAll();
    }

    function playTrack(ref){
      const t = byRef(ref);
      if(!t) return;

      // ONE ACTIVE: –≤—Å–µ–≥–¥–∞ —Å—Ç–æ–ø–∞–µ–º –≤—Å—ë –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–æ–≤–æ–≥–æ
      stopEmbed();
      stopAudio();

      if(ref.kind==="repo"){
        audio.src = t.url;
        audio.play().catch(()=>{});
        active = ref;
        activeSource = SOURCE.REPO;
        setSrc(SOURCE.REPO);
        setNow(t.artist + " ‚Äî " + t.title, "Repo");
        renderAll();
        return;
      }

      if(ref.kind==="local"){
        const lt = localTracks.find(x=>x.id===ref.id);
        if(!lt) return;
        const url = URL.createObjectURL(lt.blob);
        audio.src = url;
        audio.play().catch(()=>{});
        active = ref;
        activeSource = SOURCE.LOCAL;
        setSrc(SOURCE.LOCAL);
        setNow(lt.artist + " ‚Äî " + lt.title, "Local ‚Ä¢ " + fmtBytes(lt.size));
        renderAll();
        return;
      }

      if(ref.kind==="embed"){
        playEmbed(ref.id);
      }
    }

    function navList(){
      plNormalizeAll();
      const p = plGet(pl.selected);
      if(p?.refs?.length) return p.refs;
      return getAllTracks().map(t=>({kind:t.kind, id:t.id}));
    }
    function navStep(dir){
      if(activeSource===SOURCE.EMBED){
        const idx = embedItems.findIndex(x=>x.id===activeEmbed);
        const next = (idx<0) ? 0 : (dir<0 ? (idx<=0? embedItems.length-1 : idx-1) : ((idx+1)%embedItems.length));
        playEmbed(embedItems[next].id);
        return;
      }

      const list = navList();
      if(!list.length) return;

      const cur = active ? refKey(active) : "";
      const idx = list.findIndex(r=>refKey(r)===cur);
      let ni = 0;
      if(idx>=0){
        ni = dir<0 ? (idx<=0 ? list.length-1 : idx-1) : ((idx+1)%list.length);
      }
      playTrack(list[ni]);
    }

    $("#prev").addEventListener("click", ()=> navStep(-1));
    $("#next").addEventListener("click", ()=> navStep(+1));
    $("#stop").addEventListener("click", stopAll);

    $("#play").addEventListener("click", ()=>{
      if(activeSource===SOURCE.EMBED){
        if(!activeEmbed) playEmbed(embedItems[0]?.id);
        else playEmbed(activeEmbed);
        return;
      }
      if(audio.src){
        if(audio.paused) audio.play().catch(()=>{});
        else audio.pause();
        return;
      }
      const all = getAllTracks();
      if(all.length) playTrack({kind:all[0].kind, id:all[0].id});
    });

    audio.addEventListener("play", ()=> $("#play").textContent="‚è∏");
    audio.addEventListener("pause", ()=> $("#play").textContent="‚ñ∂");
    audio.addEventListener("ended", ()=> $("#play").textContent="‚ñ∂");

    // ===== add to playlist =====
    function addToPlaylistFlow(ref){
      if(!ref){
        if(!active) return tip("–í –ø–ª–µ–π–ª–∏—Å—Ç", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫.");
        ref = active;
      }
      if(ref.kind==="embed"){
        return tip("–í –ø–ª–µ–π–ª–∏—Å—Ç", "Embed –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø–ª–µ–π–ª–∏—Å—Ç—ã. –î–æ–±–∞–≤–ª—è—é—Ç—Å—è Local/Repo.");
      }
      const names = pl.items.filter(p=>p.id!=="pl_all").map(p=>p.name);
      if(!names.length){
        return tip("–í –ø–ª–µ–π–ª–∏—Å—Ç", "–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –ø–ª–µ–π–ª–∏—Å—Ç –≤–æ –≤–∫–ª–∞–¥–∫–µ –ü–ª–µ–π–ª–∏—Å—Ç—ã.");
      }
      const chosen = prompt("–ö—É–¥–∞ –¥–æ–±–∞–≤–∏—Ç—å? –í–≤–µ–¥–∏ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:\n" + names.join("\n"));
      if(!chosen) return;
      const p = pl.items.find(x=>x.id!=="pl_all" && x.name===chosen);
      if(!p) return tip("–í –ø–ª–µ–π–ª–∏—Å—Ç", "–ü–ª–µ–π–ª–∏—Å—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω.");
      plAdd(ref, p.id);
      tip("–ì–æ—Ç–æ–≤–æ", "–î–æ–±–∞–≤–ª–µ–Ω–æ –≤: " + p.name);
      renderAll();
    }
    $("#toPl").addEventListener("click", ()=> addToPlaylistFlow(active));

    // ===== import =====
    $("#bFiles").addEventListener("click", ()=> $("#inFiles").click());
    $("#bFolder").addEventListener("click", ()=> $("#inFolder").click());
    $("#bZip").addEventListener("click", ()=> $("#inZip").click());

    $("#bImportTip").addEventListener("click", ()=> tip(
      "–ò–º–ø–æ—Ä—Ç",
      "–§–∞–π–ª—ã/–ø–∞–ø–∫–∞/zip –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ Local –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.\nRepo –±–µ—Ä—ë—Ç—Å—è –∏–∑ assets/audio/manifest.json (–µ—Å–ª–∏ –µ—Å—Ç—å)."
    ));

    $("#bClearLocal").addEventListener("click", async ()=>{
      if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å Local?")) return;
      stopAll();
      await dbClear();
      await loadLocal();
      renderAll();
    });

    async function importFiles(files, label){
      const arr = Array.from(files||[]);
      if(!arr.length) return;
      $("#importNote").textContent = "–ò–º–ø–æ—Ä—Ç: " + label + " ‚Ä¢ —Ñ–∞–π–ª–æ–≤: " + arr.length;

      let ok=0;
      for(const f of arr){
        if(!f.type.startsWith("audio/")) continue;
        const p = parseName(f.name);
        await dbPut({
          id: "t_" + crypto.randomUUID(),
          name: f.name,
          artist: p.artist,
          title: p.title,
          type: f.type || "audio/*",
          size: f.size || 0,
          createdAt: Date.now(),
          blob: f
        });
        ok++;
      }
      $("#importNote").textContent = "–ì–æ—Ç–æ–≤–æ ‚Ä¢ –¥–æ–±–∞–≤–ª–µ–Ω–æ: " + ok;
      await loadLocal();
      renderAll();
    }

    $("#inFiles").addEventListener("change", async (e)=>{ await importFiles(e.target.files, "–§–∞–π–ª—ã"); e.target.value=""; });
    $("#inFolder").addEventListener("change", async (e)=>{ await importFiles(e.target.files, "–ü–∞–ø–∫–∞"); e.target.value=""; });

    $("#inZip").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      $("#importNote").textContent = "ZIP —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞...";
      try{
        const zip = await JSZip.loadAsync(f);
        const exts = [".mp3",".wav",".ogg",".m4a",".aac",".flac"];
        const entries = [];
        for(const [path, ent] of Object.entries(zip.files)){
          if(ent.dir) continue;
          const low = path.toLowerCase();
          if(!exts.some(x=>low.endsWith(x))) continue;
          entries.push({path, ent});
        }
        let ok=0;
        for(const it of entries){
          const blob = await it.ent.async("blob");
          const name = it.path.split("/").pop() || it.path;
          const p = parseName(name);
          await dbPut({
            id: "t_" + crypto.randomUUID(),
            name,
            artist: p.artist,
            title: p.title,
            type: "audio/*",
            size: blob.size || 0,
            createdAt: Date.now(),
            blob
          });
          ok++;
        }
        $("#importNote").textContent = "ZIP –≥–æ—Ç–æ–≤ ‚Ä¢ –¥–æ–±–∞–≤–ª–µ–Ω–æ: " + ok;
        await loadLocal();
        renderAll();
      }catch{
        $("#importNote").textContent = "ZIP –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω";
      }finally{
        e.target.value="";
      }
    });

    // ===== home actions =====
    $("#goImport").addEventListener("click", ()=>{ openPage("music"); $("#inFiles").click(); });
    $("#goAuto").addEventListener("click", ()=>{
      plAutoByArtist();
      pl.selected = "pl_all";
      plSave();
      openPage("playlists");
      tip("–ê–≤—Ç–æ-–ø–ª–µ–π–ª–∏—Å—Ç—ã", "–°–æ–∑–¥–∞–Ω—ã –ø–ª–µ–π–ª–∏—Å—Ç—ã ‚Äú–ê–≤—Ç–æ—Ä: ...‚Äù –∏–∑ –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤ ‚Äú–ê–≤—Ç–æ—Ä - –ù–∞–∑–≤–∞–Ω–∏–µ‚Äù.");
      renderAll();
    });
    $("#goEmbed").addEventListener("click", ()=> openPage("embed"));
    $("#homeToMusic").addEventListener("click", ()=> openPage("music"));
    $("#homeToPlaylists").addEventListener("click", ()=> openPage("playlists"));
    $("#homeTip").addEventListener("click", ()=> tip("–ì–ª–∞–≤–Ω–∞—è", "–¢—É—Ç –±—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã. –ú—É–∑—ã–∫–∞/–ü–ª–µ–π–ª–∏—Å—Ç—ã/Embed ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏."));

    // ===== playlists actions =====
    $("#plNew").addEventListener("click", ()=>{
      const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞");
      if(!name) return;
      const id = "pl_" + crypto.randomUUID();
      pl.items.push({ id, name: name.trim(), refs: [] });
      pl.selected = id;
      plSave();
      renderAll();
    });

    $("#plRename").addEventListener("click", ()=>{
      const p = plGet(pl.selected);
      if(!p || p.id==="pl_all") return tip("–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å", "–≠—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç.");
      const name = prompt("–ù–æ–≤–æ–µ –∏–º—è", p.name);
      if(!name) return;
      p.name = name.trim();
      plSave();
      renderAll();
    });

    $("#plDelete").addEventListener("click", ()=>{
      const p = plGet(pl.selected);
      if(!p || p.id==="pl_all") return tip("–£–¥–∞–ª–∏—Ç—å", "–≠—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç.");
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç: " + p.name + " ?")) return;
      pl.items = pl.items.filter(x=>x.id!==p.id);
      pl.selected = "pl_all";
      plSave();
      renderAll();
    });

    $("#plPlayAll").addEventListener("click", ()=>{
      plNormalizeAll();
      const p = plGet(pl.selected);
      if(!p?.refs?.length) return;
      playTrack(p.refs[0]);
    });

    $("#plClear").addEventListener("click", ()=>{
      const p = plGet(pl.selected);
      if(!p || p.id==="pl_all") return;
      p.refs = [];
      plSave();
      renderAll();
    });

    $("#plTip").addEventListener("click", ()=> tip(
      "–ü–ª–µ–π–ª–∏—Å—Ç—ã",
      "–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫: –∫–Ω–æ–ø–∫–∞ ‚Äú–í –ø–ª–µ–π–ª–∏—Å—Ç‚Äù –≤ –ø–ª–µ–µ—Ä–µ –∏–ª–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç—Ä–µ–∫–∞.\n‚Äú–í—Å–µ —Ç—Ä–µ–∫–∏‚Äù ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–π."
    ));
    $("#plAbout").addEventListener("click", ()=> tip(
      "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ",
      "–ü–ª–µ–π–ª–∏—Å—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: LocalStorage.\nLocal-—Ç—Ä–µ–∫–∏: IndexedDB (–æ—Å—Ç–∞—ë—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)."
    ));

    // ===== rendering =====
    function match(t, q){
      if(!q) return true;
      const s = (t.artist+" "+t.title).toLowerCase();
      return s.includes(q);
    }

    function renderHome(){
      const note = $("#homeNote");
      const recent = $("#recent");
      const total = repoTracks.length + localTracks.length;
      note.textContent = "Repo: " + repoTracks.length + " ‚Ä¢ Local: " + localTracks.length + " ‚Ä¢ –í—Å–µ–≥–æ: " + total;

      recent.innerHTML = "";
      const items = localTracks.slice(0, 6);
      if(!items.length){
        recent.innerHTML = '<div class="note">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å —Ç—Ä–µ–∫–∏ –≤ ‚Äú–ú—É–∑—ã–∫–∞‚Äù.</div>';
        return;
      }
      for(const t of items){
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="t">${t.artist} ‚Äî ${t.title}</div>
          <div class="d">Local ‚Ä¢ ${fmtBytes(t.size)}</div>
          <div class="mini">
            <button class="btn primary">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn">–í –ø–ª–µ–π–ª–∏—Å—Ç</button>
            <button class="btn ghost">?</button>
          </div>
        `;
        el.querySelectorAll("button")[0].addEventListener("click",(e)=>{ e.stopPropagation(); playTrack({kind:"local", id:t.id}); });
        el.querySelectorAll("button")[1].addEventListener("click",(e)=>{ e.stopPropagation(); addToPlaylistFlow({kind:"local", id:t.id}); });
        el.querySelectorAll("button")[2].addEventListener("click",(e)=>{ e.stopPropagation(); tip("–¢—Ä–µ–∫", t.artist+" ‚Äî "+t.title); });
        el.addEventListener("click", ()=> playTrack({kind:"local", id:t.id}));
        recent.appendChild(el);
      }
    }

    function renderTracks(){
      const list = $("#tracks");
      const q = ($("#q").value || "").trim().toLowerCase();
      const all = getAllTracks().filter(t=> match(t, q));
      list.innerHTML = "";
      if(!all.length){
        list.innerHTML = '<div class="note">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        return;
      }
      for(const t of all){
        const isActive = active && active.kind===t.kind && active.id===t.id && (activeSource===SOURCE.LOCAL || activeSource===SOURCE.REPO);
        const el = document.createElement("div");
        el.className = "item" + (isActive ? " active":"");
        const label = (t.kind==="repo") ? ("Repo ‚Ä¢ "+t.artist) : ("Local ‚Ä¢ "+t.artist+" ‚Ä¢ "+fmtBytes(t.size||0));
        el.innerHTML = `
          <div class="t">${t.artist} ‚Äî ${t.title}</div>
          <div class="d">${label}</div>
          <div class="mini">
            <button class="btn primary">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn">–í –ø–ª–µ–π–ª–∏—Å—Ç</button>
            <button class="btn ghost">?</button>
          </div>
        `;
        el.querySelectorAll("button")[0].addEventListener("click",(e)=>{ e.stopPropagation(); playTrack({kind:t.kind, id:t.id}); });
        el.querySelectorAll("button")[1].addEventListener("click",(e)=>{ e.stopPropagation(); addToPlaylistFlow({kind:t.kind, id:t.id}); });
        el.querySelectorAll("button")[2].addEventListener("click",(e)=>{ e.stopPropagation(); tip("–¢—Ä–µ–∫", t.artist+" ‚Äî "+t.title); });
        el.addEventListener("click", ()=> playTrack({kind:t.kind, id:t.id}));
        list.appendChild(el);
      }
    }

    function renderPlaylists(){
      plNormalizeAll();

      const list = $("#plList");
      const title = $("#plTitle");
      const meta = $("#plMeta");
      const tracks = $("#plTracks");

      list.innerHTML = "";
      for(const p of pl.items){
        const el = document.createElement("div");
        el.className = "item" + (p.id===pl.selected ? " active":"");
        el.innerHTML = `<div class="t">${p.name}</div><div class="d">–¢—Ä–µ–∫–æ–≤: ${p.refs.length}</div>`;
        el.addEventListener("click", ()=>{ pl.selected = p.id; plSave(); renderAll(); });
        list.appendChild(el);
      }

      const cur = plGet(pl.selected);
      title.textContent = cur ? cur.name : "–ü–ª–µ–π–ª–∏—Å—Ç";
      meta.textContent = cur ? ("–¢—Ä–µ–∫–æ–≤: " + cur.refs.length) : "‚Äî";

      tracks.innerHTML = "";
      if(!cur || !cur.refs.length){
        tracks.innerHTML = '<div class="note">–ü—É—Å—Ç–æ</div>';
        return;
      }

      for(const ref of cur.refs){
        const t = byRef(ref);
        const el = document.createElement("div");
        if(!t){
          el.className = "item";
          el.innerHTML = `<div class="t">–¢—Ä–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</div><div class="d">${ref.kind}:${ref.id}</div>`;
          tracks.appendChild(el);
          continue;
        }
        const label = (ref.kind==="repo") ? ("Repo ‚Ä¢ "+t.artist) : ("Local ‚Ä¢ "+t.artist+" ‚Ä¢ "+fmtBytes(t.size||0));
        el.className = "item";
        el.innerHTML = `
          <div class="t">${t.artist} ‚Äî ${t.title}</div>
          <div class="d">${label}</div>
          <div class="mini">
            <button class="btn primary">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn ghost">–£–±—Ä–∞—Ç—å</button>
          </div>
        `;
        el.querySelectorAll("button")[0].addEventListener("click",(e)=>{ e.stopPropagation(); playTrack(ref); });
        el.querySelectorAll("button")[1].addEventListener("click",(e)=>{ e.stopPropagation(); plRemove(ref, cur.id); renderAll(); });
        el.addEventListener("click", ()=> playTrack(ref));
        tracks.appendChild(el);
      }
    }

    function renderEmbeds(){
      const list = $("#embedList");
      list.innerHTML = "";
      for(const it of embedItems){
        const isActive = activeSource===SOURCE.EMBED && activeEmbed===it.id;
        const el = document.createElement("div");
        el.className = "item" + (isActive ? " active":"");
        el.innerHTML = `
          <div class="t">${it.title}</div>
          <div class="d">${it.src}</div>
          <div class="mini">
            <button class="btn primary">–û—Ç–∫—Ä—ã—Ç—å</button>
            <button class="btn ghost">?</button>
          </div>
        `;
        el.querySelectorAll("button")[0].addEventListener("click",(e)=>{ e.stopPropagation(); playEmbed(it.id); });
        el.querySelectorAll("button")[1].addEventListener("click",(e)=>{ e.stopPropagation(); tip("Embed", "–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã."); });
        el.addEventListener("click", ()=> playEmbed(it.id));
        list.appendChild(el);
      }
    }

    function renderStats(){
      const pcount = pl.items.length;
      $("#stats").textContent = `–°—Ç–∞—Ç—É—Å\nRepo: ${repoTracks.length}\nLocal: ${localTracks.length}\n–ü–ª–µ–π–ª–∏—Å—Ç—ã: ${pcount}`;
      const total = repoTracks.length + localTracks.length;
      $("#importNote").textContent = `Repo: ${repoTracks.length} ‚Ä¢ Local: ${localTracks.length} ‚Ä¢ –í—Å–µ–≥–æ: ${total}`;
    }

    function renderAll(){
      renderStats();
      renderHome();
      renderTracks();
      renderPlaylists();
      renderEmbeds();
    }

    // search re-render
    $("#q").addEventListener("input", ()=> renderTracks());

    // ===== embeds don‚Äôt double play with audio =====
    // (playEmbed stops audio; playTrack stops embeds)

    // ===== init =====
    (async ()=>{
      await loadRepo();
      await loadLocal();
      rebuildRain();
      setSrc(SOURCE.NONE);
      openPage("home");
      renderAll();
    })();
  </script>
</body>
</html>
