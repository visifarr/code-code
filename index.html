<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö—Ä–∞—Å–∫–∏ –†–∞—Å—Å–≤–µ—Ç–∞ ‚Äî Music Hub</title>

  <!-- ZIP importer -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --s: 1.08;
      --density: 1.00;

      --bg:#070914;
      --panel: rgba(14,16,28,.80);
      --stroke: rgba(255,255,255,.07);
      --text:#f1f3ff;
      --muted:#a7abc8;

      --accent:#ffb347;
      --pink:#ff6fae;
      --sky:#6ecbff;

      --r: calc(18px * var(--s));
      --pad: calc(12px * var(--s));
      --gap: calc(12px * var(--s));
      --blur: 12px;

      --playerH: calc(104px * var(--s));

      --sunriseOn: 1;
      --sunrisePower: .78;

      --rainOn: 0;
      --rainCount: 28;
      --rainFront: 1;

      --bgPreset: 1;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: var(--bg);
      overflow:hidden;
    }

    .bg{ position:fixed; inset:0; z-index:0; background: var(--bg); }
    .bg::before{ content:""; position:absolute; inset:0; background: var(--bg); filter:saturate(1.10) contrast(1.04); }

    body[data-bg="1"] .bg::before{
      background:
        radial-gradient(1100px 700px at 18% -10%, color-mix(in srgb, var(--accent) 42%, transparent), transparent 60%),
        radial-gradient(900px 620px at 92% 10%, color-mix(in srgb, var(--sky) 30%, transparent), transparent 62%),
        radial-gradient(820px 540px at 50% 92%, color-mix(in srgb, var(--pink) 24%, transparent), transparent 68%),
        linear-gradient(180deg, rgba(255,255,255,.02), transparent 35%),
        var(--bg);
    }
    body[data-bg="2"] .bg::before{
      background:
        radial-gradient(980px 640px at 25% 0%, rgba(255,179,71,.32), transparent 62%),
        radial-gradient(920px 540px at 80% 10%, rgba(255,111,174,.24), transparent 62%),
        radial-gradient(980px 640px at 50% 110%, rgba(110,203,255,.18), transparent 68%),
        radial-gradient(800px 520px at 40% 55%, rgba(255,255,255,.03), transparent 70%),
        var(--bg);
    }
    body[data-bg="3"] .bg::before{
      background:
        radial-gradient(980px 640px at 12% 0%, rgba(110,203,255,.28), transparent 62%),
        radial-gradient(980px 560px at 90% 10%, rgba(255,179,71,.22), transparent 62%),
        radial-gradient(980px 700px at 50% 115%, rgba(255,111,174,.18), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.02), transparent 45%),
        var(--bg);
    }
    body[data-bg="4"] .bg::before{
      background:
        radial-gradient(1100px 700px at 30% -10%, rgba(255,111,174,.30), transparent 62%),
        radial-gradient(1000px 620px at 75% 10%, rgba(110,203,255,.20), transparent 64%),
        radial-gradient(980px 720px at 50% 120%, rgba(255,179,71,.20), transparent 68%),
        radial-gradient(900px 600px at 20% 60%, rgba(255,255,255,.03), transparent 72%),
        var(--bg);
    }
    body[data-bg="5"] .bg::before{
      background:
        radial-gradient(1100px 720px at 20% -5%, rgba(255,179,71,.26), transparent 64%),
        radial-gradient(900px 580px at 85% 8%, rgba(255,111,174,.20), transparent 64%),
        radial-gradient(880px 520px at 55% 95%, rgba(110,203,255,.20), transparent 70%),
        radial-gradient(680px 420px at 40% 40%, rgba(255,255,255,.03), transparent 72%),
        var(--bg);
    }
    body[data-bg="6"] .bg::before{
      background:
        radial-gradient(1100px 720px at 20% 0%, rgba(255,111,174,.22), transparent 64%),
        radial-gradient(960px 620px at 85% 10%, rgba(110,203,255,.22), transparent 66%),
        radial-gradient(1000px 760px at 50% 120%, rgba(255,179,71,.18), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.02), transparent 55%),
        var(--bg);
    }
    body[data-bg="7"] .bg::before{
      background:
        radial-gradient(1200px 760px at 12% 8%, rgba(110,203,255,.20), transparent 64%),
        radial-gradient(1000px 660px at 88% 8%, rgba(255,179,71,.20), transparent 66%),
        radial-gradient(980px 760px at 50% 120%, rgba(255,111,174,.18), transparent 72%),
        radial-gradient(780px 520px at 48% 48%, rgba(255,255,255,.03), transparent 74%),
        var(--bg);
    }
    body[data-bg="8"] .bg::before{
      background:
        radial-gradient(1200px 760px at 30% -10%, rgba(255,179,71,.24), transparent 64%),
        radial-gradient(1100px 700px at 70% 0%, rgba(255,111,174,.22), transparent 66%),
        radial-gradient(1100px 820px at 55% 120%, rgba(110,203,255,.18), transparent 72%),
        radial-gradient(880px 560px at 20% 65%, rgba(255,255,255,.03), transparent 74%),
        var(--bg);
    }

    .sunrise{
      position:fixed; inset:-18%;
      z-index:1; pointer-events:none;
      opacity: calc(var(--sunriseOn) * var(--sunrisePower));
      background:
        radial-gradient(900px 420px at 26% 10%, color-mix(in srgb, var(--accent) 44%, transparent), transparent 62%),
        radial-gradient(780px 380px at 72% 18%, color-mix(in srgb, var(--pink) 36%, transparent), transparent 66%),
        radial-gradient(900px 560px at 50% 100%, color-mix(in srgb, var(--sky) 28%, transparent), transparent 72%);
      animation: sunriseMove 18s ease-in-out infinite;
      filter: blur(.6px);
      transform-origin:50% 50%;
    }
    @keyframes sunriseMove{
      0%   { transform: translate3d(-1.4%, -1.0%, 0) scale(1.02); }
      50%  { transform: translate3d( 1.6%,  1.2%, 0) scale(1.05); }
      100% { transform: translate3d(-1.4%, -1.0%, 0) scale(1.02); }
    }

    .rain{
      position:fixed; inset:0;
      z-index: 2; pointer-events:none;
      opacity: calc(.95 * var(--rainOn));
      overflow:hidden;
    }
    body[data-rainfront="1"] .rain { z-index: 60; }

    .droplet{
      position:absolute; top:-12vh;
      width: 12px; height: 12px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 28% 28%, rgba(255,255,255,.62), rgba(255,255,255,.10) 42%, rgba(255,255,255,.02) 65%, transparent 72%),
        radial-gradient(circle at 70% 80%, rgba(140,220,255,.18), transparent 70%);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05),
        0 16px 40px rgba(0,0,0,.22);
      filter: blur(.2px);
      transform: translateZ(0);
      animation: dropFall linear infinite;
    }
    .droplet::after{
      content:"";
      position:absolute; left:50%; top:-18px;
      width:2px; height:20px;
      transform: translateX(-50%);
      background: linear-gradient(to bottom, transparent, rgba(200,240,255,.22), transparent);
      border-radius:999px;
      opacity:.65;
    }
    @keyframes dropFall{
      to { transform: translateY(140vh) translateZ(0); }
    }

    .app{
      position:relative; z-index:3;
      height:100%;
      display:grid;
      grid-template-columns: calc(280px * var(--s) * var(--density)) 1fr;
      grid-template-rows: 1fr var(--playerH);
      gap: var(--gap);
      padding: var(--pad);
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: 0 18px 56px rgba(0,0,0,.58);
      overflow:hidden;
    }

    .sidebar{
      padding: calc(14px * var(--s) * var(--density));
      display:flex;
      flex-direction:column;
      gap: calc(14px * var(--s) * var(--density));
    }
    .logo{
      font-weight: 950;
      font-size: calc(18px * var(--s));
      letter-spacing:.2px;
      background: linear-gradient(90deg, var(--accent), var(--pink));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      user-select:none;
    }

    .nav{
      display:flex;
      flex-direction:column;
      gap: calc(10px * var(--s) * var(--density));
    }
    .nav button{
      width:100%;
      border:none;
      background: transparent;
      color: var(--text);
      padding: calc(12px * var(--s) * var(--density)) calc(12px * var(--s) * var(--density));
      border-radius: calc(12px * var(--s));
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border: 1px solid transparent;
      font-weight: 850;
      font-size: calc(13px * var(--s));
    }
    .nav button:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.05);
    }
    .nav button.active{
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 24%, transparent), color-mix(in srgb, var(--pink) 14%, transparent));
      border-color: color-mix(in srgb, var(--accent) 34%, transparent);
    }
    .k{
      font-size: calc(11px * var(--s));
      color: rgba(255,255,255,.68);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      padding: 3px 8px;
      border-radius: 999px;
      flex:0 0 auto;
    }
    .hint{
      margin-top:auto;
      padding: calc(10px * var(--s) * var(--density));
      border-radius: calc(12px * var(--s));
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.72);
      font-weight: 650;
      font-size: calc(11px * var(--s));
      line-height: 1.35;
    }

    .main{ display:flex; flex-direction:column; }
    .topbar{
      padding: calc(12px * var(--s) * var(--density));
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex;
      gap: calc(10px * var(--s) * var(--density));
      align-items:center;
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: calc(10px * var(--s) * var(--density)) calc(12px * var(--s) * var(--density));
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 999px;
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: calc(13px * var(--s));
      font-weight: 750;
    }

    .chip{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.90);
      border-radius: 999px;
      padding: calc(9px * var(--s) * var(--density)) calc(12px * var(--s) * var(--density));
      font-weight: 900;
      font-size: calc(12px * var(--s));
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{ background: rgba(255,255,255,.07); }

    .content{
      padding: calc(14px * var(--s) * var(--density));
      overflow:auto;
    }
    .hero{
      padding: calc(18px * var(--s) * var(--density));
      border-radius: calc(18px * var(--s));
      border: 1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(760px 300px at 24% 0%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 62%),
        radial-gradient(680px 300px at 78% 0%, color-mix(in srgb, var(--sky) 18%, transparent), transparent 66%),
        rgba(255,255,255,.03);
    }
    .hero h1{ margin:0; font-size: calc(22px * var(--s)); letter-spacing:.2px; }
    .hero p{ margin: 6px 0 0; color: rgba(255,255,255,.72); font-weight: 650; font-size: calc(12px * var(--s)); }

    .grid3{
      margin-top: calc(12px * var(--s));
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: calc(12px * var(--s));
    }
    .card{
      border-radius: calc(18px * var(--s));
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      padding: calc(14px * var(--s));
      cursor:pointer;
      user-select:none;
      overflow:hidden;
      position:relative;
      min-height: calc(104px * var(--s));
    }
    .card::before{
      content:"";
      position:absolute; inset:-20%;
      background:
        radial-gradient(420px 240px at 20% 10%, color-mix(in srgb, var(--accent) 20%, transparent), transparent 60%),
        radial-gradient(420px 240px at 80% 20%, color-mix(in srgb, var(--pink) 16%, transparent), transparent 62%);
      opacity:.8;
      filter: blur(0.4px);
    }
    .card > *{ position:relative; z-index:1; }
    .card:hover{ background: rgba(255,255,255,.05); }
    .card .t{ font-weight: 950; font-size: calc(14px * var(--s)); }
    .card .d{ margin-top: 6px; color: rgba(255,255,255,.72); font-weight: 650; font-size: calc(12px * var(--s)); }

    .box{
      margin-top: calc(14px * var(--s));
      padding: calc(12px * var(--s));
      border-radius: calc(16px * var(--s));
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .box h3{ margin:0 0 10px 0; font-size: calc(14px * var(--s)); font-weight: 950; }
    .note{ margin-top: 8px; color: rgba(255,255,255,.65); font-size: calc(11px * var(--s)); line-height: 1.35; }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn2{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .btn2:hover{ background: rgba(255,255,255,.08); }
    .btn2.primary{
      background: var(--accent);
      border-color: color-mix(in srgb, var(--accent) 40%, transparent);
      color:#151515;
    }
    .btn2.ghost{
      background: rgba(255,255,255,.04);
    }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .toggle i{
      width: 38px;
      height: 22px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(0,0,0,.35);
      position: relative;
    }
    .toggle i::after{
      content:"";
      position:absolute;
      top:50%;
      left: 3px;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      transform: translateY(-50%);
      background: rgba(255,255,255,.82);
      transition: .12s ease;
    }
    .toggle.on{
      border-color: color-mix(in srgb, var(--accent) 36%, transparent);
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 16%, transparent), rgba(255,255,255,.06));
    }
    .toggle.on i{ background: color-mix(in srgb, var(--accent) 28%, rgba(255,255,255,.10)); }
    .toggle.on i::after{ left: 19px; }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      gap: calc(12px * var(--s) * var(--density));
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: calc(10px * var(--s) * var(--density));
      min-width:0;
    }

    .item{
      padding: calc(10px * var(--s) * var(--density));
      border-radius: calc(14px * var(--s));
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      cursor:pointer;
      user-select:none;
    }
    .item:hover{ background: rgba(255,255,255,.06); }
    .item.active{
      border-color: color-mix(in srgb, var(--accent) 36%, transparent);
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 16%, transparent), rgba(255,255,255,.05));
    }
    .item .t{ font-weight: 950; font-size: calc(13px * var(--s)); margin-bottom: 4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item .d{ color: rgba(255,255,255,.70); font-weight: 650; font-size: calc(11px * var(--s)); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .miniRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    .stage{
      border-radius: calc(14px * var(--s));
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      min-height: calc(240px * var(--s));
    }
    .stage iframe{
      width:100%;
      height: calc(260px * var(--s));
      border:0;
      display:block;
    }

    /* ===== PLAYER: glass ===== */
    .player{
      grid-column: 1 / span 2;
      grid-row:2;

      padding: calc(12px * var(--s) * var(--density)) calc(14px * var(--s) * var(--density));
      display:grid;
      grid-template-columns: 1.35fr 1fr 1.2fr;
      align-items:center;
      gap: calc(12px * var(--s) * var(--density));

      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)),
        radial-gradient(900px 240px at 20% 0%, rgba(255,179,71,.10), transparent 60%),
        radial-gradient(900px 240px at 80% 0%, rgba(255,111,174,.08), transparent 62%),
        rgba(14,16,28,.62);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 22px 60px rgba(0,0,0,.62);
    }

    .now{
      display:flex;
      align-items:center;
      gap: calc(10px * var(--s));
      min-width:0;
    }
    .art{
      width: calc(54px * var(--s));
      height: calc(54px * var(--s));
      border-radius: calc(14px * var(--s));
      background: linear-gradient(135deg, rgba(255,255,255,.10), color-mix(in srgb, var(--accent) 22%, transparent));
      border: 1px solid rgba(255,255,255,.12);
      flex:0 0 auto;
      position:relative;
      overflow:hidden;
    }
    .art::after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(280px 180px at 30% 20%, rgba(255,255,255,.10), transparent 55%);
      transform: rotate(8deg);
    }
    .meta{ min-width:0; }
    .track{ font-weight: 950; font-size: calc(13px * var(--s)); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .artist{ margin-top: 4px; font-weight: 750; font-size: calc(11px * var(--s)); color: rgba(255,255,255,.72); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .ctrls{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: calc(10px * var(--s));
    }
    .btn{
      width: calc(40px * var(--s));
      height: calc(40px * var(--s));
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.94);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight: 950;
      user-select:none;
      box-shadow: 0 8px 24px rgba(0,0,0,.18) inset;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn.play{
      width: calc(46px * var(--s));
      height: calc(46px * var(--s));
      background:
        radial-gradient(50% 60% at 35% 30%, rgba(255,255,255,.22), transparent 55%),
        var(--accent);
      border-color: color-mix(in srgb, var(--accent) 55%, rgba(255,255,255,.10));
      color:#151515;
    }
    .right{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
      color: rgba(255,255,255,.72);
      font-weight: 850;
      font-size: 12px;
    }
    audio{ width: 100%; max-width: 360px; }

    /* ===== Tooltip modal ===== */
    .modalWrap{
      position:fixed; inset:0;
      display:none;
      z-index: 80;
      background: rgba(0,0,0,.50);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modal{
      width: min(520px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(14,16,28,.86);
      box-shadow: 0 28px 80px rgba(0,0,0,.70);
      overflow:hidden;
    }
    .modalTop{
      padding: 14px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .modalTop .ttl{
      font-weight: 950;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .modalBody{
      padding: 14px;
      color: rgba(255,255,255,.78);
      font-weight: 650;
      line-height: 1.35;
      font-size: 12px;
    }

    .content::-webkit-scrollbar{ width: 10px; }
    .content::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }

    @media (max-width: 980px){
      body{ overflow:auto; }
      .app{ grid-template-columns: 1fr; grid-template-rows: auto 1fr var(--playerH); }
      .player{ grid-template-columns: 1fr; }
      .right{ justify-content:center; }
      .grid2{ grid-template-columns: 1fr; }
      .split{ grid-template-columns: 1fr; }
      .grid3{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body data-bg="1" data-rainfront="1">
  <div class="bg"></div>
  <div class="sunrise"></div>
  <div class="rain" id="rain"></div>

  <div class="modalWrap" id="modalWrap" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalTop">
        <div class="ttl" id="modalTitle">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
        <button class="btn2 ghost" id="modalClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <div class="app">
    <aside class="panel sidebar">
      <div class="logo">–ö—Ä–∞—Å–∫–∏ –†–∞—Å—Å–≤–µ—Ç–∞</div>
      <div class="nav" id="nav">
        <button class="active" data-page="home">üè† –ì–ª–∞–≤–Ω–∞—è <span class="k">1</span></button>
        <button data-page="music">üéß –ú—É–∑—ã–∫–∞ <span class="k">2</span></button>
        <button data-page="playlists">üìÅ –ü–ª–µ–π–ª–∏—Å—Ç—ã <span class="k">3</span></button>
        <button data-page="embed">üåê Embed <span class="k">4</span></button>
        <button data-page="settings">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ <span class="k">5</span></button>
      </div>

      <div class="hint">
        Alt+1..5 –≤–∫–ª–∞–¥–∫–∏<br>
        –ö–ª–∏–∫ –ø–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–º—É = –ø–æ–¥—Å–∫–∞–∑–∫–∞
      </div>
    </aside>

    <main class="panel main">
      <div class="topbar">
        <div class="search">
          <span>üîç</span>
          <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç—Ä–µ–∫–∞–º (local + repo)" autocomplete="off" />
        </div>
        <div class="chip" id="goSettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      </div>

      <div class="content">
        <!-- HOME -->
        <section id="page-home">
          <div class="hero">
            <h1>–ì–ª–∞–≤–Ω–∞—è</h1>
            <p>–ü–æ–¥–±–æ—Ä–∫–∏ –∏ –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</p>
          </div>

          <div class="grid3">
            <div class="card" id="homeAdd">
              <div class="t">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫–∏</div>
              <div class="d">—Ñ–∞–π–ª—ã, –ø–∞–ø–∫–∞, zip</div>
            </div>
            <div class="card" id="homeAuto">
              <div class="t">–ê–≤—Ç–æ-–ø–ª–µ–π–ª–∏—Å—Ç—ã</div>
              <div class="d">–ø–æ –∞–≤—Ç–æ—Ä—É (–∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞)</div>
            </div>
            <div class="card" id="homeEmbed">
              <div class="t">–û—Ç–∫—Ä—ã—Ç—å Embed</div>
              <div class="d">Spotify, YouTube –∏ –¥—Ä—É–≥–æ–µ</div>
            </div>
          </div>

          <div class="box">
            <h3>–°–µ–π—á–∞—Å –≤ –±–∞–∑–µ</h3>
            <div class="row">
              <button class="btn2" id="homeHelp">–ß—Ç–æ —Ç—É—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç</button>
              <button class="btn2 primary" id="homeGoMusic">–û—Ç–∫—Ä—ã—Ç—å –ú—É–∑—ã–∫–∞</button>
              <button class="btn2" id="homeGoPlaylists">–û—Ç–∫—Ä—ã—Ç—å –ü–ª–µ–π–ª–∏—Å—Ç—ã</button>
            </div>
            <div class="note" id="homeStats">‚Äî</div>
          </div>

          <div class="box">
            <h3>–ù–µ–¥–∞–≤–Ω–∏–µ —Ç—Ä–µ–∫–∏</h3>
            <div class="list" id="homeRecent"></div>
          </div>
        </section>

        <!-- MUSIC -->
        <section id="page-music" style="display:none">
          <div class="hero">
            <h1>–ú—É–∑—ã–∫–∞</h1>
            <p>Local + Repo. –ü–æ–∏—Å–∫ —Å–≤–µ—Ä—Ö—É. –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –Ω–µ –Ω—É–∂–Ω–æ, –≤—Å—ë –ø–æ –∫–ª–∏–∫—É.</p>
          </div>

          <div class="box">
            <h3>–ò–º–ø–æ—Ä—Ç</h3>
            <div class="row">
              <input id="fileInput" type="file" accept="audio/*" multiple style="display:none">
              <input id="folderInput" type="file" accept="audio/*" multiple webkitdirectory directory style="display:none">
              <input id="zipInput" type="file" accept=".zip" style="display:none">

              <button class="btn2 primary" id="btnFiles">–§–∞–π–ª—ã</button>
              <button class="btn2" id="btnFolder">–ü–∞–ø–∫–∞</button>
              <button class="btn2" id="btnZip">ZIP</button>
              <button class="btn2" id="btnClearLocal">–û—á–∏—Å—Ç–∏—Ç—å Local</button>
              <button class="btn2" id="btnHowImport">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–º–ø–æ—Ä—Ç</button>
            </div>
            <div class="note" id="importInfo">‚Äî</div>
          </div>

          <div class="box">
            <h3>–¢—Ä–µ–∫–∏</h3>
            <div class="list" id="tracksList"></div>
          </div>
        </section>

        <!-- PLAYLISTS -->
        <section id="page-playlists" style="display:none">
          <div class="hero">
            <h1>–ü–ª–µ–π–ª–∏—Å—Ç—ã</h1>
            <p>–°–æ–∑–¥–∞–π –ø–ª–µ–π–ª–∏—Å—Ç, –ø–µ—Ä–µ–∏–º–µ–Ω—É–π, –¥–æ–±–∞–≤–ª—è–π —Ç—Ä–µ–∫–∏ –∫–Ω–æ–ø–∫–æ–π.</p>
          </div>

          <div class="box">
            <h3>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            <div class="row">
              <button class="btn2 primary" id="plNew">–ù–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç</button>
              <button class="btn2" id="plRename">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
              <button class="btn2" id="plDelete">–£–¥–∞–ª–∏—Ç—å</button>
              <button class="btn2" id="plHelp">–ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
            </div>
          </div>

          <div class="grid2">
            <div class="box">
              <h3>–°–ø–∏—Å–æ–∫ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤</h3>
              <div class="list" id="plList"></div>
            </div>

            <div class="box">
              <h3 id="plTitle">–ü–ª–µ–π–ª–∏—Å—Ç</h3>
              <div class="row">
                <button class="btn2" id="plPlayAll">–ò–≥—Ä–∞—Ç—å –≤—Å—ë</button>
                <button class="btn2" id="plClear">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn2" id="plAbout">–ß—Ç–æ —ç—Ç–æ</button>
              </div>
              <div class="note" id="plMeta">‚Äî</div>
              <div class="list" id="plTracks"></div>
            </div>
          </div>
        </section>

        <!-- EMBED -->
        <section id="page-embed" style="display:none">
          <div class="hero">
            <h1>Embed</h1>
            <p>–¢—É—Ç –∂–∏–≤—É—Ç –≤—Å—Ç—Ä–æ–π–∫–∏. –û–Ω–∏ –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç Local/Repo.</p>
          </div>

          <div class="box">
            <h3>–í—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="grid2">
              <div class="list" id="embedList"></div>
              <div class="stage" id="embedStage"></div>
            </div>
            <div class="note">
              –í—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –¥–∞—é—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å play/pause, –ø–æ—ç—Ç–æ–º—É –∫–Ω–æ–ø–∫–∞ Play —Ç—É—Ç –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫.
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section id="page-settings" style="display:none">
          <div class="hero">
            <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
            <p>–ö–Ω–æ–ø–∫–∏, –ø—Ä–µ—Å–µ—Ç—ã, –¥–æ–∂–¥—å –ø–æ–≤–µ—Ä—Ö</p>
          </div>

          <div class="box">
            <h3>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
            <div class="row">
              <span style="font-weight:900;">–ú–∞—Å—à—Ç–∞–± UI</span>
              <input id="uiScale" type="range" min="0.80" max="1.95" step="0.01" value="1.08" style="width:56%;">
            </div>
            <div class="row">
              <span style="font-weight:900;">–ü–ª–æ—Ç–Ω–æ—Å—Ç—å</span>
              <input id="density" type="range" min="0.85" max="1.15" step="0.01" value="1.00" style="width:56%;">
            </div>
            <div class="row">
              <span style="font-weight:900;">–¶–≤–µ—Ç</span>
              <input id="accent" type="color" value="#ffb347" style="width:46px;height:34px;border:none;background:transparent;">
            </div>
          </div>

          <div class="box">
            <h3>–§–æ–Ω –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã</h3>
            <div class="row">
              <span style="font-weight:900;">–ü—Ä–µ—Å–µ—Ç</span>
              <input id="bgPreset" type="range" min="1" max="8" step="1" value="1" style="width:56%;">
            </div>

            <div class="row" style="margin-top:10px;">
              <div class="toggle" id="tglSunrise"><span>–†–∞—Å—Å–≤–µ—Ç</span><i></i></div>
              <div class="toggle" id="tglRain"><span>–î–æ–∂–¥—å</span><i></i></div>
              <div class="toggle on" id="tglRainFront"><span>–î–æ–∂–¥—å –ø–æ–≤–µ—Ä—Ö</span><i></i></div>
            </div>

            <div class="row">
              <span style="font-weight:900;">–°–∏–ª–∞ —Ä–∞—Å—Å–≤–µ—Ç–∞</span>
              <input id="sunrisePower" type="range" min="0" max="1" step="0.01" value="0.78" style="width:56%;">
            </div>

            <div class="row">
              <span style="font-weight:900;">–ö–∞–ø–ª–∏</span>
              <input id="rainCount" type="range" min="0" max="180" step="1" value="28" style="width:56%;">
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- PLAYER -->
    <footer class="panel player">
      <div class="now">
        <div class="art"></div>
        <div class="meta">
          <div class="track" id="trackName">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞</div>
          <div class="artist" id="artistName">–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫</div>
        </div>
      </div>

      <div class="ctrls">
        <button class="btn" id="prevBtn" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π">‚èÆ</button>
        <button class="btn play" id="playBtn" title="Play">‚ñ∂</button>
        <button class="btn" id="nextBtn" title="–°–ª–µ–¥—É—é—â–∏–π">‚è≠</button>
        <button class="btn" id="stopBtn" title="–°—Ç–æ–ø">‚èπ</button>
      </div>

      <div class="right">
        <button class="btn2" id="addToPlBtn">–í –ø–ª–µ–π–ª–∏—Å—Ç</button>
        <span id="sourceBadge">Source: ‚Äî</span>
        <div style="width:min(360px,100%);">
          <audio id="audio" controls style="display:none;"></audio>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const root = document.documentElement;

    const SOURCE = { NONE:"‚Äî", LOCAL:"Local", REPO:"Repo", EMBED:"Embed" };
    let activeSource = SOURCE.NONE;

    const audio = $("#audio");
    const embedStage = $("#embedStage");
    const modalWrap = $("#modalWrap");
    const modalTitle = $("#modalTitle");
    const modalBody = $("#modalBody");

    function esc(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function showTip(title, body){
      modalTitle.textContent = title || "–ü–æ–¥—Å–∫–∞–∑–∫–∞";
      modalBody.textContent = body || "";
      modalWrap.style.display = "flex";
    }
    function hideTip(){ modalWrap.style.display = "none"; }
    $("#modalClose").addEventListener("click", hideTip);
    modalWrap.addEventListener("click", (e)=> { if(e.target === modalWrap) hideTip(); });
    document.addEventListener("keydown", (e)=> { if(e.key === "Escape") hideTip(); });

    function loadLS(key, fallback){
      const v = localStorage.getItem(key);
      return (v === null || v === undefined) ? fallback : v;
    }
    function saveLS(key, v){ localStorage.setItem(key, String(v)); }

    function setBadge(source){
      activeSource = source;
      $("#sourceBadge").textContent = "Source: " + source;
    }

    function stopEmbed(){
      embedStage.innerHTML = "";
    }
    function stopLocalAudio(){
      audio.pause();
      audio.removeAttribute("src");
      audio.load();
      audio.style.display = "none";
    }
    function stopAll(){
      stopEmbed();
      stopLocalAudio();
      activeTrackId = null;
      setBadge(SOURCE.NONE);
      $("#trackName").textContent = "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ";
      $("#artistName").textContent = "–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫";
      renderAll();
    }

    // ---------- Pages ----------
    const pages = ["home","music","playlists","embed","settings"];
    function setActiveNav(name){
      document.querySelectorAll("#nav button").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.page === name);
      });
    }
    function openPage(name){
      pages.forEach(p=>{
        const el = document.getElementById("page-"+p);
        if(el) el.style.display = (p === name) ? "block" : "none";
      });
      setActiveNav(name);
      if(name === "music") $("#searchInput")?.focus();
      renderAll();
    }
    document.querySelectorAll("#nav button").forEach(btn=>{
      btn.addEventListener("click", () => openPage(btn.dataset.page));
    });
    $("#goSettings").addEventListener("click", () => openPage("settings"));

    document.addEventListener("keydown", (e) => {
      const tag = (document.activeElement?.tagName || "").toLowerCase();
      const typing = tag === "input" || tag === "textarea" || document.activeElement?.isContentEditable;
      if(typing && !e.altKey) return;
      if(e.key === "1") openPage("home");
      if(e.key === "2") openPage("music");
      if(e.key === "3") openPage("playlists");
      if(e.key === "4") openPage("embed");
      if(e.key === "5") openPage("settings");
    });

    // ---------- Embed ----------
    const embedItems = [
      { id:"e1", title:"Daft Punk ‚Äî Harder Better Faster Stronger", source:"Spotify", url:"https://open.spotify.com/embed/track/5W3cjX2J3tjhG8zb6u0qHn" },
      { id:"e2", title:"Radiohead ‚Äî Creep", source:"Spotify", url:"https://open.spotify.com/embed/track/70LcF31zb1H0PyJoS1Sx1r" },
      { id:"e3", title:"Never Gonna Give You Up", source:"YouTube", url:"https://www.youtube.com/embed/dQw4w9WgXcQ" },
      { id:"e4", title:"Coldplay ‚Äî Viva La Vida", source:"YouTube", url:"https://www.youtube.com/embed/dvgZkm1xWPE" },
    ];
    let activeEmbed = null;

    function renderEmbeds(){
      const list = $("#embedList");
      if(!list) return;
      list.innerHTML = "";
      embedItems.forEach(it => {
        const el = document.createElement("div");
        const isActive = (activeSource === SOURCE.EMBED && activeEmbed === it.id);
        el.className = "item" + (isActive ? " active" : "");
        el.innerHTML = `<div class="t">${esc(it.title)}</div><div class="d">${esc(it.source)}</div>`;
        el.addEventListener("click", ()=> playEmbed(it.id));
        list.appendChild(el);
      });
    }

    function playEmbed(id){
      const it = embedItems.find(x => x.id === id);
      if(!it) return;

      stopLocalAudio();
      embedStage.innerHTML = "";

      const iframe = document.createElement("iframe");
      iframe.allow = "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
      iframe.loading = "lazy";
      iframe.src = it.url;
      embedStage.appendChild(iframe);

      activeEmbed = it.id;
      activeTrackId = { kind:"embed", id: it.id };
      setBadge(SOURCE.EMBED);

      $("#trackName").textContent = it.title;
      $("#artistName").textContent = it.source;

      renderAll();
    }

    // ---------- Local tracks (IndexedDB) ----------
    const DB_NAME = "krs_music_db";
    const DB_VER = 1;
    const STORE = "tracks";

    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = () => {
          const db = req.result;
          if(!db.objectStoreNames.contains(STORE)){
            db.createObjectStore(STORE, { keyPath:"id" });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function dbPut(track){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).put(track);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { const e = tx.error; db.close(); reject(e); };
      });
    }

    async function dbGetAll(){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const req = tx.objectStore(STORE).getAll();
        req.onsuccess = () => { const r=req.result||[]; db.close(); resolve(r); };
        req.onerror = () => { const e=req.error; db.close(); reject(e); };
      });
    }

    async function dbClear(){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).clear();
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { const e=tx.error; db.close(); reject(e); };
      });
    }

    function fmtBytes(bytes){
      const u = ["B","KB","MB","GB"];
      let i=0, n=bytes;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return (i===0? n : n.toFixed(1)) + " " + u[i];
    }

    function parseArtistTitleFromName(name){
      const base = name.replace(/\.[^/.]+$/, "");
      const m = base.split(" - ");
      if(m.length >= 2){
        const artist = m[0].trim();
        const title = m.slice(1).join(" - ").trim();
        return { artist, title };
      }
      return { artist: "Unknown", title: base.trim() || "Untitled" };
    }

    let localTracks = [];  // {id, kind:"local", artist, title, type, size, createdAt, blob}
    let repoTracks = [];   // {id, kind:"repo", artist, title, url}
    let activeTrackId = null; // {kind,id}

    // ---------- Repo tracks (manifest) ----------
    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: assets/audio/manifest.json
    // [
    //   { "url": "assets/audio/Artist - Track.mp3", "artist": "Artist", "title": "Track" }
    // ]
    async function loadRepoTracks(){
      // Fallback list (–µ—Å–ª–∏ manifest.json –Ω–µ—Ç)
      const fallback = [
        // { url:"assets/audio/Artist - Track.mp3", artist:"Artist", title:"Track" },
      ];

      try{
        const res = await fetch("assets/audio/manifest.json", { cache: "no-store" });
        if(!res.ok) throw new Error("no manifest");
        const arr = await res.json();
        repoTracks = (Array.isArray(arr) ? arr : []).map((x, i) => {
          const url = String(x.url || "");
          const a = String(x.artist || "").trim();
          const t = String(x.title || "").trim();
          if(url && a && t) return { id:"r_"+i+"_"+hash(url), kind:"repo", artist:a, title:t, url };
          if(url){
            const parsed = parseArtistTitleFromName(url.split("/").pop() || url);
            return { id:"r_"+i+"_"+hash(url), kind:"repo", artist: parsed.artist, title: parsed.title, url };
          }
          return null;
        }).filter(Boolean);
        if(!repoTracks.length && fallback.length){
          repoTracks = fallback.map((x,i)=>({ id:"r_f_"+i+"_"+hash(x.url), kind:"repo", artist:x.artist, title:x.title, url:x.url }));
        }
      }catch{
        repoTracks = fallback.map((x,i)=>({ id:"r_f_"+i+"_"+hash(x.url), kind:"repo", artist:x.artist, title:x.title, url:x.url }));
      }
    }

    function hash(s){
      let h=2166136261;
      for(let i=0;i<s.length;i++){
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0).toString(16);
    }

    async function loadLocalTracks(){
      const raw = await dbGetAll();
      localTracks = raw.map(x => {
        const parsed = parseArtistTitleFromName(x.name || x.title || "Unknown - Untitled");
        return {
          id: x.id,
          kind: "local",
          artist: x.artist || parsed.artist,
          title: x.title || parsed.title,
          name: x.name || (parsed.artist + " - " + parsed.title),
          type: x.type || "audio/*",
          size: x.size || 0,
          createdAt: x.createdAt || 0,
          blob: x.blob
        };
      }).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
    }

    // ---------- Playlists ----------
    const PL_KEY = "krs_playlists_v2";
    function defaultPlaylists(){
      return {
        selected: "pl_all",
        items: [
          { id:"pl_all", name:"–í—Å–µ —Ç—Ä–µ–∫–∏", trackRefs: [] }, // –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π
          { id:"pl_fav", name:"–ò–∑–±—Ä–∞–Ω–Ω–æ–µ", trackRefs: [] },
        ]
      };
    }
    function loadPL(){
      try{
        const raw = localStorage.getItem(PL_KEY);
        if(!raw) return defaultPlaylists();
        const x = JSON.parse(raw);
        if(!x.items?.length) return defaultPlaylists();
        return x;
      }catch{
        return defaultPlaylists();
      }
    }
    function savePL(x){ localStorage.setItem(PL_KEY, JSON.stringify(x)); }
    let playlists = loadPL();

    function getPL(id){
      return playlists.items.find(p => p.id === id) || null;
    }

    function normalizeVirtualAll(){
      const all = getPL("pl_all");
      if(!all) return;
      all.trackRefs = getAllTracks().map(t => ({ kind:t.kind, id:t.id }));
    }

    function getAllTracks(){
      return [...repoTracks, ...localTracks];
    }

    function addTrackToPlaylist(ref, plId){
      const pl = getPL(plId);
      if(!pl || pl.id === "pl_all") return;
      const key = ref.kind + ":" + ref.id;
      if(!pl.trackRefs.some(r => (r.kind+":"+r.id) === key)){
        pl.trackRefs.push({ kind: ref.kind, id: ref.id });
        savePL(playlists);
      }
    }

    function removeTrackFromPlaylist(ref, plId){
      const pl = getPL(plId);
      if(!pl || pl.id === "pl_all") return;
      const key = ref.kind + ":" + ref.id;
      pl.trackRefs = pl.trackRefs.filter(r => (r.kind+":"+r.id) !== key);
      savePL(playlists);
    }

    function buildAutoPlaylistsByArtist(){
      // –°–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π–ª–∏—Å—Ç—ã –≤–∏–¥–∞ "–ê–≤—Ç–æ—Ä: X"
      const all = getAllTracks();
      const by = new Map();
      for(const t of all){
        const a = (t.artist || "Unknown").trim() || "Unknown";
        if(!by.has(a)) by.set(a, []);
        by.get(a).push({ kind:t.kind, id:t.id });
      }

      // —É–¥–∞–ª–∏–º —Å—Ç–∞—Ä—ã–µ "–ê–≤—Ç–æ—Ä: "
      playlists.items = playlists.items.filter(p => !p.id.startsWith("pl_artist_"));
      for(const [artist, refs] of by.entries()){
        const id = "pl_artist_" + hash(artist);
        playlists.items.push({ id, name: "–ê–≤—Ç–æ—Ä: " + artist, trackRefs: refs });
      }
      savePL(playlists);
    }

    // ---------- Rendering (Music list + Search) ----------
    function getTrackByRef(ref){
      if(!ref) return null;
      if(ref.kind === "local") return localTracks.find(t=>t.id===ref.id) || null;
      if(ref.kind === "repo") return repoTracks.find(t=>t.id===ref.id) || null;
      if(ref.kind === "embed") return embedItems.find(t=>t.id===ref.id) || null;
      return null;
    }

    function trackLabel(t){
      if(!t) return "";
      if(t.kind === "repo") return "Repo ‚Ä¢ " + t.artist;
      if(t.kind === "local") return "Local ‚Ä¢ " + t.artist + " ‚Ä¢ " + fmtBytes(t.size);
      return "";
    }

    function matchesQuery(t, q){
      if(!q) return true;
      const s = (t.artist + " " + t.title).toLowerCase();
      return s.includes(q);
    }

    function renderTracks(){
      const list = $("#tracksList");
      if(!list) return;

      const q = ($("#searchInput").value || "").trim().toLowerCase();

      const all = getAllTracks().filter(t => matchesQuery(t, q));
      if(!all.length){
        list.innerHTML = `<div class="note">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
        return;
      }

      list.innerHTML = "";
      for(const t of all){
        const el = document.createElement("div");
        const isActive = activeTrackId && activeTrackId.kind === t.kind && activeTrackId.id === t.id && (activeSource === SOURCE.LOCAL || activeSource === SOURCE.REPO);
        el.className = "item" + (isActive ? " active" : "");
        el.innerHTML = `
          <div class="t">${esc(t.artist)} ‚Äî ${esc(t.title)}</div>
          <div class="d">${esc(trackLabel(t))}</div>
          <div class="miniRow">
            <button class="btn2 primary" data-act="play">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn2" data-act="add">–í –ø–ª–µ–π–ª–∏—Å—Ç</button>
            <button class="btn2 ghost" data-act="info">?</button>
          </div>
        `;
        el.querySelector('[data-act="play"]').addEventListener("click", (e)=>{ e.stopPropagation(); playTrack({ kind:t.kind, id:t.id }); });
        el.querySelector('[data-act="add"]').addEventListener("click", (e)=>{ e.stopPropagation(); openAddToPlaylist({ kind:t.kind, id:t.id }); });
        el.querySelector('[data-act="info"]').addEventListener("click", (e)=>{
          e.stopPropagation();
          showTip("–¢—Ä–µ–∫", `${t.artist} ‚Äî ${t.title}`);
        });
        el.addEventListener("click", ()=> playTrack({ kind:t.kind, id:t.id }));
        list.appendChild(el);
      }
    }

    function renderHome(){
      const stats = $("#homeStats");
      const recent = $("#homeRecent");
      if(!stats || !recent) return;

      const totalRepo = repoTracks.length;
      const totalLocal = localTracks.length;
      const totalAll = totalRepo + totalLocal;
      stats.textContent = `Repo: ${totalRepo} ‚Ä¢ Local: ${totalLocal} ‚Ä¢ –í—Å–µ–≥–æ: ${totalAll}`;

      const items = [...localTracks].slice(0, 6);
      if(!items.length){
        recent.innerHTML = `<div class="note">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å —Ç—Ä–µ–∫–∏.</div>`;
        return;
      }
      recent.innerHTML = "";
      for(const t of items){
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="t">${esc(t.artist)} ‚Äî ${esc(t.title)}</div>
          <div class="d">Local ‚Ä¢ ${fmtBytes(t.size)}</div>
          <div class="miniRow">
            <button class="btn2 primary">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn2">–í –ø–ª–µ–π–ª–∏—Å—Ç</button>
          </div>
        `;
        el.querySelectorAll("button")[0].addEventListener("click", ()=> playTrack({ kind:"local", id:t.id }));
        el.querySelectorAll("button")[1].addEventListener("click", ()=> openAddToPlaylist({ kind:"local", id:t.id }));
        recent.appendChild(el);
      }
    }

    // ---------- Playback ----------
    function playTrack(ref){
      const t = getTrackByRef(ref);
      if(!t) return;

      if(ref.kind === "repo"){
        stopEmbed();
        stopLocalAudio();
        audio.src = t.url;
        audio.style.display = "block";
        audio.play().catch(()=>{});
        activeTrackId = ref;
        setBadge(SOURCE.REPO);
        $("#trackName").textContent = `${t.artist} ‚Äî ${t.title}`;
        $("#artistName").textContent = "Repo file";
        renderAll();
        return;
      }

      if(ref.kind === "local"){
        stopEmbed();
        stopLocalAudio();
        const tt = localTracks.find(x=>x.id===ref.id);
        if(!tt) return;
        const url = URL.createObjectURL(tt.blob);
        audio.src = url;
        audio.style.display = "block";
        audio.play().catch(()=>{});
        activeTrackId = ref;
        setBadge(SOURCE.LOCAL);
        $("#trackName").textContent = `${tt.artist} ‚Äî ${tt.title}`;
        $("#artistName").textContent = "Local file";
        renderAll();
        return;
      }

      if(ref.kind === "embed"){
        playEmbed(ref.id);
        return;
      }
    }

    // ---------- Player controls ----------
    function listForNav(){
      // –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–µ–∫—É—â–µ–º—É –ø–ª–µ–π–ª–∏—Å—Ç—É, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç, –∏–Ω–∞—á–µ –ø–æ –ø–æ–∏—Å–∫—É/–≤—Å–µ–º
      const pl = getPL(playlists.selected);
      if(pl && pl.trackRefs?.length){
        return pl.trackRefs.filter(r => r.kind !== "embed"); // –ø–ª–µ–µ—Ä —É–ø—Ä–∞–≤–ª—è–µ—Ç local/repo
      }
      // fallback: –≤—Å–µ —Ç—Ä–µ–∫–∏
      return getAllTracks().map(t => ({ kind:t.kind, id:t.id }));
    }

    function navStep(dir){
      if(activeSource === SOURCE.EMBED){
        // embed: prev/next –ø–æ embedItems
        const idx = embedItems.findIndex(x=>x.id===activeEmbed);
        const next = (idx < 0)
          ? 0
          : (dir < 0 ? (idx<=0 ? embedItems.length-1 : idx-1) : ((idx+1)%embedItems.length));
        playEmbed(embedItems[next].id);
        return;
      }

      const list = listForNav();
      if(!list.length) return;

      const curKey = activeTrackId ? (activeTrackId.kind + ":" + activeTrackId.id) : "";
      const idx = list.findIndex(r => (r.kind+":"+r.id) === curKey);

      let nextIdx;
      if(idx < 0) nextIdx = 0;
      else nextIdx = dir < 0 ? (idx<=0 ? list.length-1 : idx-1) : ((idx+1)%list.length);

      playTrack(list[nextIdx]);
    }

    $("#prevBtn").addEventListener("click", ()=> navStep(-1));
    $("#nextBtn").addEventListener("click", ()=> navStep(+1));

    $("#playBtn").addEventListener("click", ()=>{
      if(activeSource === SOURCE.EMBED){
        if(!activeEmbed) playEmbed(embedItems[0]?.id);
        else playEmbed(activeEmbed); // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
        return;
      }

      if(audio.style.display !== "none" && audio.src){
        if(audio.paused) audio.play().catch(()=>{});
        else audio.pause();
        return;
      }

      // —Å—Ç–∞—Ä—Ç: –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π ‚Äî –∏–≥—Ä–∞—Ç—å –µ–≥–æ, –∏–Ω–∞—á–µ –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫
      if(activeTrackId && activeTrackId.kind !== "embed"){
        playTrack(activeTrackId);
        return;
      }

      const all = getAllTracks();
      if(all.length) playTrack({ kind: all[0].kind, id: all[0].id });
    });

    $("#stopBtn").addEventListener("click", ()=>{
      stopAll();
      $("#playBtn").textContent = "‚ñ∂";
    });

    audio.addEventListener("play", ()=> $("#playBtn").textContent = "‚è∏");
    audio.addEventListener("pause", ()=> $("#playBtn").textContent = "‚ñ∂");
    audio.addEventListener("ended", ()=> $("#playBtn").textContent = "‚ñ∂");

    // ---------- Add to playlist (from player + list) ----------
    function openAddToPlaylist(ref){
      if(!ref){
        if(!activeTrackId) return;
        ref = activeTrackId;
      }
      if(ref.kind === "embed"){
        showTip("–í –ø–ª–µ–π–ª–∏—Å—Ç", "Embed —Ç—Ä–µ–∫–∏ —Å–µ–π—á–∞—Å –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –ø–ª–µ–π–ª–∏—Å—Ç—ã. –î–æ–±–∞–≤–ª—è—é—Ç—Å—è Local/Repo.");
        return;
      }

      const names = playlists.items.filter(p => p.id !== "pl_all").map(p => p.name);
      if(!names.length){
        showTip("–í –ø–ª–µ–π–ª–∏—Å—Ç", "–°–æ–∑–¥–∞–π –ø–ª–µ–π–ª–∏—Å—Ç –≤–æ –≤–∫–ª–∞–¥–∫–µ –ü–ª–µ–π–ª–∏—Å—Ç—ã.");
        return;
      }

      // –º–∞–ª–µ–Ω—å–∫–∏–π –≤—ã–±–æ—Ä —á–µ—Ä–µ–∑ prompt
      const plNames = playlists.items.filter(p => p.id !== "pl_all").map(p => p.name);
      const chosen = prompt("–ö—É–¥–∞ –¥–æ–±–∞–≤–∏—Ç—å. –í–≤–µ–¥–∏ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞:\n" + plNames.join("\n"));
      if(!chosen) return;

      const pl = playlists.items.find(p => p.id !== "pl_all" && p.name === chosen);
      if(!pl){
        showTip("–í –ø–ª–µ–π–ª–∏—Å—Ç", "–ù–µ –Ω–∞–π–¥–µ–Ω –ø–ª–µ–π–ª–∏—Å—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º.");
        return;
      }
      addTrackToPlaylist(ref, pl.id);
      showTip("–ì–æ—Ç–æ–≤–æ", "–î–æ–±–∞–≤–ª–µ–Ω–æ –≤: " + pl.name);
      renderAll();
    }

    $("#addToPlBtn").addEventListener("click", ()=> openAddToPlaylist(null));

    // ---------- Playlists UI ----------
    function renderPlaylists(){
      normalizeVirtualAll();

      const list = $("#plList");
      const title = $("#plTitle");
      const meta = $("#plMeta");
      const tracks = $("#plTracks");
      if(!list || !title || !meta || !tracks) return;

      // ensure selected exists
      if(!getPL(playlists.selected)) playlists.selected = "pl_all";

      list.innerHTML = "";
      for(const p of playlists.items){
        const el = document.createElement("div");
        const active = (p.id === playlists.selected);
        el.className = "item" + (active ? " active" : "");
        el.innerHTML = `<div class="t">${esc(p.name)}</div><div class="d">–¢—Ä–µ–∫–æ–≤: ${p.trackRefs.length}</div>`;
        el.addEventListener("click", ()=>{
          playlists.selected = p.id;
          savePL(playlists);
          renderPlaylists();
        });
        list.appendChild(el);
      }

      const pl = getPL(playlists.selected);
      title.textContent = pl ? pl.name : "–ü–ª–µ–π–ª–∏—Å—Ç";
      meta.textContent = pl ? `–¢—Ä–µ–∫–æ–≤: ${pl.trackRefs.length}` : "‚Äî";

      tracks.innerHTML = "";
      if(!pl || !pl.trackRefs.length){
        tracks.innerHTML = `<div class="note">–ü—É—Å—Ç–æ</div>`;
        return;
      }

      for(const ref of pl.trackRefs){
        const t = getTrackByRef(ref);
        const el = document.createElement("div");
        el.className = "item";
        if(!t){
          el.innerHTML = `<div class="t">–¢—Ä–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</div><div class="d">${esc(ref.kind + ":" + ref.id)}</div>`;
          tracks.appendChild(el);
          continue;
        }
        el.innerHTML = `
          <div class="t">${esc(t.artist)} ‚Äî ${esc(t.title)}</div>
          <div class="d">${esc(trackLabel(t))}</div>
          <div class="miniRow">
            <button class="btn2 primary">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn2">–£–±—Ä–∞—Ç—å</button>
          </div>
        `;
        el.querySelectorAll("button")[0].addEventListener("click", ()=> playTrack(ref));
        el.querySelectorAll("button")[1].addEventListener("click", ()=>{
          removeTrackFromPlaylist(ref, pl.id);
          renderPlaylists();
        });
        tracks.appendChild(el);
      }
    }

    $("#plNew").addEventListener("click", ()=>{
      const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞");
      if(!name) return;
      const id = "pl_" + crypto.randomUUID();
      playlists.items.push({ id, name: name.trim(), trackRefs: [] });
      playlists.selected = id;
      savePL(playlists);
      renderPlaylists();
    });

    $("#plRename").addEventListener("click", ()=>{
      const pl = getPL(playlists.selected);
      if(!pl || pl.id === "pl_all"){ showTip("–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å", "–≠—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç."); return; }
      const name = prompt("–ù–æ–≤–æ–µ –∏–º—è", pl.name);
      if(!name) return;
      pl.name = name.trim();
      savePL(playlists);
      renderPlaylists();
    });

    $("#plDelete").addEventListener("click", ()=>{
      const pl = getPL(playlists.selected);
      if(!pl || pl.id === "pl_all"){ showTip("–£–¥–∞–ª–∏—Ç—å", "–≠—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç."); return; }
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç: " + pl.name + " ?")) return;
      playlists.items = playlists.items.filter(x => x.id !== pl.id);
      playlists.selected = "pl_all";
      savePL(playlists);
      renderPlaylists();
    });

    $("#plPlayAll").addEventListener("click", ()=>{
      const pl = getPL(playlists.selected);
      if(!pl || !pl.trackRefs.length) return;
      playTrack(pl.trackRefs[0]);
    });

    $("#plClear").addEventListener("click", ()=>{
      const pl = getPL(playlists.selected);
      if(!pl || pl.id === "pl_all") return;
      pl.trackRefs = [];
      savePL(playlists);
      renderPlaylists();
    });

    $("#plHelp").addEventListener("click", ()=> showTip("–ü–ª–µ–π–ª–∏—Å—Ç—ã", "–î–æ–±–∞–≤–ª—è–π —Ç—Ä–µ–∫–∏ –∫–Ω–æ–ø–∫–æ–π '–í –ø–ª–µ–π–ª–∏—Å—Ç' –≤ –ú—É–∑—ã–∫–µ –∏–ª–∏ –≤ –Ω–∏–∂–Ω–µ–º –±–∞—Ä–µ. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å ‚Äî —Å–≤–µ—Ä—Ö—É."));
    $("#plAbout").addEventListener("click", ()=> showTip("–ß—Ç–æ —ç—Ç–æ", "–ü–ª–µ–π–ª–∏—Å—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –î–ª—è –æ–±—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –≤—Å–µ–º –±—É–¥–µ—Ç –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä/–±–∞–∑–∞."));

    // ---------- Import UI ----------
    const fileInput = $("#fileInput");
    const folderInput = $("#folderInput");
    const zipInput = $("#zipInput");

    $("#btnFiles").addEventListener("click", ()=> fileInput.click());
    $("#btnFolder").addEventListener("click", ()=> folderInput.click());
    $("#btnZip").addEventListener("click", ()=> zipInput.click());
    $("#btnHowImport").addEventListener("click", ()=> showTip("–ò–º–ø–æ—Ä—Ç", "–§–∞–π–ª—ã –∏ –ø–∞–ø–∫–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ Local (—ç—Ç–æ—Ç –±—Ä–∞—É–∑–µ—Ä). ZIP —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –±–µ—Ä—É—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã."));
    $("#btnClearLocal").addEventListener("click", async ()=>{
      if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å Local?")) return;
      stopAll();
      await dbClear();
      await loadLocalTracks();
      renderAll();
    });

    async function importFiles(files, label){
      const arr = Array.from(files || []);
      if(!arr.length) return;
      $("#importInfo").textContent = "–ò–º–ø–æ—Ä—Ç: " + label + " ‚Ä¢ —Ñ–∞–π–ª–æ–≤: " + arr.length;

      let ok = 0;
      for(const f of arr){
        if(!f.type.startsWith("audio/")) continue;
        const parsed = parseArtistTitleFromName(f.name);
        const id = "t_" + crypto.randomUUID();
        await dbPut({
          id,
          name: f.name,
          artist: parsed.artist,
          title: parsed.title,
          type: f.type || "audio/*",
          size: f.size || 0,
          createdAt: Date.now(),
          blob: f
        });
        ok++;
      }
      $("#importInfo").textContent = "–ò–º–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤ ‚Ä¢ –¥–æ–±–∞–≤–ª–µ–Ω–æ: " + ok;
      await loadLocalTracks();
      renderAll();
    }

    fileInput.addEventListener("change", async ()=> {
      await importFiles(fileInput.files, "–§–∞–π–ª—ã");
      fileInput.value = "";
    });

    folderInput.addEventListener("change", async ()=> {
      await importFiles(folderInput.files, "–ü–∞–ø–∫–∞");
      folderInput.value = "";
    });

    zipInput.addEventListener("change", async ()=> {
      const f = zipInput.files?.[0];
      if(!f) return;
      $("#importInfo").textContent = "ZIP —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞...";
      try{
        const zip = await JSZip.loadAsync(f);
        const audioFiles = [];
        const exts = [".mp3",".wav",".ogg",".m4a",".aac",".flac"];
        for(const [path, entry] of Object.entries(zip.files)){
          if(entry.dir) continue;
          const low = path.toLowerCase();
          if(!exts.some(e=>low.endsWith(e))) continue;
          audioFiles.push({ path, entry });
        }
        let ok = 0;
        for(const af of audioFiles){
          const blob = await af.entry.async("blob");
          const name = af.path.split("/").pop() || af.path;
          const typeGuess = "audio/*";
          const parsed = parseArtistTitleFromName(name);
          const id = "t_" + crypto.randomUUID();
          await dbPut({
            id,
            name,
            artist: parsed.artist,
            title: parsed.title,
            type: typeGuess,
            size: blob.size || 0,
            createdAt: Date.now(),
            blob
          });
          ok++;
        }
        $("#importInfo").textContent = "ZIP –≥–æ—Ç–æ–≤ ‚Ä¢ –¥–æ–±–∞–≤–ª–µ–Ω–æ: " + ok;
        await loadLocalTracks();
        renderAll();
      }catch{
        $("#importInfo").textContent = "ZIP –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω";
      }finally{
        zipInput.value = "";
      }
    });

    // ---------- Home actions ----------
    $("#homeAdd").addEventListener("click", ()=> { openPage("music"); fileInput.click(); });
    $("#homeAuto").addEventListener("click", ()=>{
      buildAutoPlaylistsByArtist();
      playlists.selected = "pl_all";
      savePL(playlists);
      openPage("playlists");
      showTip("–ê–≤—Ç–æ-–ø–ª–µ–π–ª–∏—Å—Ç—ã", "–°–æ–∑–¥–∞–Ω—ã –ø–ª–µ–π–ª–∏—Å—Ç—ã '–ê–≤—Ç–æ—Ä: ...' –∏–∑ –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤ –≤–∏–¥–∞ '–ê–≤—Ç–æ—Ä - –ù–∞–∑–≤–∞–Ω–∏–µ'.");
      renderAll();
    });
    $("#homeEmbed").addEventListener("click", ()=> openPage("embed"));
    $("#homeHelp").addEventListener("click", ()=> showTip("–ì–ª–∞–≤–Ω–∞—è", "–¢—É—Ç –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ –Ω–µ–¥–∞–≤–Ω–∏–µ Local —Ç—Ä–µ–∫–∏."));
    $("#homeGoMusic").addEventListener("click", ()=> openPage("music"));
    $("#homeGoPlaylists").addEventListener("click", ()=> openPage("playlists"));

    // ---------- Search ----------
    $("#searchInput").addEventListener("input", ()=> {
      renderTracks();
    });

    // ---------- Settings ----------
    const s0 = loadLS("krs_s", getComputedStyle(root).getPropertyValue("--s").trim() || "1.08");
    const d0 = loadLS("krs_density", getComputedStyle(root).getPropertyValue("--density").trim() || "1.00");
    const a0 = loadLS("krs_accent", getComputedStyle(root).getPropertyValue("--accent").trim() || "#ffb347");
    const b0 = loadLS("krs_bg", document.body.getAttribute("data-bg") || "1");
    const sunOn0 = loadLS("krs_sunOn", getComputedStyle(root).getPropertyValue("--sunriseOn").trim() || "1");
    const sunPow0 = loadLS("krs_sunPow", getComputedStyle(root).getPropertyValue("--sunrisePower").trim() || "0.78");
    const rainOn0 = loadLS("krs_rainOn", getComputedStyle(root).getPropertyValue("--rainOn").trim() || "0");
    const rainCount0 = loadLS("krs_rainCount", getComputedStyle(root).getPropertyValue("--rainCount").trim() || "28");
    const rainFront0 = loadLS("krs_rainFront", document.body.getAttribute("data-rainfront") || "1");

    root.style.setProperty("--s", s0);
    root.style.setProperty("--density", d0);
    root.style.setProperty("--accent", a0);
    document.body.setAttribute("data-bg", b0);
    root.style.setProperty("--sunriseOn", sunOn0);
    root.style.setProperty("--sunrisePower", sunPow0);
    root.style.setProperty("--rainOn", rainOn0);
    root.style.setProperty("--rainCount", rainCount0);
    document.body.setAttribute("data-rainfront", rainFront0);

    $("#uiScale").value = s0;
    $("#density").value = d0;
    $("#accent").value = a0;
    $("#bgPreset").value = b0;
    $("#sunrisePower").value = sunPow0;
    $("#rainCount").value = rainCount0;

    function setToggle(el, on){ el.classList.toggle("on", !!on); }
    const tglSunrise = $("#tglSunrise");
    const tglRain = $("#tglRain");
    const tglRainFront = $("#tglRainFront");
    setToggle(tglSunrise, Number(sunOn0)===1);
    setToggle(tglRain, Number(rainOn0)===1);
    setToggle(tglRainFront, String(rainFront0)==="1");

    $("#uiScale").addEventListener("input", e=>{ root.style.setProperty("--s", e.target.value); saveLS("krs_s", e.target.value); });
    $("#density").addEventListener("input", e=>{ root.style.setProperty("--density", e.target.value); saveLS("krs_density", e.target.value); });
    $("#accent").addEventListener("input", e=>{ root.style.setProperty("--accent", e.target.value); saveLS("krs_accent", e.target.value); });
    $("#bgPreset").addEventListener("input", e=>{ document.body.setAttribute("data-bg", e.target.value); saveLS("krs_bg", e.target.value); });
    $("#sunrisePower").addEventListener("input", e=>{ root.style.setProperty("--sunrisePower", e.target.value); saveLS("krs_sunPow", e.target.value); });

    tglSunrise.addEventListener("click", ()=>{
      const cur = Number(getComputedStyle(root).getPropertyValue("--sunriseOn").trim())===1;
      const next = cur ? 0 : 1;
      root.style.setProperty("--sunriseOn", next);
      saveLS("krs_sunOn", next);
      setToggle(tglSunrise, next===1);
    });

    tglRain.addEventListener("click", ()=>{
      const cur = Number(getComputedStyle(root).getPropertyValue("--rainOn").trim())===1;
      const next = cur ? 0 : 1;
      root.style.setProperty("--rainOn", next);
      saveLS("krs_rainOn", next);
      setToggle(tglRain, next===1);
      rebuildDrops();
    });

    tglRainFront.addEventListener("click", ()=>{
      const cur = document.body.getAttribute("data-rainfront")==="1";
      const next = cur ? "0" : "1";
      document.body.setAttribute("data-rainfront", next);
      saveLS("krs_rainFront", next);
      setToggle(tglRainFront, next==="1");
    });

    $("#rainCount").addEventListener("input", e=>{
      root.style.setProperty("--rainCount", e.target.value);
      saveLS("krs_rainCount", e.target.value);
      rebuildDrops();
    });

    // ---------- Rain ----------
    const rainLayer = $("#rain");
    let drops = [];
    function rebuildDrops(){
      drops.forEach(d => d.remove());
      drops = [];
      const on = Number(getComputedStyle(root).getPropertyValue("--rainOn").trim())===1;
      const count = Number(getComputedStyle(root).getPropertyValue("--rainCount").trim()) || 0;
      if(!on || count<=0) return;
      const w = window.innerWidth;
      for(let i=0;i<count;i++){
        const d = document.createElement("div");
        d.className = "droplet";
        const left = Math.random()*w;
        const size = 6 + Math.random()*16;
        const dur  = 3.2 + Math.random()*7.2;
        const delay= Math.random()*2.4;
        const op   = 0.16 + Math.random()*0.34;
        d.style.left = left + "px";
        d.style.width = size + "px";
        d.style.height = size + "px";
        d.style.animationDuration = dur + "s";
        d.style.animationDelay = delay + "s";
        d.style.opacity = op;
        rainLayer.appendChild(d);
        drops.push(d);
      }
    }
    window.addEventListener("resize", rebuildDrops);

    // ---------- Add-to-playlist in player ----------
    $("#addToPlBtn").addEventListener("click", ()=> {
      if(!activeTrackId) { showTip("–í –ø–ª–µ–π–ª–∏—Å—Ç", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫."); return; }
      openAddToPlaylist(activeTrackId);
    });

    // ---------- Render all ----------
    async function renderAll(){
      renderEmbeds();
      normalizeVirtualAll();
      renderPlaylists();
      renderTracks();
      renderHome();
      updateImportInfo();
    }

    function updateImportInfo(){
      const el = $("#importInfo");
      if(!el) return;
      el.textContent = `Repo: ${repoTracks.length} ‚Ä¢ Local: ${localTracks.length}`;
      const hs = $("#homeStats");
      if(hs) hs.textContent = `Repo: ${repoTracks.length} ‚Ä¢ Local: ${localTracks.length} ‚Ä¢ –í—Å–µ–≥–æ: ${repoTracks.length + localTracks.length}`;
    }

    // ---------- Init ----------
    (async ()=>{
      await loadRepoTracks();
      await loadLocalTracks();
      rebuildDrops();
      setBadge(SOURCE.NONE);
      openPage("home");
      renderAll();
    })();
  </script>
</body>
</html>
