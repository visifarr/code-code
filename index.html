<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö—Ä–∞—Å–∫–∏ –†–∞—Å—Å–≤–µ—Ç–∞ ‚Äî –Ω–æ–≤—ã–π –¥–∏–∑–∞–π–Ω</title>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      /* ====== BIG UI by default (x2‚Äìx3 feeling) ====== */
      --ui: 2.10;
      --accent: #ffb347;

      /* background presets 1..12 */
      --bgPreset: 3;

      /* glass + depth */
      --glass: .58;
      --stroke: rgba(255,255,255,.13);
      --shadow: 0 30px 120px rgba(0,0,0,.70);

      /* sunrise + rain */
      --sunOn: 1;
      --sunPower: .90;
      --rainOn: 1;
      --rainCount: 120;
      --rainSize: 1.15;
      --rainSpeed: 1.00;

      /* motion */
      --motion: 1; /* 0/1 */

      /* base */
      --bg0: #060815;
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.72);

      /* sizing */
      --pad: calc(18px * var(--ui));
      --gap: calc(16px * var(--ui));
      --r1:  calc(26px * var(--ui));
      --r2:  calc(18px * var(--ui));
      --r3:  calc(14px * var(--ui));
      --blur: 18px;

      --fs0: calc(12px * var(--ui));
      --fs1: calc(14px * var(--ui));
      --fs2: calc(16px * var(--ui));
      --fs3: calc(20px * var(--ui));
      --fs4: calc(28px * var(--ui));
      --fs5: calc(40px * var(--ui));

      /* layout */
      --topH:    calc(86px * var(--ui));
      --dockH:   calc(92px * var(--ui));
      --playerH: calc(156px * var(--ui));
      --leftW:   calc(400px * var(--ui));
      --rightW:  calc(420px * var(--ui));
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background: var(--bg0);
      overflow:hidden;
    }

    /* ===== BACKGROUND (12 presets) ===== */
    .bg{ position:fixed; inset:0; z-index:0; background: var(--bg0); }
    .bg::before{
      content:"";
      position:absolute; inset:-12%;
      opacity:1;
      filter: saturate(1.18) contrast(1.08);
      background:
        radial-gradient(1200px 760px at 14% -10%, rgba(255,179,71,.30), transparent 64%),
        radial-gradient(1100px 720px at 86% 0%, rgba(255,111,174,.22), transparent 66%),
        radial-gradient(1100px 820px at 55% 120%, rgba(110,203,255,.20), transparent 72%),
        radial-gradient(900px 560px at 20% 65%, rgba(255,255,255,.03), transparent 74%),
        var(--bg0);
      transform: translateZ(0);
    }

    body[data-bg="1"] .bg::before{ background:
      radial-gradient(1400px 900px at 18% -14%, rgba(255,179,71,.34), transparent 66%),
      radial-gradient(1200px 820px at 88% 2%, rgba(255,111,174,.24), transparent 70%),
      radial-gradient(1200px 920px at 52% 118%, rgba(110,203,255,.18), transparent 78%),
      radial-gradient(900px 560px at 32% 60%, rgba(255,255,255,.03), transparent 78%),
      #050716;
    }
    body[data-bg="2"] .bg::before{ background:
      radial-gradient(1500px 980px at 10% 0%, rgba(255,111,174,.30), transparent 68%),
      radial-gradient(1300px 900px at 92% 6%, rgba(110,203,255,.22), transparent 74%),
      radial-gradient(1300px 980px at 55% 122%, rgba(255,179,71,.16), transparent 80%),
      radial-gradient(900px 560px at 44% 56%, rgba(255,255,255,.03), transparent 80%),
      #050716;
    }
    body[data-bg="3"] .bg::before{ background:
      radial-gradient(1600px 1000px at 22% -10%, rgba(110,203,255,.26), transparent 70%),
      radial-gradient(1400px 940px at 88% 4%, rgba(255,179,71,.20), transparent 78%),
      radial-gradient(1300px 980px at 52% 124%, rgba(255,111,174,.14), transparent 82%),
      radial-gradient(900px 560px at 34% 60%, rgba(255,255,255,.03), transparent 82%),
      #050716;
    }
    body[data-bg="4"] .bg::before{ background:
      radial-gradient(1600px 1000px at 18% -12%, rgba(255,179,71,.20), transparent 76%),
      radial-gradient(1400px 940px at 88% 0%, rgba(110,203,255,.18), transparent 80%),
      radial-gradient(1300px 980px at 55% 124%, rgba(255,111,174,.12), transparent 84%),
      radial-gradient(900px 560px at 36% 62%, rgba(255,255,255,.03), transparent 82%),
      #050716;
    }
    body[data-bg="5"] .bg::before{ background:
      radial-gradient(1700px 1100px at 20% -14%, rgba(255,111,174,.18), transparent 78%),
      radial-gradient(1500px 980px at 88% 2%, rgba(255,179,71,.16), transparent 82%),
      radial-gradient(1300px 980px at 55% 124%, rgba(110,203,255,.12), transparent 86%),
      radial-gradient(900px 560px at 30% 60%, rgba(255,255,255,.03), transparent 84%),
      #050716;
    }
    body[data-bg="6"] .bg::before{ background:
      radial-gradient(1700px 1100px at 20% -14%, rgba(255,179,71,.16), transparent 78%),
      radial-gradient(1500px 980px at 88% 2%, rgba(110,203,255,.16), transparent 82%),
      radial-gradient(1300px 980px at 55% 124%, rgba(255,111,174,.12), transparent 86%),
      radial-gradient(900px 560px at 40% 60%, rgba(255,255,255,.03), transparent 84%),
      #040615;
    }
    body[data-bg="7"] .bg::before{ background:
      radial-gradient(1800px 1200px at 18% -12%, rgba(110,203,255,.16), transparent 80%),
      radial-gradient(1500px 980px at 90% 2%, rgba(255,111,174,.14), transparent 84%),
      radial-gradient(1400px 1040px at 55% 124%, rgba(255,179,71,.10), transparent 88%),
      radial-gradient(900px 560px at 34% 60%, rgba(255,255,255,.03), transparent 86%),
      #040615;
    }
    body[data-bg="8"] .bg::before{ background:
      radial-gradient(1800px 1200px at 16% -12%, rgba(255,111,174,.14), transparent 82%),
      radial-gradient(1600px 1060px at 90% 0%, rgba(110,203,255,.14), transparent 86%),
      radial-gradient(1400px 1040px at 55% 124%, rgba(255,179,71,.10), transparent 90%),
      radial-gradient(900px 560px at 34% 60%, rgba(255,255,255,.03), transparent 86%),
      #040615;
    }
    body[data-bg="9"] .bg::before{ background:
      radial-gradient(1900px 1280px at 16% 0%, rgba(255,179,71,.14), transparent 84%),
      radial-gradient(1700px 1140px at 92% 4%, rgba(255,111,174,.12), transparent 88%),
      radial-gradient(1500px 1100px at 52% 124%, rgba(110,203,255,.08), transparent 92%),
      radial-gradient(900px 560px at 34% 60%, rgba(255,255,255,.03), transparent 86%),
      #040615;
    }
    body[data-bg="10"] .bg::before{ background:
      radial-gradient(1900px 1280px at 16% 0%, rgba(110,203,255,.14), transparent 84%),
      radial-gradient(1700px 1140px at 92% 4%, rgba(255,179,71,.12), transparent 88%),
      radial-gradient(1500px 1100px at 52% 124%, rgba(255,111,174,.08), transparent 92%),
      radial-gradient(900px 560px at 34% 60%, rgba(255,255,255,.03), transparent 86%),
      #040615;
    }
    body[data-bg="11"] .bg::before{ background:
      radial-gradient(2000px 1360px at 18% -10%, rgba(255,111,174,.12), transparent 86%),
      radial-gradient(1800px 1200px at 92% 2%, rgba(255,179,71,.10), transparent 90%),
      radial-gradient(1600px 1200px at 52% 124%, rgba(110,203,255,.08), transparent 94%),
      radial-gradient(900px 560px at 34% 60%, rgba(255,255,255,.03), transparent 86%),
      #030514;
    }
    body[data-bg="12"] .bg::before{ background:
      radial-gradient(2100px 1400px at 18% -10%, rgba(255,179,71,.10), transparent 88%),
      radial-gradient(1800px 1200px at 92% 2%, rgba(110,203,255,.10), transparent 92%),
      radial-gradient(1600px 1200px at 52% 124%, rgba(255,111,174,.08), transparent 96%),
      radial-gradient(900px 560px at 34% 60%, rgba(255,255,255,.03), transparent 86%),
      #030514;
    }

    /* ===== SUNRISE LAYER ===== */
    .sun{
      position:fixed; inset:-18%;
      z-index:1; pointer-events:none;
      opacity: calc(var(--sunOn) * var(--sunPower));
      background:
        radial-gradient(1100px 520px at 24% 10%, color-mix(in srgb, var(--accent) 56%, transparent), transparent 64%),
        radial-gradient(920px 480px at 78% 18%, rgba(255,111,174,.34), transparent 68%),
        radial-gradient(1200px 720px at 50% 106%, rgba(110,203,255,.24), transparent 74%);
      filter: blur(.2px);
      transform: translateZ(0);
      animation: sunMove 20s ease-in-out infinite;
      animation-play-state: calc(var(--motion) * 1) == 1 ? running : paused;
    }
    @keyframes sunMove{
      0%{ transform: translate3d(-1.8%,-1.2%,0) scale(1.03); }
      50%{ transform: translate3d( 2.0%, 1.6%,0) scale(1.06); }
      100%{ transform: translate3d(-1.8%,-1.2%,0) scale(1.03); }
    }

    /* ===== RAIN (ON TOP OF UI) ===== */
    .rain{
      position:fixed; inset:0;
      z-index:90; pointer-events:none;
      opacity: calc(var(--rainOn) * .95);
      overflow:hidden;
    }
    .drop{
      position:absolute;
      top:-18vh;
      width: calc(18px * var(--rainSize));
      height: calc(18px * var(--rainSize));
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 28%, rgba(255,255,255,.74), rgba(255,255,255,.14) 46%, rgba(255,255,255,.03) 72%, transparent 78%),
        radial-gradient(circle at 70% 80%, rgba(140,220,255,.20), transparent 70%);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06),
        0 18px 44px rgba(0,0,0,.26);
      transform: translateZ(0);
      animation: dropFall linear infinite;
    }
    .drop::after{
      content:"";
      position:absolute;
      left:50%;
      top:-28px;
      width:2px;
      height:30px;
      transform: translateX(-50%);
      background: linear-gradient(to bottom, transparent, rgba(200,240,255,.26), transparent);
      border-radius:999px;
      opacity:.65;
    }
    @keyframes dropFall{
      to{ transform: translateY(160vh) translateZ(0); }
    }

    /* ===== GLASS ===== */
    .glass{
      background: rgba(14,16,28, var(--glass));
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .glass::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(900px 280px at 18% -10%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 280px at 88% 0%, rgba(255,255,255,.06), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.08), transparent 46%);
      opacity:.92;
      pointer-events:none;
    }
    .glass > *{ position:relative; z-index:1; }

    /* ===== APP LAYOUT (new, bigger, 3-panels + dock) ===== */
    .app{
      position:relative;
      z-index:3;
      height:100%;
      padding: var(--pad);
      display:grid;
      grid-template-rows: var(--topH) 1fr var(--playerH);
      gap: var(--gap);
    }

    .topbar{
      display:flex;
      align-items:center;
      gap: calc(12px * var(--ui));
      padding: calc(14px * var(--ui));
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width:0;
    }
    .brand .name{
      font-weight: 990;
      font-size: var(--fs4);
      letter-spacing:.2px;
      background: linear-gradient(90deg, var(--accent), #ff6fae);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .tag{
      font-weight: 900;
      font-size: var(--fs2);
      color: rgba(255,255,255,.70);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: calc(10px * var(--ui)) calc(14px * var(--ui));
      font-weight: 980;
      font-size: var(--fs2);
      user-select:none;
      white-space:nowrap;
    }

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap: calc(10px * var(--ui));
      padding: calc(12px * var(--ui)) calc(16px * var(--ui));
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      min-width:0;
    }
    .search .i{ font-size: var(--fs3); opacity:.9; }
    .search input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      color: var(--text);
      font-size: var(--fs3);
      font-weight: 950;
      letter-spacing:.1px;
      min-width:0;
    }

    .topBtns{
      display:flex; gap: calc(10px * var(--ui));
      flex:0 0 auto;
    }

    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.94);
      border-radius: calc(18px * var(--ui));
      padding: calc(12px * var(--ui)) calc(14px * var(--ui));
      font-weight: 980;
      font-size: var(--fs3);
      cursor:pointer;
      user-select:none;
      letter-spacing:.1px;
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn.primary{
      background:
        radial-gradient(60% 70% at 30% 25%, rgba(255,255,255,.24), transparent 62%),
        var(--accent);
      border-color: color-mix(in srgb, var(--accent) 60%, rgba(255,255,255,.12));
      color:#141414;
    }
    .btn.ghost{ background: rgba(255,255,255,.04); }

    .mid{
      display:grid;
      grid-template-columns: var(--leftW) 1fr var(--rightW);
      gap: var(--gap);
      min-height:0;
    }

    /* LEFT: Dock + Quick */
    .left{
      display:grid;
      grid-template-rows: var(--dockH) 1fr;
      gap: var(--gap);
      min-height:0;
    }
    .dock{
      padding: calc(12px * var(--ui));
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: calc(10px * var(--ui));
      align-items:stretch;
    }
    .dockBtn{
      border:none;
      border-radius: calc(20px * var(--ui));
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      font-weight: 990;
      font-size: var(--fs2);
      cursor:pointer;
      user-select:none;
      min-width:0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap: 4px;
      line-height:1.05;
    }
    .dockBtn .ico{ font-size: var(--fs3); }
    .dockBtn .k{ font-size: var(--fs0); opacity:.78; }
    .dockBtn.active{
      background:
        radial-gradient(420px 160px at 50% 0%, color-mix(in srgb, var(--accent) 20%, transparent), transparent 60%),
        rgba(255,255,255,.06);
      border-color: color-mix(in srgb, var(--accent) 42%, rgba(255,255,255,.12));
    }

    .leftPane{
      padding: calc(16px * var(--ui));
      overflow:auto;
      min-height:0;
    }
    .leftPane::-webkit-scrollbar{ width: 12px; }
    .leftPane::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
      border: 3px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }

    .bigTitle{
      font-weight: 990;
      font-size: var(--fs5);
      letter-spacing:.2px;
      margin:0 0 calc(8px * var(--ui)) 0;
    }
    .subText{
      font-weight: 850;
      font-size: var(--fs3);
      color: rgba(255,255,255,.75);
      margin:0 0 calc(16px * var(--ui)) 0;
      line-height:1.25;
    }

    .cards{
      display:grid;
      grid-template-columns: 1fr;
      gap: calc(12px * var(--ui));
    }
    .card{
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 260px at 18% -10%, rgba(255,255,255,.06), transparent 62%),
        rgba(0,0,0,.18);
      padding: calc(16px * var(--ui));
      cursor:pointer;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .card:hover{ background: rgba(255,255,255,.06); }
    .card .t{
      font-weight: 990;
      font-size: var(--fs4);
      letter-spacing:.1px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .card .d{
      margin-top: calc(8px * var(--ui));
      font-weight: 850;
      font-size: var(--fs3);
      color: rgba(255,255,255,.72);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .card .mini{
      margin-top: calc(14px * var(--ui));
      display:flex;
      gap: calc(10px * var(--ui));
      flex-wrap:wrap;
    }

    /* CENTER: Feed / Library */
    .center{
      padding: calc(16px * var(--ui));
      overflow:auto;
      min-height:0;
    }
    .center::-webkit-scrollbar{ width: 12px; }
    .center::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
      border: 3px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }

    .hero{
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(980px 360px at 16% 0%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 64%),
        radial-gradient(980px 360px at 84% 0%, rgba(110,203,255,.14), transparent 68%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
        rgba(255,255,255,.03);
      padding: calc(18px * var(--ui));
    }
    .hero h1{
      margin:0;
      font-weight: 990;
      font-size: var(--fs5);
      letter-spacing:.2px;
    }
    .hero p{
      margin: calc(10px * var(--ui)) 0 0;
      font-weight: 860;
      font-size: var(--fs3);
      color: rgba(255,255,255,.75);
      line-height:1.25;
    }

    .grid2{
      margin-top: calc(14px * var(--ui));
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: calc(14px * var(--ui));
    }

    .panel{
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      padding: calc(16px * var(--ui));
      min-height:0;
    }
    .panel h3{
      margin:0 0 calc(12px * var(--ui)) 0;
      font-weight: 990;
      font-size: var(--fs4);
      letter-spacing:.1px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: calc(12px * var(--ui));
      min-width:0;
    }
    .item{
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 260px at 18% -10%, rgba(255,255,255,.05), transparent 62%),
        rgba(0,0,0,.16);
      padding: calc(16px * var(--ui));
      cursor:pointer;
      user-select:none;
      overflow:hidden;
      position:relative;
    }
    .item:hover{ background: rgba(255,255,255,.06); }
    .item.active{
      border-color: color-mix(in srgb, var(--accent) 44%, rgba(255,255,255,.12));
      background:
        radial-gradient(980px 320px at 18% -10%, color-mix(in srgb, var(--accent) 16%, transparent), transparent 62%),
        rgba(255,255,255,.06);
    }
    .item .t{
      font-weight: 990;
      font-size: var(--fs4);
      letter-spacing:.1px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item .d{
      margin-top: calc(8px * var(--ui));
      font-weight: 850;
      font-size: var(--fs3);
      color: rgba(255,255,255,.72);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .note{
      margin-top: calc(10px * var(--ui));
      font-weight: 850;
      font-size: var(--fs3);
      color: rgba(255,255,255,.70);
      line-height:1.35;
    }

    /* RIGHT: Queue + Tools */
    .right{
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap: var(--gap);
      min-height:0;
    }
    .rightPane{
      padding: calc(16px * var(--ui));
      overflow:auto;
      min-height:0;
    }
    .rightPane::-webkit-scrollbar{ width: 12px; }
    .rightPane::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
      border: 3px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }

    .meter{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: calc(10px * var(--ui));
      margin-top: calc(10px * var(--ui));
    }
    .meter span{
      font-weight: 980;
      font-size: var(--fs3);
      color: rgba(255,255,255,.80);
      white-space:nowrap;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
      height: calc(26px * var(--ui));
    }

    /* ===== PLAYER (new, bigger, glossy) ===== */
    .player{
      padding: calc(14px * var(--ui)) calc(16px * var(--ui));
      display:grid;
      grid-template-columns: 1.45fr 1fr 1.25fr;
      gap: var(--gap);
      align-items:center;

      background:
        radial-gradient(1000px 260px at 18% 0%, rgba(255,179,71,.12), transparent 62%),
        radial-gradient(1000px 260px at 82% 0%, rgba(255,111,174,.10), transparent 66%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)),
        rgba(14,16,28, .56);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--r1);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      box-shadow: 0 34px 140px rgba(0,0,0,.74);
      overflow:hidden;
      position:relative;
    }
    .player::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(1000px 320px at 16% -10%, rgba(255,255,255,.10), transparent 64%),
        radial-gradient(900px 300px at 86% 0%, rgba(255,255,255,.08), transparent 66%);
      opacity:.92;
      pointer-events:none;
    }
    .player > *{ position:relative; z-index:1; }

    .now{
      display:flex;
      align-items:center;
      gap: calc(12px * var(--ui));
      min-width:0;
    }
    .art{
      width: calc(84px * var(--ui));
      height: calc(84px * var(--ui));
      border-radius: calc(26px * var(--ui));
      background:
        radial-gradient(55% 70% at 30% 28%, rgba(255,255,255,.18), transparent 56%),
        linear-gradient(135deg, rgba(255,255,255,.08), color-mix(in srgb, var(--accent) 26%, transparent));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 46px rgba(0,0,0,.28);
      flex:0 0 auto;
    }
    .meta{ min-width:0; }
    .track{
      font-weight: 990;
      font-size: var(--fs4);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .artist{
      margin-top: calc(6px * var(--ui));
      font-weight: 860;
      font-size: var(--fs3);
      color: rgba(255,255,255,.76);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .ctrl{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: calc(12px * var(--ui));
    }
    .pbtn{
      width: calc(54px * var(--ui));
      height: calc(54px * var(--ui));
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(60% 70% at 30% 28%, rgba(255,255,255,.10), transparent 60%),
        rgba(255,255,255,.06);
      color: rgba(255,255,255,.96);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight: 990;
      user-select:none;
      box-shadow:
        0 12px 30px rgba(0,0,0,.20) inset,
        0 14px 30px rgba(0,0,0,.16);
      font-size: var(--fs3);
    }
    .pbtn:hover{ background: rgba(255,255,255,.10); }
    .pbtn.play{
      width: calc(70px * var(--ui));
      height: calc(70px * var(--ui));
      background:
        radial-gradient(60% 70% at 30% 25%, rgba(255,255,255,.24), transparent 62%),
        var(--accent);
      border-color: color-mix(in srgb, var(--accent) 60%, rgba(255,255,255,.12));
      color:#141414;
      font-size: var(--fs4);
    }

    .rightControls{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: calc(10px * var(--ui));
      flex-wrap:wrap;
      min-width:0;
    }
    .badge{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      border-radius: 999px;
      padding: calc(10px * var(--ui)) calc(12px * var(--ui));
      font-weight: 980;
      font-size: var(--fs2);
      user-select:none;
      white-space:nowrap;
    }
    #audio{ display:none; }

    /* ===== MODAL HELP ===== */
    .modalWrap{
      position:fixed; inset:0;
      display:none;
      z-index: 95;
      background: rgba(0,0,0,.56);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      align-items:center;
      justify-content:center;
      padding: calc(18px * var(--ui));
    }
    .modal{
      width: min(760px, 100%);
      border-radius: var(--r1);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(14,16,28,.90);
      box-shadow: 0 44px 160px rgba(0,0,0,.82);
      overflow:hidden;
    }
    .mTop{
      padding: calc(16px * var(--ui));
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: calc(12px * var(--ui));
    }
    .mTop .ttl{
      font-weight: 990;
      font-size: var(--fs4);
      letter-spacing:.1px;
    }
    .mBody{
      padding: calc(16px * var(--ui));
      color: rgba(255,255,255,.84);
      font-weight: 860;
      font-size: var(--fs3);
      line-height: 1.35;
      white-space:pre-wrap;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1260px){
      :root{ --rightW: calc(380px * var(--ui)); }
      .grid2{ grid-template-columns: 1fr; }
    }
    @media (max-width: 980px){
      :root{
        --leftW: calc(360px * var(--ui));
        --rightW: calc(360px * var(--ui));
      }
    }
    @media (max-width: 860px){
      body{ overflow:auto; }
      .app{
        height:auto;
        grid-template-rows: auto auto auto;
      }
      .mid{ grid-template-columns: 1fr; }
      .right{ grid-template-rows: auto auto; }
      .player{
        grid-template-columns: 1fr;
      }
      #audio{ display:block; width:100%; }
    }
  </style>
</head>

<body data-bg="3">
  <div class="bg"></div>
  <div class="sun"></div>
  <div class="rain" id="rain"></div>

  <div class="modalWrap" id="mw">
    <div class="modal">
      <div class="mTop">
        <div class="ttl" id="mt">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
        <button class="btn ghost" id="mc">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="mBody" id="mb"></div>
    </div>
  </div>

  <div class="app">
    <!-- TOPBAR -->
    <header class="glass topbar">
      <div class="brand">
        <div class="name">–ö—Ä–∞—Å–∫–∏ –†–∞—Å—Å–≤–µ—Ç–∞</div>
        <div class="tag" id="tagline">–º–µ–¥–∏–∞—Ç–µ–∫–∞ ‚Ä¢ –ø–ª–µ–π–ª–∏—Å—Ç—ã ‚Ä¢ –æ—á–µ—Ä–µ–¥–∏ ‚Ä¢ —ç—Ñ—Ñ–µ–∫—Ç—ã</div>
      </div>

      <div class="pill" id="ver">REL-UI-NEO</div>

      <div class="search">
        <div class="i">üîé</div>
        <input id="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç—Ä–µ–∫–∞–º / –∞–≤—Ç–æ—Ä–∞–º / –ø–ª–µ–π–ª–∏—Å—Ç–∞–º" autocomplete="off" />
      </div>

      <div class="topBtns">
        <button class="btn" id="bHelp">?</button>
        <button class="btn primary" id="bSettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </header>

    <!-- MID -->
    <section class="mid">
      <!-- LEFT -->
      <aside class="left">
        <nav class="glass dock" id="dock">
          <button class="dockBtn active" data-p="home"><div class="ico">üåÖ</div><div>–ì–ª–∞–≤–Ω–∞—è</div><div class="k">1</div></button>
          <button class="dockBtn" data-p="library"><div class="ico">üéß</div><div>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div><div class="k">2</div></button>
          <button class="dockBtn" data-p="playlists"><div class="ico">üìÅ</div><div>–ü–ª–µ–π–ª–∏—Å—Ç—ã</div><div class="k">3</div></button>
          <button class="dockBtn" data-p="queue"><div class="ico">üß†</div><div>–û—á–µ—Ä–µ–¥—å</div><div class="k">4</div></button>
          <button class="dockBtn" data-p="settings"><div class="ico">‚öô</div><div>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div><div class="k">5</div></button>
        </nav>

        <div class="glass leftPane">
          <div id="leftSlot"></div>
        </div>
      </aside>

      <!-- CENTER -->
      <main class="glass center">
        <div id="centerSlot"></div>
      </main>

      <!-- RIGHT -->
      <aside class="right">
        <div class="glass rightPane">
          <div id="rightTop"></div>
        </div>
        <div class="glass rightPane">
          <div id="rightBottom"></div>
        </div>
      </aside>
    </section>

    <!-- PLAYER -->
    <footer class="player">
      <div class="now">
        <div class="art"></div>
        <div class="meta">
          <div class="track" id="tName">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞</div>
          <div class="artist" id="tArtist">–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫</div>
        </div>
      </div>

      <div class="ctrl">
        <button class="pbtn" id="prev" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π">‚èÆ</button>
        <button class="pbtn play" id="play" title="Play">‚ñ∂</button>
        <button class="pbtn" id="next" title="–°–ª–µ–¥—É—é—â–∏–π">‚è≠</button>
        <button class="pbtn" id="stop" title="–°—Ç–æ–ø">‚èπ</button>
      </div>

      <div class="rightControls">
        <button class="btn" id="bToPl">–í –ø–ª–µ–π–ª–∏—Å—Ç</button>
        <button class="btn ghost" id="bFav">‚ô°</button>
        <span class="badge" id="src">Source: ‚Äî</span>
        <span class="badge" id="mode">Mode: Normal</span>
        <audio id="audio" controls></audio>
      </div>
    </footer>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);

    /* =========================
       MODAL
    ========================== */
    const mw = $("#mw"), mt = $("#mt"), mb = $("#mb");
    $("#mc").addEventListener("click", ()=> mw.style.display="none");
    mw.addEventListener("click", (e)=>{ if(e.target===mw) mw.style.display="flex"; });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") mw.style.display="none"; });
    function tip(title, text){
      mt.textContent = title || "–ü–æ–¥—Å–∫–∞–∑–∫–∞";
      mb.textContent = text || "";
      mw.style.display = "flex";
    }

    /* =========================
       STORAGE KEYS
    ========================== */
    const LS = {
      ui:"krs_ui2", accent:"krs_accent2", bg:"krs_bg2",
      glass:"krs_glass2",
      rainOn:"krs_rainOn2", rainCount:"krs_rainCount2", rainSize:"krs_rainSize2", rainSpeed:"krs_rainSpeed2",
      sunOn:"krs_sunOn2", sunPower:"krs_sunPower2",
      motion:"krs_motion2",
      playlists:"krs_playlists_v5",
      favorites:"krs_favorites_v2",
      smart:"krs_smart_v1",
      queue:"krs_queue_v1"
    };

    function lsGet(k, def){ const v=localStorage.getItem(k); return (v==null)? def : v; }
    function lsSet(k, v){ localStorage.setItem(k, String(v)); }

    const root = document.documentElement;
    function applyVar(name, value){
      root.style.setProperty(name, value);
    }

    /* =========================
       APPLY SAVED SETTINGS
    ========================== */
    const ui0 = parseFloat(lsGet(LS.ui, getComputedStyle(root).getPropertyValue("--ui").trim())) || 2.10;
    const a0  = lsGet(LS.accent, getComputedStyle(root).getPropertyValue("--accent").trim()) || "#ffb347";
    const bg0 = parseInt(lsGet(LS.bg, document.body.getAttribute("data-bg") || "3"),10) || 3;
    const g0  = parseFloat(lsGet(LS.glass, getComputedStyle(root).getPropertyValue("--glass").trim())) || .58;

    const rOn0= parseInt(lsGet(LS.rainOn, getComputedStyle(root).getPropertyValue("--rainOn").trim()),10) || 1;
    const rCt0= parseInt(lsGet(LS.rainCount, getComputedStyle(root).getPropertyValue("--rainCount").trim()),10) || 120;
    const rSz0= parseFloat(lsGet(LS.rainSize, getComputedStyle(root).getPropertyValue("--rainSize").trim())) || 1.15;
    const rSp0= parseFloat(lsGet(LS.rainSpeed, getComputedStyle(root).getPropertyValue("--rainSpeed").trim())) || 1.00;

    const sOn0= parseInt(lsGet(LS.sunOn, getComputedStyle(root).getPropertyValue("--sunOn").trim()),10) || 1;
    const sPw0= parseFloat(lsGet(LS.sunPower, getComputedStyle(root).getPropertyValue("--sunPower").trim())) || .90;

    const m0  = parseInt(lsGet(LS.motion, getComputedStyle(root).getPropertyValue("--motion").trim()),10) || 1;

    applyVar("--ui", ui0);
    applyVar("--accent", a0);
    applyVar("--glass", g0);
    applyVar("--rainOn", rOn0);
    applyVar("--rainCount", rCt0);
    applyVar("--rainSize", rSz0);
    applyVar("--rainSpeed", rSp0);
    applyVar("--sunOn", sOn0);
    applyVar("--sunPower", sPw0);
    applyVar("--motion", m0);
    document.body.setAttribute("data-bg", String(bg0));

    /* =========================
       RAIN
    ========================== */
    const rainLayer = $("#rain");
    let drops = [];
    function rebuildRain(){
      drops.forEach(d=> d.remove());
      drops = [];
      const on = parseInt(getComputedStyle(root).getPropertyValue("--rainOn"))===1;
      const count = parseInt(getComputedStyle(root).getPropertyValue("--rainCount")) || 0;
      const speed = parseFloat(getComputedStyle(root).getPropertyValue("--rainSpeed")) || 1.0;
      if(!on || count<=0) return;

      const w = window.innerWidth;
      for(let i=0;i<count;i++){
        const d = document.createElement("div");
        d.className = "drop";
        const left = Math.random() * w;
        const dur  = (2.9 + Math.random()*6.2) / Math.max(0.2, speed);
        const delay= Math.random()*2.8;
        const op   = 0.18 + Math.random()*0.36;
        d.style.left = left + "px";
        d.style.animationDuration = dur + "s";
        d.style.animationDelay = delay + "s";
        d.style.opacity = op;
        rainLayer.appendChild(d);
        drops.push(d);
      }
    }
    window.addEventListener("resize", rebuildRain);

    /* =========================
       DATA MODEL
    ========================== */
    const audio = $("#audio");
    const SOURCE = { NONE:"‚Äî", LOCAL:"Local", REPO:"Repo" };

    function setSrc(s){ $("#src").textContent = "Source: " + s; }
    function setMode(t){ $("#mode").textContent = "Mode: " + t; }

    function fmtBytes(bytes){
      const u=["B","KB","MB","GB"]; let i=0, n=bytes;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return (i===0? n : n.toFixed(1))+" "+u[i];
    }
    function parseName(name){
      const base = String(name||"").replace(/\.[^/.]+$/,"");
      const parts = base.split(" - ");
      if(parts.length>=2){
        return { artist: parts[0].trim()||"Unknown", title: parts.slice(1).join(" - ").trim()||"Untitled" };
      }
      return { artist:"Unknown", title: base.trim()||"Untitled" };
    }
    function hash(s){
      let h=2166136261;
      for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
      return (h>>>0).toString(16);
    }
    function refKey(r){ return r.kind + ":" + r.id; }

    /* =========================
       INDEXEDDB (LOCAL TRACKS)
    ========================== */
    const DB="krs_db2", VER=1, STORE="tracks";
    function openDB(){
      return new Promise((res, rej)=>{
        const req = indexedDB.open(DB, VER);
        req.onupgradeneeded=()=>{
          const db=req.result;
          if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE, { keyPath:"id" });
        };
        req.onsuccess=()=>res(req.result);
        req.onerror=()=>rej(req.error);
      });
    }
    async function dbAll(){
      const db = await openDB();
      return new Promise((res, rej)=>{
        const tx = db.transaction(STORE, "readonly");
        const rq = tx.objectStore(STORE).getAll();
        rq.onsuccess=()=>{ const r=rq.result||[]; db.close(); res(r); };
        rq.onerror=()=>{ const e=rq.error; db.close(); rej(e); };
      });
    }
    async function dbPut(obj){
      const db = await openDB();
      return new Promise((res, rej)=>{
        const tx=db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).put(obj);
        tx.oncomplete=()=>{ db.close(); res(); };
        tx.onerror=()=>{ const e=tx.error; db.close(); rej(e); };
      });
    }
    async function dbClear(){
      const db = await openDB();
      return new Promise((res, rej)=>{
        const tx=db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).clear();
        tx.oncomplete=()=>{ db.close(); res(); };
        tx.onerror=()=>{ const e=tx.error; db.close(); rej(e); };
      });
    }

    let localTracks = []; // {id,kind:"local",artist,title,size,type,createdAt,blob,name}
    let repoTracks  = []; // {id,kind:"repo",artist,title,url}

    async function loadRepo(){
      repoTracks = [];
      try{
        const r = await fetch("assets/audio/manifest.json", { cache:"no-store" });
        if(!r.ok) throw new Error("no manifest");
        const arr = await r.json();
        if(Array.isArray(arr)){
          repoTracks = arr.map((x,i)=>{
            const url = String(x.url||"").trim();
            if(!url) return null;
            const a = String(x.artist||"").trim();
            const t = String(x.title||"").trim();
            if(a && t) return { id:"r_"+i+"_"+hash(url), kind:"repo", artist:a, title:t, url };
            const parsed = parseName(url.split("/").pop() || url);
            return { id:"r_"+i+"_"+hash(url), kind:"repo", artist: parsed.artist, title: parsed.title, url };
          }).filter(Boolean);
        }
      }catch{
        repoTracks = [];
      }
    }

    async function loadLocal(){
      const raw = await dbAll();
      localTracks = raw
        .map(x=>{
          const p = parseName(x.name || (x.artist+" - "+x.title) || "Unknown - Untitled");
          return {
            id: x.id,
            kind:"local",
            artist: x.artist || p.artist,
            title:  x.title  || p.title,
            name:   x.name || (p.artist + " - " + p.title),
            size: x.size || 0,
            type: x.type || "audio/*",
            createdAt: x.createdAt || 0,
            blob: x.blob
          };
        })
        .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
    }

    function getAllTracks(){ return [...repoTracks, ...localTracks]; }
    function byRef(ref){
      if(!ref) return null;
      if(ref.kind==="local") return localTracks.find(t=>t.id===ref.id)||null;
      if(ref.kind==="repo")  return repoTracks.find(t=>t.id===ref.id)||null;
      return null;
    }

    /* =========================
       PLAYLISTS + FAVORITES + QUEUE
    ========================== */
    function defaultPL(){
      return {
        selected:"pl_all",
        items:[
          { id:"pl_all", name:"–í—Å–µ —Ç—Ä–µ–∫–∏", refs:[] },   // virtual
          { id:"pl_fav", name:"–ò–∑–±—Ä–∞–Ω–Ω–æ–µ", refs:[] }
        ]
      };
    }
    function plLoad(){
      try{
        const s = localStorage.getItem(LS.playlists);
        if(!s) return defaultPL();
        const x = JSON.parse(s);
        if(!x?.items?.length) return defaultPL();
        return x;
      }catch{ return defaultPL(); }
    }
    function plSave(){ localStorage.setItem(LS.playlists, JSON.stringify(pl)); }

    let pl = plLoad();

    function plGet(id){ return pl.items.find(p=>p.id===id)||null; }
    function plNormalizeAll(){
      const all = plGet("pl_all");
      if(all) all.refs = getAllTracks().map(t=>({kind:t.kind, id:t.id}));
      if(!plGet(pl.selected)) pl.selected = "pl_all";
      if(!plGet("pl_fav")) pl.items.push({ id:"pl_fav", name:"–ò–∑–±—Ä–∞–Ω–Ω–æ–µ", refs:[] });
    }
    function plAdd(ref, plId){
      const p = plGet(plId);
      if(!p || p.id==="pl_all") return;
      const k = refKey(ref);
      if(!p.refs.some(x=>refKey(x)===k)){
        p.refs.push({kind:ref.kind, id:ref.id});
        plSave();
      }
    }
    function plRemove(ref, plId){
      const p = plGet(plId);
      if(!p || p.id==="pl_all") return;
      const k = refKey(ref);
      p.refs = p.refs.filter(x=>refKey(x)!==k);
      plSave();
    }

    function favLoad(){
      try{ return new Set(JSON.parse(localStorage.getItem(LS.favorites) || "[]")); }
      catch{ return new Set(); }
    }
    function favSave(){
      localStorage.setItem(LS.favorites, JSON.stringify(Array.from(favs)));
    }
    let favs = favLoad(); // keys "kind:id"

    function queueLoad(){
      try{
        const a = JSON.parse(localStorage.getItem(LS.queue) || "[]");
        if(Array.isArray(a)) return a;
        return [];
      }catch{ return []; }
    }
    function queueSave(){
      localStorage.setItem(LS.queue, JSON.stringify(queue));
    }
    let queue = queueLoad(); // refs

    function queuePush(ref){
      const k = refKey(ref);
      if(!queue.some(r=>refKey(r)===k)){
        queue.push({kind:ref.kind, id:ref.id});
        queueSave();
      }
    }
    function queueRemove(ref){
      const k = refKey(ref);
      queue = queue.filter(r=>refKey(r)!==k);
      queueSave();
    }
    function queueClear(){
      queue = [];
      queueSave();
    }

    /* =========================
       PLAYBACK (ONE ACTIVE + SMART MODES)
    ========================== */
    let active = null;
    let activeSource = SOURCE.NONE;

    const SMART = {
      on: parseInt(lsGet(LS.smart, "0"),10) || 0,
      mood: parseInt(lsGet("krs_mood_v1","55"),10) || 55,  // 0..100
      focus: parseInt(lsGet("krs_focus_v1","0"),10) || 0,  // 0/1
      timerMin: parseInt(lsGet("krs_timer_v1","0"),10) || 0
    };

    let timerHandle = null;

    function setNow(title, artist){
      $("#tName").textContent = title || "‚Äî";
      $("#tArtist").textContent = artist || "‚Äî";
    }

    function stopAudio(){
      try{ audio.pause(); audio.removeAttribute("src"); audio.load(); }catch{}
    }

    function stopAll(){
      stopAudio();
      active=null;
      activeSource=SOURCE.NONE;
      setSrc(SOURCE.NONE);
      setNow("–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫");
      $("#play").textContent = "‚ñ∂";
      renderAll();
    }

    function playTrack(ref){
      const t = byRef(ref);
      if(!t) return_dbNotifyMissing(ref);

      stopAudio();

      if(ref.kind==="repo"){
        audio.src = t.url;
        audio.play().catch(()=>{});
        active = ref;
        activeSource = SOURCE.REPO;
        setSrc(SOURCE.REPO);
        setNow(t.artist + " ‚Äî " + t.title, "Repo");
        renderAll();
        return;
      }

      if(ref.kind==="local"){
        const lt = localTracks.find(x=>x.id===ref.id);
        if(!lt) return;
        const url = URL.createObjectURL(lt.blob);
        audio.src = url;
        audio.play().catch(()=>{});
        active = ref;
        activeSource = SOURCE.LOCAL;
        setSrc(SOURCE.LOCAL);
        setNow(lt.artist + " ‚Äî " + lt.title, "Local ‚Ä¢ " + fmtBytes(lt.size));
        renderAll();
        return;
      }
    }

    function _dbNotifyMissing(ref){
      tip("–¢—Ä–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω", "–≠—Ç–æ—Ç —Ç—Ä–µ–∫ –±—ã–ª —É–¥–∞–ª—ë–Ω/–Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è: " + refKey(ref));
    }

    function getNavList(){
      plNormalizeAll();

      if(queue.length){
        return queue.slice();
      }

      const selected = plGet(pl.selected);
      if(selected && selected.refs && selected.refs.length && selected.id!=="pl_all"){
        return selected.refs.slice();
      }

      const all = getAllTracks().map(t=>({kind:t.kind, id:t.id}));

      if(SMART.on){
        // SmartMix: –ª–µ–≥–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ mood (—á–µ–º –≤—ã—à–µ mood, —Ç–µ–º –±–æ–ª—å—à–µ —à–∞–Ω—Å "—è—Ä–∫–∏—Ö" => –∞–∫—Ü–µ–Ω—Ç –Ω–∞ Repo, –∏–Ω–∞—á–µ –Ω–∞ Local)
        // + –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–µ—Ä—Ö—É
        const favSet = new Set(Array.from(favs));
        const mood = SMART.mood;
        all.sort((a,b)=>{
          const ak = refKey(a), bk = refKey(b);
          const af = favSet.has(ak) ? 1 : 0;
          const bf = favSet.has(bk) ? 1 : 0;
          if(af!==bf) return bf-af;

          // mood bias: >50 => repo –≤—ã—à–µ, <50 => local –≤—ã—à–µ
          const aw = (a.kind==="repo") ? (mood>=50? 1:0) : (mood<50? 1:0);
          const bw = (b.kind==="repo") ? (mood>=50? 1:0) : (mood<50? 1:0);
          if(aw!==bw) return bw-aw;

          return 0;
        });
      }

      return all;
    }

    function navStep(dir){
      const list = getNavList();
      if(!list.length) return;

      const cur = active ? refKey(active) : "";
      const idx = list.findIndex(r=>refKey(r)===cur);

      let ni = 0;
      if(idx>=0){
        ni = dir<0 ? (idx<=0 ? list.length-1 : idx-1) : ((idx+1)%list.length);
      }
      playTrack(list[ni]);
    }

    $("#prev").addEventListener("click", ()=> navStep(-1));
    $("#next").addEventListener("click", ()=> navStep(+1));
    $("#stop").addEventListener("click", stopAll);

    $("#play").addEventListener("click", ()=>{
      if(audio.src){
        if(audio.paused) audio.play().catch(()=>{});
        else audio.pause();
        return;
      }
      const list = getNavList();
      if(list.length) playTrack(list[0]);
    });

    audio.addEventListener("play", ()=> $("#play").textContent="‚è∏");
    audio.addEventListener("pause", ()=> $("#play").textContent="‚ñ∂");
    audio.addEventListener("ended", ()=>{
      $("#play").textContent="‚ñ∂";
      // auto-next with SmartMix or queue
      if(SMART.focus){
        // focus: –Ω–µ –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–∏—à–∏–Ω—É
        return;
      }
      navStep(+1);
    });

    function setSleepTimer(min){
      if(timerHandle) clearTimeout(timerHandle);
      timerHandle = null;
      SMART.timerMin = min;
      lsSet("krs_timer_v1", String(min));
      if(min>0){
        timerHandle = setTimeout(()=> stopAll(), min*60*1000);
      }
    }

    /* =========================
       ADD TO PLAYLIST FLOW
    ========================== */
    function addToPlaylistFlow(ref){
      if(!ref) {
        if(!active) return tip("–í –ø–ª–µ–π–ª–∏—Å—Ç", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫.");
        ref = active;
      }
      plNormalizeAll();
      const names = pl.items.filter(p=>p.id!=="pl_all").map(p=>p.name);
      if(!names.length){
        return tip("–í –ø–ª–µ–π–ª–∏—Å—Ç", "–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –ø–ª–µ–π–ª–∏—Å—Ç.");
      }
      const chosen = prompt("–ö—É–¥–∞ –¥–æ–±–∞–≤–∏—Ç—å? –í–≤–µ–¥–∏ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:\n" + names.join("\n"));
      if(!chosen) return;
      const p = pl.items.find(x=>x.id!=="pl_all" && x.name===chosen);
      if(!p) return tip("–í –ø–ª–µ–π–ª–∏—Å—Ç", "–ü–ª–µ–π–ª–∏—Å—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω.");
      plAdd(ref, p.id);
      tip("–ì–æ—Ç–æ–≤–æ", "–î–æ–±–∞–≤–ª–µ–Ω–æ –≤: " + p.name);
      renderAll();
    }

    $("#bToPl").addEventListener("click", ()=> addToPlaylistFlow(active));

    $("#bFav").addEventListener("click", ()=>{
      if(!active) return;
      const k = refKey(active);
      if(favs.has(k)) favs.delete(k);
      else favs.add(k);
      favSave();
      renderAll();
    });

    /* =========================
       PAGES (5)
    ========================== */
    const pages = ["home","library","playlists","queue","settings"];
    let page = "home";
    function openPage(p){
      page = p;
      document.querySelectorAll(".dockBtn").forEach(b=> b.classList.toggle("active", b.dataset.p===p));
      renderAll();
    }
    document.querySelectorAll(".dockBtn").forEach(b=> b.addEventListener("click", ()=> openPage(b.dataset.p)));

    // Keyboard 1..5 (not while typing)
    document.addEventListener("keydown", (e)=>{
      const tag = (document.activeElement?.tagName||"").toLowerCase();
      const typing = tag==="input" || tag==="textarea" || document.activeElement?.isContentEditable;
      if(typing) return;

      if(e.key==="1") openPage("home");
      if(e.key==="2") openPage("library");
      if(e.key==="3") openPage("playlists");
      if(e.key==="4") openPage("queue");
      if(e.key==="5") openPage("settings");

      if(e.key===" "){ // space play/pause
        e.preventDefault();
        $("#play").click();
      }
    });

    /* =========================
       IMPORT UI (in Library)
    ========================== */
    const inFiles = document.createElement("input");
    inFiles.type="file"; inFiles.accept="audio/*"; inFiles.multiple=true; inFiles.style.display="none";
    document.body.appendChild(inFiles);

    const inFolder = document.createElement("input");
    inFolder.type="file"; inFolder.accept="audio/*"; inFolder.multiple=true; inFolder.webkitdirectory=true; inFolder.directory=true; inFolder.style.display="none";
    document.body.appendChild(inFolder);

    const inZip = document.createElement("input");
    inZip.type="file"; inZip.accept=".zip"; inZip.style.display="none";
    document.body.appendChild(inZip);

    async function importFiles(files){
      const arr = Array.from(files||[]);
      if(!arr.length) return;
      let ok=0;
      for(const f of arr){
        if(!f.type.startsWith("audio/")) continue;
        const p = parseName(f.name);
        await dbPut({
          id: "t_" + crypto.randomUUID(),
          name: f.name,
          artist: p.artist,
          title: p.title,
          type: f.type || "audio/*",
          size: f.size || 0,
          createdAt: Date.now(),
          blob: f
        });
        ok++;
      }
      await loadLocal();
      tip("–ò–º–ø–æ—Ä—Ç", "–î–æ–±–∞–≤–ª–µ–Ω–æ: " + ok);
      renderAll();
    }

    inFiles.addEventListener("change", async (e)=>{ await importFiles(e.target.files); e.target.value=""; });
    inFolder.addEventListener("change", async (e)=>{ await importFiles(e.target.files); e.target.value=""; });

    inZip.addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      try{
        const zip = await JSZip.loadAsync(f);
        const exts = [".mp3",".wav",".ogg",".m4a",".aac",".flac"];
        const entries = [];
        for(const [path, ent] of Object.entries(zip.files)){
          if(ent.dir) continue;
          const low = path.toLowerCase();
          if(!exts.some(x=>low.endsWith(x))) continue;
          entries.push({path, ent});
        }
        let ok=0;
        for(const it of entries){
          const blob = await it.ent.async("blob");
          const name = it.path.split("/").pop() || it.path;
          const p = parseName(name);
          await dbPut({
            id: "t_" + crypto.randomUUID(),
            name,
            artist: p.artist,
            title: p.title,
            type: "audio/*",
            size: blob.size || 0,
            createdAt: Date.now(),
            blob
          });
          ok++;
        }
        await loadLocal();
        tip("ZIP", "–î–æ–±–∞–≤–ª–µ–Ω–æ: " + ok);
        renderAll();
      }catch{
        tip("ZIP", "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å ZIP");
      }finally{
        e.target.value="";
      }
    });

    /* =========================
       SETTINGS (23 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ –ø–æ –æ—â—É—â–µ–Ω–∏—é)
       (—à–∏—Ä–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã, –±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤)
    ========================== */
    function setButtons(){
      $("#tagline").textContent =
        "–º–µ–¥–∏–∞—Ç–µ–∫–∞ ‚Ä¢ –ø–ª–µ–π–ª–∏—Å—Ç—ã ‚Ä¢ –æ—á–µ—Ä–µ–¥–∏ ‚Ä¢ —ç—Ñ—Ñ–µ–∫—Ç—ã ‚Ä¢ " +
        (SMART.on ? "SmartMix ON" : "SmartMix OFF");
      setMode(SMART.focus ? "Focus" : (SMART.on ? "SmartMix" : "Normal"));
    }

    $("#bHelp").addEventListener("click", ()=> tip(
      "–ö–ª–∞–≤–∏—à–∏",
      "1 –ì–ª–∞–≤–Ω–∞—è\n2 –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞\n3 –ü–ª–µ–π–ª–∏—Å—Ç—ã\n4 –û—á–µ—Ä–µ–¥—å\n5 –ù–∞—Å—Ç—Ä–æ–π–∫–∏\n–ü—Ä–æ–±–µ–ª: play/pause"
    ));
    $("#bSettings").addEventListener("click", ()=> openPage("settings"));

    /* =========================
       UI RENDER
    ========================== */
    function matchTrack(t, q){
      if(!q) return true;
      const s = (t.artist+" "+t.title).toLowerCase();
      return s.includes(q);
    }

    function renderLeft(){
      const left = $("#leftSlot");
      if(page==="home"){
        left.innerHTML = `
          <h2 class="bigTitle">–†–∞—Å—Å–≤–µ—Ç–Ω—ã–π –ø—É–ª—å—Ç</h2>
          <p class="subText">–±—ã—Å—Ç—Ä—ã–µ —Ä–µ–∂–∏–º—ã + —ç—Ñ—Ñ–µ–∫—Ç—ã + —Å—Ç–∞—Ä—Ç</p>

          <div class="cards">
            <div class="card" id="cStart">
              <div class="t">–°—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –º–∏–∫—Å</div>
              <div class="d">SmartMix / –æ—á–µ—Ä–µ–¥—å / –ø–ª–µ–π–ª–∏—Å—Ç</div>
              <div class="mini">
                <button class="btn primary" id="bMix">–ó–∞–ø—É—Å–∫</button>
                <button class="btn" id="bSmart">${SMART.on ? "SmartMix: ON" : "SmartMix: OFF"}</button>
                <button class="btn ghost" id="bFocus">${SMART.focus ? "Focus: ON" : "Focus: OFF"}</button>
              </div>
            </div>

            <div class="card" id="cImport">
              <div class="t">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫–∏</div>
              <div class="d">—Ñ–∞–π–ª—ã / –ø–∞–ø–∫–∞ / zip</div>
              <div class="mini">
                <button class="btn primary" id="bFiles">–§–∞–π–ª—ã</button>
                <button class="btn" id="bFolder">–ü–∞–ø–∫–∞</button>
                <button class="btn" id="bZip">ZIP</button>
              </div>
            </div>

            <div class="card" id="cMood">
              <div class="t">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
              <div class="d">—è—Ä–∫–æ ‚Üî —Å–ø–æ–∫–æ–π–Ω–æ</div>
              <div class="mini">
                <button class="btn" id="bMood">–û—Ç–∫—Ä—ã—Ç—å</button>
                <button class="btn ghost" id="bFxTip">?</button>
              </div>
            </div>
          </div>
        `;

        $("#bMix").addEventListener("click", ()=>{
          const list = getNavList();
          if(list.length) playTrack(list[0]);
        });
        $("#bSmart").addEventListener("click", ()=>{
          SMART.on = SMART.on ? 0 : 1;
          lsSet(LS.smart, String(SMART.on));
          setButtons();
          renderAll();
        });
        $("#bFocus").addEventListener("click", ()=>{
          SMART.focus = SMART.focus ? 0 : 1;
          lsSet("krs_focus_v1", String(SMART.focus));
          setButtons();
          renderAll();
        });
        $("#bFiles").addEventListener("click", ()=> inFiles.click());
        $("#bFolder").addEventListener("click", ()=> inFolder.click());
        $("#bZip").addEventListener("click", ()=> inZip.click());
        $("#bMood").addEventListener("click", ()=> openPage("settings"));
        $("#bFxTip").addEventListener("click", ()=> tip(
          "–≠—Ñ—Ñ–µ–∫—Ç—ã",
          "–î–æ–∂–¥—å –ø–∞–¥–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.\n–†–∞—Å—Å–≤–µ—Ç –ø–ª–∞–≤–Ω–æ –¥–≤–∏–≥–∞–µ—Ç—Å—è.\n–ú–æ–∂–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å motion, –µ—Å–ª–∏ –Ω–∞–¥–æ."
        ));
        return;
      }

      if(page==="library"){
        left.innerHTML = `
          <h2 class="bigTitle">–ò–º–ø–æ—Ä—Ç –∏ —á–∏—Å—Ç–∫–∞</h2>
          <p class="subText">Local —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. Repo ‚Äî —Ñ–∞–π–ª—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.</p>

          <div class="cards">
            <div class="card">
              <div class="t">–ò–º–ø–æ—Ä—Ç</div>
              <div class="d">–î–æ–±–∞–≤–∏—Ç—å —Å—Ä–∞–∑—É –º–Ω–æ–≥–æ</div>
              <div class="mini">
                <button class="btn primary" id="lf">–§–∞–π–ª—ã</button>
                <button class="btn" id="ld">–ü–∞–ø–∫–∞</button>
                <button class="btn" id="lz">ZIP</button>
              </div>
            </div>

            <div class="card">
              <div class="t">–û—á–∏—Å—Ç–∏—Ç—å Local</div>
              <div class="d">—É–¥–∞–ª–∏—Ç –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏</div>
              <div class="mini">
                <button class="btn ghost" id="clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
              </div>
            </div>

            <div class="card">
              <div class="t">Repo —Å—Ç–∞—Ç—É—Å</div>
              <div class="d">assets/audio/manifest.json</div>
              <div class="mini">
                <span class="pill">Repo: ${repoTracks.length}</span>
                <span class="pill">Local: ${localTracks.length}</span>
              </div>
            </div>
          </div>
        `;
        $("#lf").addEventListener("click", ()=> inFiles.click());
        $("#ld").addEventListener("click", ()=> inFolder.click());
        $("#lz").addEventListener("click", ()=> inZip.click());
        $("#clear").addEventListener("click", async ()=>{
          if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å Local?")) return;
          stopAll();
          await dbClear();
          await loadLocal();
          renderAll();
        });
        return;
      }

      if(page==="playlists"){
        plNormalizeAll();
        const options = pl.items.map(p=> `<div class="card" data-id="${p.id}">
            <div class="t">${p.name}</div>
            <div class="d">–¢—Ä–µ–∫–æ–≤: ${p.refs.length}</div>
            <div class="mini">
              <button class="btn primary" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
              <button class="btn" data-act="play">–ò–≥—Ä–∞—Ç—å</button>
              <button class="btn ghost" data-act="more">?</button>
            </div>
          </div>`).join("");

        left.innerHTML = `
          <h2 class="bigTitle">–ü–ª–µ–π–ª–∏—Å—Ç—ã</h2>
          <p class="subText">—Å–æ–∑–¥–∞—Ç—å ‚Ä¢ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å ‚Ä¢ —É–¥–∞–ª–∏—Ç—å</p>

          <div class="cards">
            <div class="card">
              <div class="t">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
              <div class="d">–±—ã—Å—Ç—Ä–æ</div>
              <div class="mini">
                <button class="btn primary" id="plNew">–ù–æ–≤—ã–π</button>
                <button class="btn" id="plRen">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
                <button class="btn ghost" id="plDel">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </div>
            ${options}
          </div>
        `;

        $("#plNew").addEventListener("click", ()=>{
          const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞");
          if(!name) return;
          const id = "pl_" + crypto.randomUUID();
          pl.items.push({ id, name: name.trim(), refs: [] });
          pl.selected = id;
          plSave();
          renderAll();
        });

        $("#plRen").addEventListener("click", ()=>{
          const p = plGet(pl.selected);
          if(!p || p.id==="pl_all") return tip("–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å", "–≠—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç.");
          const name = prompt("–ù–æ–≤–æ–µ –∏–º—è", p.name);
          if(!name) return;
          p.name = name.trim();
          plSave();
          renderAll();
        });

        $("#plDel").addEventListener("click", ()=>{
          const p = plGet(pl.selected);
          if(!p || p.id==="pl_all") return tip("–£–¥–∞–ª–∏—Ç—å", "–≠—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç.");
          if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç: " + p.name + " ?")) return;
          pl.items = pl.items.filter(x=>x.id!==p.id);
          pl.selected = "pl_all";
          plSave();
          renderAll();
        });

        left.querySelectorAll(".card[data-id]").forEach(card=>{
          const id = card.getAttribute("data-id");
          card.querySelectorAll("button").forEach(btn=>{
            btn.addEventListener("click",(e)=>{
              e.stopPropagation();
              const act = btn.getAttribute("data-act");
              if(act==="open"){
                pl.selected = id;
                plSave();
                renderAll();
              }
              if(act==="play"){
                const p = plGet(id);
                if(p?.refs?.length) playTrack(p.refs[0]);
              }
              if(act==="more"){
                tip("–ü–ª–µ–π–ª–∏—Å—Ç", "–î–æ–±–∞–≤–ª—è–π —Ç—Ä–µ–∫–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ‚Äú–í –ø–ª–µ–π–ª–∏—Å—Ç‚Äù –≤ –ø–ª–µ–µ—Ä–µ –∏–ª–∏ —É —Ç—Ä–µ–∫–∞.\n–ò–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî —ç—Ç–æ –ø–ª–µ–π–ª–∏—Å—Ç pl_fav.");
              }
            });
          });
          card.addEventListener("click", ()=>{
            pl.selected = id;
            plSave();
            renderAll();
          });
        });
        return;
      }

      if(page==="queue"){
        left.innerHTML = `
          <h2 class="bigTitle">–û—á–µ—Ä–µ–¥—å</h2>
          <p class="subText">–ø–µ—Ä–≤—ã–º –∏–≥—Ä–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å. –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî SmartMix/–ø–ª–µ–π–ª–∏—Å—Ç</p>

          <div class="cards">
            <div class="card">
              <div class="t">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—å—é</div>
              <div class="d">–¥–æ–±–∞–≤–ª—è—Ç—å/—á–∏—Å—Ç–∏—Ç—å</div>
              <div class="mini">
                <button class="btn primary" id="qPlay">–ò–≥—Ä–∞—Ç—å —Å –Ω–∞—á–∞–ª–∞</button>
                <button class="btn" id="qClear">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn ghost" id="qTip">?</button>
              </div>
            </div>

            <div class="card">
              <div class="t">SmartMix</div>
              <div class="d">–µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞—è</div>
              <div class="mini">
                <button class="btn" id="qSmart">${SMART.on ? "SmartMix: ON" : "SmartMix: OFF"}</button>
                <button class="btn ghost" id="qFocus">${SMART.focus ? "Focus: ON" : "Focus: OFF"}</button>
              </div>
            </div>
          </div>
        `;

        $("#qPlay").addEventListener("click", ()=>{
          if(queue.length) playTrack(queue[0]);
          else{
            const list = getNavList();
            if(list.length) playTrack(list[0]);
          }
        });
        $("#qClear").addEventListener("click", ()=>{
          if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å?")) return;
          queueClear();
          renderAll();
        });
        $("#qTip").addEventListener("click", ()=> tip("–û—á–µ—Ä–µ–¥—å", "–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫ –≤ –æ—á–µ—Ä–µ–¥—å –º–æ–∂–Ω–æ –∏–∑ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–∫–Ω–æ–ø–∫–∞ ‚Äú–í –æ—á–µ—Ä–µ–¥—å‚Äù)."));

        $("#qSmart").addEventListener("click", ()=>{
          SMART.on = SMART.on ? 0 : 1;
          lsSet(LS.smart, String(SMART.on));
          setButtons();
          renderAll();
        });
        $("#qFocus").addEventListener("click", ()=>{
          SMART.focus = SMART.focus ? 0 : 1;
          lsSet("krs_focus_v1", String(SMART.focus));
          setButtons();
          renderAll();
        });
        return;
      }

      if(page==="settings"){
        const ui = parseFloat(getComputedStyle(root).getPropertyValue("--ui"));
        const glass = parseFloat(getComputedStyle(root).getPropertyValue("--glass"));
        const bg = parseInt(document.body.getAttribute("data-bg"),10) || 3;

        const rainOn = parseInt(getComputedStyle(root).getPropertyValue("--rainOn"),10) || 0;
        const rainCount = parseInt(getComputedStyle(root).getPropertyValue("--rainCount"),10) || 0;
        const rainSize = parseFloat(getComputedStyle(root).getPropertyValue("--rainSize")) || 1.0;
        const rainSpeed = parseFloat(getComputedStyle(root).getPropertyValue("--rainSpeed")) || 1.0;

        const sunOn = parseInt(getComputedStyle(root).getPropertyValue("--sunOn"),10) || 0;
        const sunPower = parseFloat(getComputedStyle(root).getPropertyValue("--sunPower")) || 1.0;

        const motion = parseInt(getComputedStyle(root).getPropertyValue("--motion"),10) || 1;

        left.innerHTML = `
          <h2 class="bigTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
          <p class="subText">–º–∞—Å—à—Ç–∞–± + —Å—Ç–µ–∫–ª–æ + —Ü–≤–µ—Ç + 12 —Ñ–æ–Ω–æ–≤ + —ç—Ñ—Ñ–µ–∫—Ç—ã</p>

          <div class="cards">

            <div class="card">
              <div class="t">–†–∞–∑–º–µ—Ä—ã</div>
              <div class="d">–æ—á–µ–Ω—å —à–∏—Ä–æ–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω</div>
              <div class="mini">
                <span class="pill">UI: <b id="uiVal">${ui.toFixed(2)}</b></span>
              </div>
              <div class="meter">
                <span>UI</span>
                <input id="sUI" type="range" min="1.20" max="3.60" step="0.01" value="${ui}">
              </div>
              <div class="meter">
                <span>–°—Ç–µ–∫–ª–æ</span>
                <input id="sGlass" type="range" min="0.30" max="0.88" step="0.01" value="${glass}">
              </div>
            </div>

            <div class="card">
              <div class="t">–¶–≤–µ—Ç</div>
              <div class="d">–∞–∫—Ü–µ–Ω—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
              <div class="mini">
                <input id="sAccent" type="color" value="${getComputedStyle(root).getPropertyValue("--accent").trim()}" style="width:calc(70px * var(--ui));height:calc(52px * var(--ui));border:none;background:transparent;cursor:pointer;">
                <button class="btn ghost" id="sColorTip">?</button>
              </div>
            </div>

            <div class="card">
              <div class="t">–§–æ–Ω</div>
              <div class="d">12 –ø—Ä–µ—Å–µ—Ç–æ–≤</div>
              <div class="mini">
                <span class="pill">Preset: <b id="bgVal">${bg}</b></span>
              </div>
              <div class="meter">
                <span>Preset</span>
                <input id="sBG" type="range" min="1" max="12" step="1" value="${bg}">
              </div>
            </div>

            <div class="card">
              <div class="t">–†–∞—Å—Å–≤–µ—Ç</div>
              <div class="d">–ø–ª–∞–≤–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞</div>
              <div class="mini">
                <button class="btn" id="sunT">${sunOn ? "–†–∞—Å—Å–≤–µ—Ç: ON" : "–†–∞—Å—Å–≤–µ—Ç: OFF"}</button>
                <button class="btn ghost" id="sunTip">?</button>
              </div>
              <div class="meter">
                <span>–°–∏–ª–∞</span>
                <input id="sSun" type="range" min="0" max="1" step="0.01" value="${sunPower}">
              </div>
            </div>

            <div class="card">
              <div class="t">–î–æ–∂–¥—å</div>
              <div class="d">–∫–∞–ø–ª–∏ –ø—Ä—è–º–æ –Ω–∞ —ç–∫—Ä–∞–Ω</div>
              <div class="mini">
                <button class="btn" id="rainT">${rainOn ? "–î–æ–∂–¥—å: ON" : "–î–æ–∂–¥—å: OFF"}</button>
                <button class="btn ghost" id="rainTip">?</button>
              </div>
              <div class="meter">
                <span>–ö–∞–ø–ª–∏</span>
                <input id="sRain" type="range" min="0" max="260" step="1" value="${rainCount}">
              </div>
              <div class="meter">
                <span>–†–∞–∑–º–µ—Ä</span>
                <input id="sRainSize" type="range" min="0.70" max="1.80" step="0.01" value="${rainSize}">
              </div>
              <div class="meter">
                <span>–°–∫–æ—Ä–æ—Å—Ç—å</span>
                <input id="sRainSpeed" type="range" min="0.60" max="2.00" step="0.01" value="${rainSpeed}">
              </div>
            </div>

            <div class="card">
              <div class="t">–£–º–Ω—ã–µ —Ä–µ–∂–∏–º—ã</div>
              <div class="d">SmartMix + Focus + —Ç–∞–π–º–µ—Ä</div>
              <div class="mini">
                <button class="btn" id="smartT">${SMART.on ? "SmartMix: ON" : "SmartMix: OFF"}</button>
                <button class="btn" id="focusT">${SMART.focus ? "Focus: ON" : "Focus: OFF"}</button>
                <button class="btn ghost" id="smartTip">?</button>
              </div>
              <div class="meter">
                <span>Mood</span>
                <input id="sMood" type="range" min="0" max="100" step="1" value="${SMART.mood}">
              </div>
              <div class="meter">
                <span>Sleep (–º–∏–Ω)</span>
                <input id="sTimer" type="range" min="0" max="120" step="5" value="${SMART.timerMin}">
              </div>
              <div class="meter">
                <span>Motion</span>
                <input id="sMotion" type="range" min="0" max="1" step="1" value="${motion}">
              </div>
            </div>
          </div>
        `;

        $("#sUI").addEventListener("input",(e)=>{
          applyVar("--ui", e.target.value);
          $("#uiVal").textContent = parseFloat(e.target.value).toFixed(2);
          lsSet(LS.ui, e.target.value);
        });

        $("#sGlass").addEventListener("input",(e)=>{
          applyVar("--glass", e.target.value);
          lsSet(LS.glass, e.target.value);
        });

        $("#sAccent").addEventListener("input",(e)=>{
          applyVar("--accent", e.target.value);
          lsSet(LS.accent, e.target.value);
        });

        $("#sColorTip").addEventListener("click", ()=> tip("–¶–≤–µ—Ç", "–ú–µ–Ω—è–µ—Ç –∫–Ω–æ–ø–∫–∏, –∞–∫—Ü–µ–Ω—Ç—ã, –ø–æ–¥—Å–≤–µ—Ç–∫–∏."));

        $("#sBG").addEventListener("input",(e)=>{
          const v = e.target.value;
          document.body.setAttribute("data-bg", v);
          $("#bgVal").textContent = v;
          lsSet(LS.bg, v);
        });

        $("#sunT").addEventListener("click", ()=>{
          const cur = parseInt(getComputedStyle(root).getPropertyValue("--sunOn"))===1;
          const next = cur ? 0 : 1;
          applyVar("--sunOn", next);
          lsSet(LS.sunOn, next);
          renderAll();
        });

        $("#sSun").addEventListener("input",(e)=>{
          applyVar("--sunPower", e.target.value);
          lsSet(LS.sunPower, e.target.value);
        });

        $("#sunTip").addEventListener("click", ()=> tip("–†–∞—Å—Å–≤–µ—Ç", "–ü–ª–∞–≤–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∏ –¥–≤–∏–∂–µ–Ω–∏–µ —Å–ª–æ—è."));

        $("#rainT").addEventListener("click", ()=>{
          const cur = parseInt(getComputedStyle(root).getPropertyValue("--rainOn"))===1;
          const next = cur ? 0 : 1;
          applyVar("--rainOn", next);
          lsSet(LS.rainOn, next);
          rebuildRain();
          renderAll();
        });

        $("#sRain").addEventListener("input",(e)=>{
          applyVar("--rainCount", e.target.value);
          lsSet(LS.rainCount, e.target.value);
          rebuildRain();
        });

        $("#sRainSize").addEventListener("input",(e)=>{
          applyVar("--rainSize", e.target.value);
          lsSet(LS.rainSize, e.target.value);
          rebuildRain();
        });

        $("#sRainSpeed").addEventListener("input",(e)=>{
          applyVar("--rainSpeed", e.target.value);
          lsSet(LS.rainSpeed, e.target.value);
          rebuildRain();
        });

        $("#rainTip").addEventListener("click", ()=> tip("–î–æ–∂–¥—å", "–ö–∞–ø–ª–∏ –ø–∞–¥–∞—é—Ç –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞."));

        $("#smartT").addEventListener("click", ()=>{
          SMART.on = SMART.on ? 0 : 1;
          lsSet(LS.smart, String(SMART.on));
          setButtons();
          renderAll();
        });

        $("#focusT").addEventListener("click", ()=>{
          SMART.focus = SMART.focus ? 0 : 1;
          lsSet("krs_focus_v1", String(SMART.focus));
          setButtons();
          renderAll();
        });

        $("#sMood").addEventListener("input",(e)=>{
          SMART.mood = parseInt(e.target.value,10) || 0;
          lsSet("krs_mood_v1", String(SMART.mood));
          setButtons();
          renderAll();
        });

        $("#sTimer").addEventListener("input",(e)=>{
          const v = parseInt(e.target.value,10) || 0;
          setSleepTimer(v);
          renderAll();
        });

        $("#sMotion").addEventListener("input",(e)=>{
          const v = parseInt(e.target.value,10) || 0;
          applyVar("--motion", v);
          lsSet(LS.motion, String(v));
        });

        $("#smartTip").addEventListener("click", ()=> tip(
          "SmartMix / Focus / –¢–∞–π–º–µ—Ä",
          "SmartMix: —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—ã–¥–∞—á—É (–∏–∑–±—Ä–∞–Ω–Ω–æ–µ –≤—ã—à–µ + –ª—ë–≥–∫–∏–π bias –ø–æ mood).\nFocus: –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é —Ç—Ä–µ–∫–∞ –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π.\nSleep: –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç –º—É–∑—ã–∫—É —á–µ—Ä–µ–∑ N –º–∏–Ω—É—Ç."
        ));

        return;
      }
    }

    function renderCenter(){
      const c = $("#centerSlot");
      const q = ($("#q").value||"").trim().toLowerCase();

      if(page==="home"){
        c.innerHTML = `
          <div class="hero">
            <h1>–ù–æ–≤—ã–π —Ä–µ–ª–∏–∑ –¥–∏–∑–∞–π–Ω–∞</h1>
            <p>–¢—Ä–∏ –ø–∞–Ω–µ–ª–∏ ‚Ä¢ –æ—á–µ—Ä–µ–¥—å ‚Ä¢ SmartMix ‚Ä¢ Focus ‚Ä¢ –¥–æ–∂–¥—å –Ω–∞ —ç–∫—Ä–∞–Ω ‚Ä¢ 12 —Ñ–æ–Ω–æ–≤ ‚Ä¢ –æ–≥—Ä–æ–º–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã</p>
          </div>

          <div class="grid2">
            <div class="panel">
              <h3>–ö–æ—Ä–æ—Ç–∫–æ</h3>
              <div class="note">
                Repo: <b>${repoTracks.length}</b> ‚Ä¢ Local: <b>${localTracks.length}</b> ‚Ä¢ –í –æ—á–µ—Ä–µ–¥–∏: <b>${queue.length}</b><br>
                –ò–∑–±—Ä–∞–Ω–Ω–æ–µ: <b>${favs.size}</b> ‚Ä¢ SmartMix: <b>${SMART.on ? "ON" : "OFF"}</b> ‚Ä¢ Focus: <b>${SMART.focus ? "ON" : "OFF"}</b>
              </div>
            </div>

            <div class="panel">
              <h3>–ë—ã—Å—Ç—Ä—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏</h3>
              <div class="note">
                1‚Äì5 –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç –≤–∫–ª–∞–¥–∫–∏.<br>
                –ü—Ä–æ–±–µ–ª ‚Äî play/pause.<br>
                –í –±–∏–±–ª–∏–æ—Ç–µ–∫–µ: ‚Äú–í –æ—á–µ—Ä–µ–¥—å‚Äù, ‚Äú–í –ø–ª–µ–π–ª–∏—Å—Ç‚Äù, ‚Äú‚ô°‚Äù.
              </div>
            </div>
          </div>

          <div class="panel" style="margin-top:calc(14px * var(--ui));">
            <h3>–ù–µ–¥–∞–≤–Ω–∏–µ Local</h3>
            <div class="list" id="recent"></div>
          </div>
        `;
        renderRecent();
        return;
      }

      if(page==="library"){
        const all = getAllTracks().filter(t=> matchTrack(t,q));
        c.innerHTML = `
          <div class="hero">
            <h1>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
            <p>–û–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫: –Ω–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π</p>
          </div>

          <div class="panel" style="margin-top:calc(14px * var(--ui));">
            <h3>–¢—Ä–µ–∫–∏</h3>
            <div class="list" id="tracks"></div>
          </div>
        `;
        renderTracksList(all);
        return;
      }

      if(page==="playlists"){
        plNormalizeAll();
        const cur = plGet(pl.selected);
        const refs = (cur?.id==="pl_all") ? getAllTracks().map(t=>({kind:t.kind,id:t.id})) : (cur?.refs||[]);
        c.innerHTML = `
          <div class="hero">
            <h1>${cur ? cur.name : "–ü–ª–µ–π–ª–∏—Å—Ç"}</h1>
            <p>${cur ? ("–¢—Ä–µ–∫–æ–≤: "+refs.length) : ""}</p>
          </div>

          <div class="panel" style="margin-top:calc(14px * var(--ui));">
            <h3>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</h3>
            <div class="list" id="plTracks"></div>
          </div>
        `;
        renderPlaylistTracks(cur, refs, q);
        return;
      }

      if(page==="queue"){
        c.innerHTML = `
          <div class="hero">
            <h1>–û—á–µ—Ä–µ–¥—å</h1>
            <p>–ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –Ω–µ –ø—É—Å—Ç–∞—è ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è (‚èÆ/‚è≠) –∏–¥—ë—Ç –ø–æ –Ω–µ–π</p>
          </div>

          <div class="panel" style="margin-top:calc(14px * var(--ui));">
            <h3>–°–ø–∏—Å–æ–∫</h3>
            <div class="list" id="qList"></div>
          </div>
        `;
        renderQueueList(q);
        return;
      }

      if(page==="settings"){
        c.innerHTML = `
          <div class="hero">
            <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
            <p>–≤—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–µ–≤–∞ (–æ–≥—Ä–æ–º–Ω–∞—è). —Ç—É—Ç –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞—Ç—É—Å</p>
          </div>

          <div class="panel" style="margin-top:calc(14px * var(--ui));">
            <h3>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</h3>
            <div class="note">
              Local —Ç—Ä–µ–∫–∏: IndexedDB<br>
              –ù–∞—Å—Ç—Ä–æ–π–∫–∏/–ø–ª–µ–π–ª–∏—Å—Ç—ã/–æ—á–µ—Ä–µ–¥—å/–∏–∑–±—Ä–∞–Ω–Ω–æ–µ: LocalStorage
            </div>
          </div>
        `;
        return;
      }
    }

    function renderRight(){
      const rt = $("#rightTop");
      const rb = $("#rightBottom");
      const q = ($("#q").value||"").trim().toLowerCase();

      // TOP: ‚ÄúNow + actions‚Äù
      const favOn = active ? favs.has(refKey(active)) : false;
      rt.innerHTML = `
        <h2 class="bigTitle" style="margin-bottom:calc(10px * var(--ui));">–°–µ–π—á–∞—Å</h2>
        <div class="note">
          <b>${$("#tName").textContent}</b><br>
          ${$("#tArtist").textContent}
        </div>
        <div class="meter">
          <span>–ì—Ä–æ–º–∫–æ—Å—Ç—å</span>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="${audio.volume || 1}">
        </div>
        <div class="meter">
          <span>–ü–æ–∑–∏—Ü–∏—è</span>
          <input id="pos" type="range" min="0" max="1" step="0.001" value="0">
        </div>
        <div style="margin-top:calc(12px * var(--ui));display:flex;gap:calc(10px * var(--ui));flex-wrap:wrap;">
          <button class="btn primary" id="addQueue">–í –æ—á–µ—Ä–µ–¥—å</button>
          <button class="btn" id="addPl">–í –ø–ª–µ–π–ª–∏—Å—Ç</button>
          <button class="btn ghost" id="favBtn">${favOn ? "‚ô•" : "‚ô°"}</button>
          <button class="btn ghost" id="why">?</button>
        </div>
      `;

      const vol = $("#vol");
      vol.addEventListener("input", ()=> { audio.volume = parseFloat(vol.value); });

      const pos = $("#pos");
      function updPos(){
        if(!audio.duration || !isFinite(audio.duration)) { pos.value = 0; return; }
        pos.value = (audio.currentTime / audio.duration).toFixed(3);
      }
      audio.addEventListener("timeupdate", updPos, { passive:true });
      pos.addEventListener("input", ()=>{
        if(!audio.duration || !isFinite(audio.duration)) return;
        audio.currentTime = parseFloat(pos.value) * audio.duration;
      });

      $("#addQueue").addEventListener("click", ()=>{
        if(!active) return tip("–û—á–µ—Ä–µ–¥—å", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫.");
        queuePush(active);
        renderAll();
      });
      $("#addPl").addEventListener("click", ()=> addToPlaylistFlow(active));
      $("#favBtn").addEventListener("click", ()=>{
        if(!active) return;
        const k = refKey(active);
        if(favs.has(k)) favs.delete(k);
        else favs.add(k);
        favSave();
        renderAll();
      });
      $("#why").addEventListener("click", ()=> tip(
        "–≠—Ç–æ—Ç –±–ª–æ–∫",
        "–¢—É—Ç –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞–¥ –∞–∫—Ç–∏–≤–Ω—ã–º —Ç—Ä–µ–∫–æ–º.\n–ü–æ–∑–∏—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è Local/Repo audio."
      ));

      // BOTTOM: ‚ÄúSmart panel‚Äù
      const all = getAllTracks();
      const found = all.filter(t=> matchTrack(t,q)).length;

      rb.innerHTML = `
        <h2 class="bigTitle" style="margin-bottom:calc(10px * var(--ui));">–°–º–∞—Ä—Ç-–ø–∞–Ω–µ–ª—å</h2>

        <div class="note">
          –ù–∞–π–¥–µ–Ω–æ –ø–æ –ø–æ–∏—Å–∫—É: <b>${found}</b><br>
          Mood: <b>${SMART.mood}</b> ‚Ä¢ –¢–∞–π–º–µ—Ä: <b>${SMART.timerMin} –º–∏–Ω</b><br>
          –û—á–µ—Ä–µ–¥—å: <b>${queue.length}</b> ‚Ä¢ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ: <b>${favs.size}</b>
        </div>

        <div style="margin-top:calc(12px * var(--ui));display:flex;gap:calc(10px * var(--ui));flex-wrap:wrap;">
          <button class="btn" id="toggleSmart">${SMART.on ? "SmartMix: ON" : "SmartMix: OFF"}</button>
          <button class="btn ghost" id="toggleFocus">${SMART.focus ? "Focus: ON" : "Focus: OFF"}</button>
          <button class="btn ghost" id="jumpFav">–ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
          <button class="btn ghost" id="jumpQueue">–ü–æ–∫–∞–∑–∞—Ç—å –æ—á–µ—Ä–µ–¥—å</button>
        </div>

        <div class="note" style="margin-top:calc(12px * var(--ui));">
          Repo —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ <b>assets/audio/manifest.json</b><br>
          Local –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∏–º–ø–æ—Ä—Ç
        </div>
      `;

      $("#toggleSmart").addEventListener("click", ()=>{
        SMART.on = SMART.on ? 0 : 1;
        lsSet(LS.smart, String(SMART.on));
        setButtons();
        renderAll();
      });
      $("#toggleFocus").addEventListener("click", ()=>{
        SMART.focus = SMART.focus ? 0 : 1;
        lsSet("krs_focus_v1", String(SMART.focus));
        setButtons();
        renderAll();
      });
      $("#jumpFav").addEventListener("click", ()=>{
        pl.selected = "pl_fav";
        plSave();
        openPage("playlists");
      });
      $("#jumpQueue").addEventListener("click", ()=> openPage("queue"));
    }

    function renderRecent(){
      const box = document.getElementById("recent");
      if(!box) return;
      box.innerHTML = "";
      const items = localTracks.slice(0, 6);
      if(!items.length){
        box.innerHTML = `<div class="note">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å —Ç—Ä–µ–∫–∏ –≤–æ –≤–∫–ª–∞–¥–∫–µ ‚Äú–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞‚Äù.</div>`;
        return;
      }
      for(const t of items){
        const el = document.createElement("div");
        const isActive = active && active.kind==="local" && active.id===t.id;
        el.className = "item" + (isActive ? " active":"");
        el.innerHTML = `
          <div class="t">${t.artist} ‚Äî ${t.title}</div>
          <div class="d">Local ‚Ä¢ ${fmtBytes(t.size)}</div>
          <div style="margin-top:calc(14px * var(--ui));display:flex;gap:calc(10px * var(--ui));flex-wrap:wrap;">
            <button class="btn primary">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn">–í –æ—á–µ—Ä–µ–¥—å</button>
            <button class="btn">–í –ø–ª–µ–π–ª–∏—Å—Ç</button>
            <button class="btn ghost">${favs.has("local:"+t.id) ? "‚ô•" : "‚ô°"}</button>
            <button class="btn ghost">?</button>
          </div>
        `;
        const btns = el.querySelectorAll("button");
        btns[0].addEventListener("click",(e)=>{ e.stopPropagation(); playTrack({kind:"local", id:t.id}); });
        btns[1].addEventListener("click",(e)=>{ e.stopPropagation(); queuePush({kind:"local", id:t.id}); renderAll(); });
        btns[2].addEventListener("click",(e)=>{ e.stopPropagation(); addToPlaylistFlow({kind:"local", id:t.id}); });
        btns[3].addEventListener("click",(e)=>{
          e.stopPropagation();
          const k="local:"+t.id;
          if(favs.has(k)) favs.delete(k); else favs.add(k);
          favSave(); renderAll();
        });
        btns[4].addEventListener("click",(e)=>{ e.stopPropagation(); tip("–¢—Ä–µ–∫", t.artist+" ‚Äî "+t.title); });

        el.addEventListener("click", ()=> playTrack({kind:"local", id:t.id}));
        box.appendChild(el);
      }
    }

    function renderTracksList(all){
      const box = document.getElementById("tracks");
      if(!box) return;
      box.innerHTML = "";
      if(!all.length){
        box.innerHTML = `<div class="note">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
        return;
      }

      for(const t of all){
        const isActive = active && active.kind===t.kind && active.id===t.id;
        const key = refKey({kind:t.kind, id:t.id});
        const label = (t.kind==="repo")
          ? ("Repo ‚Ä¢ " + t.artist)
          : ("Local ‚Ä¢ " + t.artist + " ‚Ä¢ " + fmtBytes(t.size||0));

        const el = document.createElement("div");
        el.className = "item" + (isActive ? " active":"");
        el.innerHTML = `
          <div class="t">${t.artist} ‚Äî ${t.title}</div>
          <div class="d">${label}</div>
          <div style="margin-top:calc(14px * var(--ui));display:flex;gap:calc(10px * var(--ui));flex-wrap:wrap;">
            <button class="btn primary">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn">–í –æ—á–µ—Ä–µ–¥—å</button>
            <button class="btn">–í –ø–ª–µ–π–ª–∏—Å—Ç</button>
            <button class="btn ghost">${favs.has(key) ? "‚ô•" : "‚ô°"}</button>
            <button class="btn ghost">?</button>
          </div>
        `;
        const btns = el.querySelectorAll("button");
        btns[0].addEventListener("click",(e)=>{ e.stopPropagation(); playTrack({kind:t.kind, id:t.id}); });
        btns[1].addEventListener("click",(e)=>{ e.stopPropagation(); queuePush({kind:t.kind, id:t.id}); renderAll(); });
        btns[2].addEventListener("click",(e)=>{ e.stopPropagation(); addToPlaylistFlow({kind:t.kind, id:t.id}); });
        btns[3].addEventListener("click",(e)=>{
          e.stopPropagation();
          if(favs.has(key)) favs.delete(key); else favs.add(key);
          favSave(); renderAll();
        });
        btns[4].addEventListener("click",(e)=>{ e.stopPropagation(); tip("–¢—Ä–µ–∫", t.artist+" ‚Äî "+t.title); });

        el.addEventListener("click", ()=> playTrack({kind:t.kind, id:t.id}));
        box.appendChild(el);
      }
    }

    function renderPlaylistTracks(cur, refs, q){
      const box = document.getElementById("plTracks");
      if(!box) return;
      box.innerHTML = "";
      const filtered = refs
        .map(r=> ({r, t: byRef(r)}))
        .filter(x=> x.t && matchTrack(x.t, q));

      if(!filtered.length){
        box.innerHTML = `<div class="note">–ü—É—Å—Ç–æ</div>`;
        return;
      }

      for(const x of filtered){
        const t = x.t;
        const ref = x.r;
        const isActive = active && refKey(active)===refKey(ref);
        const label = (ref.kind==="repo")
          ? ("Repo ‚Ä¢ " + t.artist)
          : ("Local ‚Ä¢ " + t.artist + " ‚Ä¢ " + fmtBytes(t.size||0));
        const el = document.createElement("div");
        el.className = "item" + (isActive ? " active":"");
        el.innerHTML = `
          <div class="t">${t.artist} ‚Äî ${t.title}</div>
          <div class="d">${label}</div>
          <div style="margin-top:calc(14px * var(--ui));display:flex;gap:calc(10px * var(--ui));flex-wrap:wrap;">
            <button class="btn primary">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn">–í –æ—á–µ—Ä–µ–¥—å</button>
            <button class="btn ghost">${cur && cur.id!=="pl_all" ? "–£–±—Ä–∞—Ç—å" : "?"}</button>
          </div>
        `;
        const btns = el.querySelectorAll("button");
        btns[0].addEventListener("click",(e)=>{ e.stopPropagation(); playTrack(ref); });
        btns[1].addEventListener("click",(e)=>{ e.stopPropagation(); queuePush(ref); renderAll(); });

        btns[2].addEventListener("click",(e)=>{
          e.stopPropagation();
          if(cur && cur.id!=="pl_all"){
            plRemove(ref, cur.id);
            renderAll();
          }else{
            tip("–ü–ª–µ–π–ª–∏—Å—Ç", "–≠—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å–ø–∏—Å–æ–∫.");
          }
        });

        el.addEventListener("click", ()=> playTrack(ref));
        box.appendChild(el);
      }
    }

    function renderQueueList(q){
      const box = document.getElementById("qList");
      if(!box) return;
      box.innerHTML = "";

      const items = queue
        .map(r=> ({r, t: byRef(r)}))
        .filter(x=> x.t && matchTrack(x.t, q));

      if(!items.length){
        box.innerHTML = `<div class="note">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞—è</div>`;
        return;
      }

      for(const x of items){
        const t = x.t;
        const ref = x.r;
        const isActive = active && refKey(active)===refKey(ref);

        const el = document.createElement("div");
        el.className = "item" + (isActive ? " active":"");
        el.innerHTML = `
          <div class="t">${t.artist} ‚Äî ${t.title}</div>
          <div class="d">${ref.kind==="repo" ? "Repo" : "Local"}</div>
          <div style="margin-top:calc(14px * var(--ui));display:flex;gap:calc(10px * var(--ui));flex-wrap:wrap;">
            <button class="btn primary">–ò–≥—Ä–∞—Ç—å</button>
            <button class="btn ghost">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        const btns = el.querySelectorAll("button");
        btns[0].addEventListener("click",(e)=>{ e.stopPropagation(); playTrack(ref); });
        btns[1].addEventListener("click",(e)=>{ e.stopPropagation(); queueRemove(ref); renderAll(); });
        el.addEventListener("click", ()=> playTrack(ref));
        box.appendChild(el);
      }
    }

    function renderPlayerBadges(){
      const k = active ? refKey(active) : null;
      const favOn = k ? favs.has(k) : false;
      $("#bFav").textContent = favOn ? "‚ô•" : "‚ô°";
      setButtons();
    }

    function renderAll(){
      renderLeft();
      renderCenter();
      renderRight();
      renderPlayerBadges();
    }

    $("#q").addEventListener("input", ()=> renderAll());

    /* =========================
       SETTINGS INIT + BUTTONS
    ========================== */
    setButtons();

    /* =========================
       INIT
    ========================== */
    (async ()=>{
      $("#ver").textContent = "REL-2026-NEO";
      setSrc(SOURCE.NONE);

      await loadRepo();
      await loadLocal();
      plNormalizeAll();
      plSave();

      rebuildRain();
      setSleepTimer(SMART.timerMin);

      openPage("home");
      renderAll();
    })();
  </script>
</body>
</html>
